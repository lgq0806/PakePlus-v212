<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英语单词带读工具（终极版）</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa, #e4efe9);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .qq-contact {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10000; /* 设置更高的z-index确保在最上层 */
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .qq-contact.semi-transparent {
            background: rgba(255, 255, 255, 0.5);
            color: rgba(44, 62, 80, 0.7);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .qq-contact:hover {
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .qq-contact i {
            color: #4a90e2;
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 30px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: linear-gradient(90deg, #4a90e2, #5cb85c);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: inline-block;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
        }
        
        .tabs-container {
            width: 100%;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            white-space: nowrap;
            min-width: 140px;
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .tab-btn:hover::before {
            left: 100%;
        }
        
        .tab-btn:hover {
            background: rgba(74, 144, 226, 0.1);
            color: #4a90e2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #4a90e2, #3a7bc8);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3), 
                        inset 0 1px 0 rgba(255,255,255,0.3),
                        0 2px 5px rgba(0,0,0,0.1);
            transform: translateY(0);
        }
        
        .tab-btn.active:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(74, 144, 226, 0.4), 
                        inset 0 1px 0 rgba(255,255,255,0.3),
                        0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 自定义弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
            max-width: 90%;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .modal-overlay.active .modal-container {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .modal-icon.info {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .modal-icon.confirm {
            background-color: #fff3e0;
            color: #ff9800;
        }
        
        .modal-icon.success {
            background-color: #e8f5e9;
            color: #4caf50;
        }
        
        .modal-icon.error {
            background-color: #ffebee;
            color: #f44336;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9e9e9e;
            padding: 5px;
            transition: color 0.3s ease;
        }
        
        .modal-close:hover {
            color: #212121;
        }
        
        .modal-body {
            margin-bottom: 25px;
            font-size: 1.1rem;
            line-height: 1.6;
            color: #424242;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 80px;
        }
        
        .modal-btn.primary {
            background: linear-gradient(135deg, #4a90e2, #3a7bc8);
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: linear-gradient(135deg, #3a7bc8, #2e6cb8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }
        
        .modal-btn.secondary {
            background: #f5f5f5;
            color: #757575;
        }
        
        .modal-btn.secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .modal-btn.danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }
        
        .modal-btn.danger:hover {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        
        /* 响应式设计 */
        @media (max-width: 600px) {
            .modal-container {
                padding: 20px;
                margin: 10px;
            }
            
            .modal-header {
                margin-bottom: 15px;
            }
            
            .modal-title {
                font-size: 1.3rem;
            }
            
            .modal-body {
                font-size: 1rem;
                margin-bottom: 20px;
            }
            
            .modal-footer {
                flex-direction: column-reverse;
            }
            
            .modal-btn {
                width: 100%;
            }
        }
        
        .preview-section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }
        
        .preview-pane {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 120px;
            overflow-y: auto;
            padding: 15px;
            background: #f1f3f6;
            border-radius: 12px;
            margin-top: 10px;
            scrollbar-width: thin;
            scrollbar-color: #4a90e2 #f1f3f6;
        }
        
        .preview-pane::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .preview-pane::-webkit-scrollbar-track {
            background: #f1f3f6;
            border-radius: 10px;
        }
        
        .preview-pane::-webkit-scrollbar-thumb {
            background: #4a90e2;
            border-radius: 10px;
        }
        
        .word-chip {
            padding: 8px 16px;
            background: #e8f4f8;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid transparent;
            position: relative;
        }
        
        .word-chip.favorite::after {
            content: "★";
            color: #5cb85c;
            font-size: 0.8rem;
        }
        
        .word-chip.group-indicator {
            font-size: 0.7rem;
            padding: 2px 6px;
            margin-left: 5px;
            border-radius: 4px;
            background-color: rgba(74, 144, 226, 0.2);
            color: #3a7bc8;
        }
        
        .word-chip:hover {
            background: #d0eef7;
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
        }
        
        .word-chip.active {
            background: #4a90e2;
            color: white;
            box-shadow: 0 3px 6px rgba(74, 144, 226, 0.2);
        }
        
        .delete-word-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #d9534f;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .word-chip:hover .delete-word-btn {
            display: flex;
        }
        
        .delete-word-btn:hover {
            background: #c9302c;
            transform: scale(1.1);
        }
        
        .display-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70vh;
            padding: 40px 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9f1f7);
            color: #2c3e50;
            border-radius: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        
        .display-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.02);
            z-index: 0;
        }
        
        .display-area::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%234a90e2' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            z-index: 0;
        }
        
        .word-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1;
            z-index: 1;
        }
        
        .word {
            font-size: 7rem;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.05);
            line-height: 1.1;
            transform: translateY(0);
            transition: transform 0.3s ease-out;
            display: inline-block;
            padding: 10px 20px;
            border-radius: 10px;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .display-area:hover .word {
            transform: translateY(-5px);
        }
        
        .phonetic {
            font-size: 3.5rem;
            color: #555;
            margin-bottom: 15px;
            font-weight: 500;
            font-style: italic;
            display: inline-block;
            padding: 5px 15px;
            border-radius: 8px;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chinese {
            font-size: 2.5rem;
            color: #5cb85c;
            max-width: 90%;
            margin-top: 15px;
            font-weight: 600;
            line-height: 1.4;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.03);
            padding: 10px 15px;
            border-radius: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .word-image {
            width: 35%;
            height: 70%;
            object-fit: cover;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1;
            transition: all 0.3s ease;
        }
        
        .word-image:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        
        .progress-bar {
            width: 80%;
            height: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 20px;
            z-index: 1;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05) inset;
        }
        
        .progress {
            height: 100%;
            background: #4a90e2;
            width: 0%;
            transition: width 0.3s;
        }
        
        .playback-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin-top: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.02);
        }
        
        .control-group h3 {
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f1f1f1;
        }
        
        label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4a90e2;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.3);
        }
        
        input[type="number"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            transition: border 0.3s;
        }
        
        input[type="number"]:focus {
            border-color: #4a90e2;
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        input[type="text"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            transition: border 0.3s;
        }
        
        input[type="text"]:focus {
            border-color: #4a90e2;
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        input[type="color"] {
            width: 100%;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            padding: 3px;
        }
        
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }
        
        /* 全屏特效样式 */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .fullscreen-overlay.active {
            opacity: 1;
        }
        
        /* 烟花特效 */
        .fireworks-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        /* 烟花粒子样式 */
        .firework-particle {
            position: absolute;
            border-radius: 50%;
            will-change: transform, opacity;
            pointer-events: none;
        }
        
        /* 烟花爆炸动画 */
        @keyframes firework-explode {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--end-x), var(--end-y));
                opacity: 0;
            }
        }
        
        /* 星空背景闪烁效果 */
        .firework-star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            opacity: 0.7;
            animation: twinkle 2s infinite alternate;
        }
        
        @keyframes twinkle {
            0% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1.2);
            }
        }
        
        /* 全屏闪红特效 */
        .red-flash-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.8);
        }
        
        @keyframes red-flash {
            0%, 100% {
                opacity: 0.8;
            }
            50% {
                opacity: 0.4;
            }
        }
        
        .red-flash-container.active {
            animation: red-flash 0.2s ease-in-out infinite;
        }

        .value-display {
            background: #2c3e50;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            min-width: 80px;
        }
        
        .btn-large {
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .btn-play {
            background: #5cb85c;
        }
        
        .btn-play:hover {
            background: #4aa44a;
            box-shadow: 0 4px 15px rgba(92, 184, 92, 0.2);
        }
        
        .btn-pause {
            background: #f0ad4e;
        }
        
        .btn-pause:hover {
            background: #e09638;
            box-shadow: 0 4px 15px rgba(240, 173, 78, 0.2);
        }
        
        .btn-next-prev {
            background: #4a90e2;
        }
        
        .btn-next-prev:hover {
            background: #3a7bc8;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.2);
        }
        
        .api-config {
            margin-top: 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #4a90e2;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background: #e8f4fc;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #5cb85c;
        }
        
        .status-indicator.error {
            background: #d9534f;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        .api-config h4 {
            color: #3a7bc8;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        
        .api-config input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 5px 0;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .api-config input:focus {
            border-color: #4a90e2;
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        .api-config .input-group {
            margin-bottom: 15px;
        }
        
        .api-config label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .api-config p {
            color: #7f8c8d;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-top: 10px;
        }
        
        .api-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn-test {
            background: #9b59b6;
        }
        
        .btn-test:hover {
            background: #8e44ad;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.2);
        }
        
        .btn-save {
            background: #5cb85c;
        }
        
        .btn-save:hover {
            background: #4aa44a;
            box-shadow: 0 4px 15px rgba(92, 184, 92, 0.2);
        }
        
        .btn-clear {
            background: #f0ad4e;
        }
        
        .btn-clear:hover {
            background: #e09638;
            box-shadow: 0 4px 15px rgba(240, 173, 78, 0.2);
        }
        
        .message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.success {
            background: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
            display: block;
        }
        
        .message.error {
            background: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
            display: block;
        }
        
        .guide {
            margin-top: 15px;
            padding: 15px;
            background: #e8f4fc;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
        }
        
        .guide h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .guide ol {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .guide li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .guide a {
            color: #4a90e2;
            text-decoration: none;
        }
        
        .guide a:hover {
            text-decoration: underline;
        }
        
        .import-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        
        .manual-add-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin-top: 15px;
        }
        
        .manual-add-section h2 {
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .word-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .word-input {
            flex: 1;
            min-width: 250px;
        }
        
        .file-input {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .file-input label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: #4a90e2;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .file-input label:hover {
            background: #3a7bc8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        
        button {
            padding: 12px 20px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .debug-info {
            margin-top: 15px;
            padding: 15px;
            background: #f1f3f6;
            border-radius: 8px;
            border-left: 4px solid #95a5a6;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .debug-log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .group-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        
        .group-management {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .group-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .group-item {
            padding: 8px 16px;
            background: #e8f4f8;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .group-item.active {
            background: #4a90e2;
            color: white;
        }
        
        .group-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
        }
        
        .group-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .current-word-group {
            margin-top: 15px;
            padding: 10px;
            background: #f1f3f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .group-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        
        .delete-group {
            color: #d9534f;
            margin-left: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .delete-group:hover {
            color: #c9302c;
        }
        
        .favorite-badge {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #5cb85c;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .favorite-badge:hover {
            transform: scale(1.1);
            background: #4aa44a;
        }
        
        .favorite-badge.active {
            background: #5cb85c;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(92, 184, 92, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(92, 184, 92, 0); }
            100% { box-shadow: 0 0 0 0 rgba(92, 184, 92, 0); }
        }
        
        .favorite-badge i {
            font-size: 1.2rem;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .filter-btn.active {
            background: #3a7bc8;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        
        .export-btn {
            background: #5cb85c;
        }
        
        .export-btn:hover {
            background: #4aa44a;
        }
        
        .clear-btn {
            background: #f0ad4e;
        }
        
        .clear-btn:hover {
            background: #e09638;
        }
        
        .api-guide {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
        }
        
        .api-guide h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .api-guide ol {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .api-guide li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .api-guide a {
            color: #4a90e2;
            text-decoration: none;
        }
        
        .api-guide a:hover {
            text-decoration: underline;
        }
        
        .import-group-select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 200px;
        }
        
        .preview-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .preview-filter select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            min-width: 150px;
        }
        
        .pixabay-guide {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #5cb85c;
        }
        
        .pixabay-guide h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pixabay-guide ol {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .pixabay-guide li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .pixabay-guide a {
            color: #4a90e2;
            text-decoration: none;
        }
        
        .pixabay-guide a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 1024px) {
            .word {
                font-size: 5rem;
            }
            
            .phonetic {
                font-size: 2.5rem;
            }
            
            .chinese {
                font-size: 1.8rem;
            }
            
            .word-image {
                width: 30%;
                height: 60%;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .word {
                font-size: 3.5rem;
            }
            
            .phonetic {
                font-size: 2rem;
            }
            
            .chinese {
                font-size: 1.5rem;
            }
            
            .word-image {
                width: 25%;
                height: 50%;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .playback-controls {
                flex-wrap: wrap;
            }
            
            .api-actions {
                flex-direction: column;
            }
            
            .btn-large {
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .tab-btn {
                min-width: 120px;
                padding: 12px 15px;
                font-size: 1rem;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .display-area {
                padding: 30px 15px;
                height: 60vh;
            }
            
            .qq-contact {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 15px;
                align-self: flex-end;
            }
            
            .file-input {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .import-group-select {
                min-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .word {
                font-size: 2.5rem;
            }
            
            .phonetic {
                font-size: 1.5rem;
            }
            
            .chinese {
                font-size: 1.2rem;
            }
            
            .word-image {
                width: 20%;
                height: 40%;
            }
            
            .display-area {
                padding: 20px 10px;
                height: 50vh;
            }
        }

        .quiz-section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }

        .student-management {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .student-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: #f1f3f6;
            border-radius: 8px;
        }

        .student-item {
            padding: 8px 16px;
            background: #e8f4f8;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .student-item.selected {
            background: #4a90e2;
            color: white;
        }

        .student-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
        }

        .quiz-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            margin-top: 100px; /* 大幅增加顶部边距，确保完全不被遮挡 */
            overflow-x: auto;
        }

        .quiz-tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            white-space: nowrap;
            min-width: 160px;
        }

        .quiz-tab-btn.active {
            background: linear-gradient(135deg, #4a90e2, #3a7bc8);
            color: white;
        }

        .quiz-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .quiz-content.active {
            display: block;
        }

        .quiz-display {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 60vh;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa, #e9f1f7);
            color: #2c3e50;
            border-radius: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .quiz-images {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .quiz-image {
            width: 200px;
            height: 150px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .quiz-phonetic {
            font-size: 2.5rem;
            color: #555;
            margin-bottom: 20px;
            font-weight: 500;
            font-style: italic;
        }

        .letter-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .letter-option {
            padding: 12px 20px;
            background: #e8f4f8;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s;
        }

        .letter-option:hover {
            background: #d0eef7;
            transform: translateY(-2px);
        }

        .letter-option.selected {
            background: #4a90e2;
            color: white;
        }

        .answer-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }

        .answer-option {
            padding: 10px;
            background: #e8f4f8;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 120px; /* 增加卡片高度 */
            overflow: hidden; /* 隐藏溢出内容 */
        }
        
        /* 听力测试选项内容样式 */
        .option-word {
            font-size: clamp(0.8rem, 3vw, 1.4rem); /* 降低最大字体大小 */
            margin-bottom: 3px;
            word-break: break-all; /* 允许长单词换行 */
            line-height: 1.2;
        }
        
        .option-phonetic {
            font-size: clamp(0.7rem, 2.5vw, 1rem); /* 降低最大字体大小 */
            color: #666;
            margin-bottom: 3px;
            word-break: break-all;
            line-height: 1.2;
        }
        
        .option-chinese {
            font-size: clamp(0.8rem, 3vw, 1.2rem); /* 降低最大字体大小 */
            word-break: break-all;
            line-height: 1.2;
        }

        .answer-option:hover {
            background: #d0eef7;
            transform: translateY(-2px);
        }

        .answer-option.selected {
            background: #4a90e2;
            color: white;
        }

        .quiz-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .score-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            padding: 10px 20px;
            background: #e8f4f8;
            border-radius: 8px;
        }

        .title-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #5cb85c;
            padding: 10px 20px;
            background: #e8f4f8;
            border-radius: 8px;
            margin-top: 10px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            border-radius: 50%;
            animation: confetti-fall 5s linear forwards;
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .stats-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .title-settings {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin-bottom: 20px;
            position: relative;
        }

        .title-settings .toggle-title {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .title-settings.collapsed .title-list,
        .title-settings.collapsed .word-input-group {
            display: none;
        }

        .title-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .title-item {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 8px;
        }

        .title-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .title-item span {
            font-weight: bold;
            min-width: 60px;
        }

        .title-item .delete-title {
            color: #d9534f;
            cursor: pointer;
        }

        .title-item .delete-title:hover {
            color: #c9302c;
        }

        .phonics-answer-area {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
            min-height: 60px;
            padding: 15px;
            background: #f1f3f6;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
        }

        .phonics-answer-slot {
            padding: 12px 20px;
            background: #e8f4f8;
            border: 2px dashed #4a90e2;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
            transition: all 0.3s;
        }

        .phonics-answer-slot.filled {
            background: #4a90e2;
            color: white;
            border: 2px solid #4a90e2;
        }
        
        .phonics-layout {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        
        .phonics-image-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .phonics-center-content {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .phonics-spelling-area {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f1f3f6;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
        }
        
        .spelling-slot {
            padding: 12px 20px;
            background: #e8f4f8;
            border: 2px dashed #4a90e2;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .spelling-slot.filled {
            background: #4a90e2;
            color: white;
            border: 2px solid #4a90e2;
        }
        
        .phonics-letter-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
            max-width: 600px;
        }
        
        .letter-combination-option {
            padding: 12px 20px;
            background: #e8f4f8;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .letter-combination-option:hover {
            background: #d0eef7;
            transform: translateY(-2px);
        }
        
        .letter-combination-option.used {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .quiz-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 10;
            animation: popIn 0.5s ease-out;
        }
        
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes slideDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(50px);
            }
        }
        
        .correct-feedback {
            color: #5cb85c;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .word-display {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .phonetic-display {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .chinese-display {
            font-size: 1.2rem;
            color: #5cb85c;
            margin-bottom: 20px;
        }
        
        .next-button {
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .next-button:hover {
            background: #3a7bc8;
            transform: translateY(-2px);
        }

        .error-feedback {
            color: #d9534f;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .phonics-hint {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
            font-size: 1rem;
            color: #555;
        }
        
        .phonics-hint i {
            color: #4a90e2;
            margin-right: 8px;
        }
        
        .phonics-rule {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            z-index: 5;
        }
        
        .phonics-rule h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .phonics-rule ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .phonics-rule li {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .toggle-rule {
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* 新增自然拼读规则样式 */
        .phonics-rules-expanded {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        
        .phonics-rules-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .phonics-category {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        
        .phonics-category h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .phonics-patterns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .phonics-pattern {
            padding: 6px 12px;
            background: #e8f4f8;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #2c3e50;
            border: 1px solid #d0eef7;
        }
        
        .phonics-pattern.example {
            background: #e8f4fc;
            border-color: #c5e1f5;
        }
        
        .phonics-examples {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        /* 新增样式用于显示自然拼读规则详情 */
        .phonics-rule-detail {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #f1f3f6;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .phonics-rule-detail.active {
            display: block;
        }
        
        .phonics-category-toggle {
            background: none;
            border: none;
            cursor: pointer;
            color: #4a90e2;
            font-size: 0.9rem;
            margin-left: auto;
        }
        
        /* 听力测试显示选项 */
        .listening-options {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .listening-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .listening-option input {
            margin: 0;
        }
        
        /* 学生列表中的分数和称号显示 */
        .student-score {
            font-size: 0.8rem;
            background: #5cb85c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .student-title {
            font-size: 0.8rem;
            background: #f0ad4e;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        /* 学生信息大屏显示样式 */
        .student-display {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #4a90e2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0);
        }
        
        .student-display.active {
            opacity: 1;
        }
        
        .student-name {
            font-size: 8rem;
            font-weight: bold;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.3);
        }
        
        .student-score-display, .student-title-display {
            font-size: 4rem;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 5px rgba(0,0,0,0.3);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .phonics-rules-categories {
                grid-template-columns: 1fr;
            }
            
            .student-name {
                font-size: 4rem;
            }
            
            .student-score-display, .student-title-display {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 480px) {
            .student-name {
                font-size: 3rem;
            }
            
            .student-score-display, .student-title-display {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- 自定义弹窗结构 -->
    <div class="modal-overlay" id="customModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <div class="modal-icon" id="modalIcon"></div>
                    <span id="modalTitleText"></span>
                </div>
                <button class="modal-close" id="modalCloseBtn">&times;</button>
            </div>
            <div class="modal-body" id="modalBodyText"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- 右上角QQ联系方式 -->
    <div class="qq-contact" onclick="window.open('tencent://message/?uin=410924011&Site=qq&Menu=yes')">
        <i class="fab fa-qq"></i>
        <span>联系作者QQ：410924011</span>
    </div>
    
    <header>
        <h1>英语单词带读工具（终极版）</h1>
        <p class="subtitle">支持单词收藏、分组、带读、图片显示和趣味测试的智能学习助手</p>
    </header>
    
    <div class="container">
        <!-- 标签页导航 -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-btn active" data-tab="api-config">
                    <i class="fas fa-key"></i> API配置
                </button>
                <button class="tab-btn" data-tab="group-management">
                    <i class="fas fa-tags"></i> 分组管理
                </button>
                <button class="tab-btn" data-tab="word-import">
                    <i class="fas fa-file-import"></i> 单词导入
                </button>
                <button class="tab-btn" data-tab="playback">
                    <i class="fas fa-play-circle"></i> 播放控制
                </button>
                <!-- 新增趣味测试标签页 -->
                <button class="tab-btn" data-tab="quiz">
                    <i class="fas fa-gamepad"></i> 趣味测试
                </button>
                <button class="tab-btn" data-tab="settings">
                    <i class="fas fa-cog"></i> 设置
                </button>
            </div>
            
            <!-- API配置标签页 -->
            <div id="api-config" class="tab-content active">
                <section class="api-config">
                    <h4 style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="display: flex; align-items: center; gap: 8px; cursor: pointer;" onclick="toggleApiConfig()">
                            <i class="fas fa-chevron-down" id="apiToggleIcon"></i>
                            <i class="fas fa-key"></i> 百度翻译API配置
                        </span>
                        <span style="color: red; font-size: 0.9rem; animation: blink 1s infinite;" title="系统已默认调用免费API，无需手动配置">
                            已经默认调用免费的API，不会配置不用点击此项！
                        </span>
                    </h4>
                    <div id="apiConfigContent" style="display: none;">
                        <p>请输入您的百度翻译API配置信息，用于获取单词释义：</p>
                        
                        <div class="input-group">
                            <label for="appId">百度翻译APP ID</label>
                            <input type="text" id="appId" placeholder="请输入APP ID">
                        </div>
                        
                        <div class="input-group">
                            <label for="appKey">百度翻译密钥</label>
                            <input type="password" id="appKey" placeholder="请输入密钥">
                        </div>
                        
                        <div class="api-actions">
                            <button id="testApiBtn" class="btn-test">
                                <i class="fas fa-vial"></i> 测试API连接
                            </button>
                            <button id="saveApiBtn" class="btn-save">
                                <i class="fas fa-save"></i> 保存配置
                            </button>
                            <button id="clearApiBtn" class="btn-clear">
                                <i class="fas fa-trash"></i> 清除配置
                            </button>
                        </div>
                        
                        <div class="api-status">
                            <div class="status-indicator" id="apiStatusIndicator"></div>
                            <span id="apiStatusText">词典API: 就绪 (主服务 + 备用服务)</span>
                        </div>
                        
                        <div id="apiMessage" class="message"></div>
                        <button class="btn-info" onclick="document.querySelector('.api-guide').style.display='block'">
                            <i class="fas fa-info-circle"></i> 显示百度翻译API配置说明
                        </button>
                    </div>
                    <script>
                        function toggleApiConfig() {
                            const content = document.getElementById('apiConfigContent');
                            const icon = document.getElementById('apiToggleIcon');
                            if (content.style.display === 'none') {
                                content.style.display = 'block';
                                icon.className = 'fas fa-chevron-up';
                            } else {
                                content.style.display = 'none';
                                icon.className = 'fas fa-chevron-down';
                            }
                        }
                        // 添加闪烁动画
                        if (!document.getElementById('blinkAnimationStyle')) {
                            const style = document.createElement('style');
                            style.id = 'blinkAnimationStyle';
                            style.textContent = `
                                @keyframes blink {
                                    0%, 50% { opacity: 1; }
                                    51%, 100% { opacity: 0.3; }
                                }
                            `;
                            document.head.appendChild(style);
                        }
                    </script>
                </section>
                
                <!-- 百度API配置说明 -->
                <section class="api-guide" style="display: none;">
                    <h4><i class="fas fa-info-circle"></i> 百度翻译API配置说明 <button class="toggle-guide" onclick="this.parentElement.parentElement.style.display='none'">隐藏</button></h4>
                    <p>要使用百度翻译API，您需要先申请百度翻译服务的API密钥：</p>
                    <ol>
                        <li>访问 <a href="https://api.fanyi.baidu.com" target="_blank">百度翻译开放平台</a></li>
                        <li>注册/登录百度账号</li>
                        <li>进入"管理控制台" -> "开发者信息" -> "申请成为开发者"</li>
                        <li>创建新应用，选择"通用翻译API"服务</li>
                        <li>获取App ID和密钥，填写到上方表单中</li>
                    </ol>
                    <p><strong>注意：</strong>百度翻译API有免费额度（每月200万字符），超出后需要付费。</p>
                    <p>如果不想使用百度翻译API，系统会自动使用备用翻译服务，但翻译质量可能不如百度翻译。</p>
                </section>
                
                <!-- Pixabay API配置 -->
                <section class="api-config">
                    <h4><i class="fas fa-image"></i> Pixabay图片API配置</h4>
                    <p>请输入您的Pixabay API密钥，用于获取单词相关图片：</p>
                    
                    <div class="input-group">
                        <label for="pixabayApiKey">Pixabay API密钥</label>
                        <input type="password" id="pixabayApiKey" placeholder="请输入Pixabay API密钥">
                    </div>
                    
                    <div class="api-actions">
                        <button id="testPixabayApiBtn" class="btn-test">
                            <i class="fas fa-vial"></i> 测试Pixabay API
                        </button>
                        <button id="savePixabayApiBtn" class="btn-save">
                            <i class="fas fa-save"></i> 保存配置
                        </button>
                        <button id="clearPixabayApiBtn" class="btn-clear">
                            <i class="fas fa-trash"></i> 清除配置
                        </button>
                    </div>
                    
                    <div class="api-status">
                        <div class="status-indicator" id="pixabayApiStatusIndicator"></div>
                        <span id="pixabayApiStatusText">图片API: 未配置</span>
                    </div>
                    
                    <div id="pixabayApiMessage" class="message"></div>
                    <button class="btn-info" onclick="document.querySelector('.pixabay-guide').style.display='block'">
                        <i class="fas fa-info-circle"></i> 显示Pixabay API配置说明
                    </button>
                </section>
                
                <!-- Pixabay API配置说明 -->
                <section class="pixabay-guide" style="display: none;">
                    <h4><i class="fas fa-info-circle"></i> Pixabay API配置说明 <button class="toggle-guide" onclick="this.parentElement.parentElement.style.display='none'">隐藏</button></h4>
                    <p>要使用Pixabay API获取单词图片，您需要先申请Pixabay API密钥：</p>
                    <ol>
                        <li>访问 <a href="https://pixabay.com/api/docs/" target="_blank">Pixabay API文档</a></li>
                        <li>注册/登录Pixabay账号</li>
                        <li>进入您的账户设置页面</li>
                        <li>找到API密钥部分，申请新的API密钥</li>
                        <li>将API密钥填写到上方表单中</li>
                    </ol>
                    <p><strong>注意：</strong>Pixabay API有使用限制，每天最多可以发出5000个请求。</p>
                    <p>为了提高图片搜索的精准性，系统会使用多种搜索策略，包括：</p>
                    <ul>
                        <li>使用单词本身作为关键词</li>
                        <li>尝试添加"object"、"item"等限定词</li>
                        <li>使用单词的复数形式</li>
                        <li>使用单词的同义词</li>
                    </ul>
                </section>
            </div>
            
            <!-- 分组管理标签页 -->
            <div id="group-management" class="tab-content">
                <section class="group-section">
                    <h2><i class="fas fa-tags"></i> 单词分组管理</h2>
                    
                    <div class="group-management">
                        <input type="text" id="newGroupName" placeholder="输入新分组名称">
                        <input type="color" id="newGroupColor" value="#4a90e2">
                        <button id="createGroupBtn">
                            <i class="fas fa-plus"></i> 创建分组
                        </button>
                        <button id="editGroupsBtn">
                            <i class="fas fa-edit"></i> 编辑分组
                        </button>
                    </div>
                    
                    <div class="filter-controls">
                        <button id="allGroupsBtn" class="filter-btn active">
                            <i class="fas fa-layer-group"></i> 所有分组
                        </button>
                        <span>筛选：</span>
                        <div class="group-list" id="groupList">
                            <!-- 分组列表将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="current-word-group" id="currentWordGroup">
                        <span><i class="fas fa-tag"></i> 当前单词分组：</span>
                        <select id="wordGroupSelect">
                            <option value="">-- 未分组 --</option>
                            <!-- 分组选项将通过JS动态生成 -->
                        </select>
                        <button id="assignGroupBtn">
                            <i class="fas fa-check"></i> 分配分组
                        </button>
                    </div>
                </section>
            </div>
            
            <!-- 单词导入标签页 -->
            <div id="word-import" class="tab-content">
                <section class="import-section">
                    <h2><i class="fas fa-file-import"></i> 导入单词列表</h2>
                    
                    <div class="file-input">
                        <label for="fileInput">
                            <i class="fas fa-file"></i> 选择TXT文件
                            <input type="file" id="fileInput" accept=".txt" style="display: none;">
                        </label>
                        <label for="excelInput" style="background: #5cb85c;">
                            <i class="fas fa-file-excel"></i> 选择Excel文件
                            <input type="file" id="excelInput" accept=".xlsx,.xls" style="display: none;">
                        </label>
                        <button id="downloadTemplateBtn" style="background: #f39c12;">
                            <i class="fas fa-download"></i> 下载Excel模板
                        </button>
                        <select id="importGroupSelect" class="import-group-select">
                            <option value="">-- 选择分组（可选）--</option>
                            <!-- 分组选项将通过JS动态生成 -->
                        </select>
                        <button id="importBtn">
                            <i class="fas fa-upload"></i> 导入单词
                        </button>
                        <select id="clearGroupSelect" class="import-group-select">
                            <option value="">-- 选择分组清除 --</option>
                            <option value="all">-- 清除所有单词 --</option>
                            <!-- 分组选项将通过JS动态生成 -->
                        </select>
                        <button id="clearWordsBtn" class="clear-btn">
                            <i class="fas fa-trash"></i> 执行清除
                        </button>
                    </div>
                    
                    <!-- 手动添加单词部分 -->
                    <section class="manual-add-section">
                        <h2><i class="fas fa-plus-circle"></i> 手动添加单词</h2>
                        
                        <div class="word-input-group">
                            <input type="text" id="manualWordInput" class="word-input" placeholder="请输入单词">
                            <select id="manualWordGroup">
                                <option value="">-- 选择分组（可选）--</option>
                                <!-- 分组选项将通过JS动态生成 -->
                            </select>
                            <button id="addWordBtn">
                                <i class="fas fa-plus"></i> 添加单词
                            </button>
                        </div>
                        
                        <p style="color: #7f8c8d; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i> 输入单词后，系统会自动获取音标、中文释义和图片
                        </p>
                    </section>
                    
                    <div class="filter-controls">
                        <button id="allWordsBtn" class="filter-btn active">
                            <i class="fas fa-list"></i> 所有单词
                        </button>
                        <button id="favoriteWordsBtn" class="filter-btn">
                            <i class="fas fa-star"></i> 仅收藏单词
                        </button>
                        <button id="exportWordsBtn" class="filter-btn export-btn">
                            <i class="fas fa-download"></i> 导出单词列表
                        </button>
                    </div>
                    
                    <!-- 单词预览 -->
                    <div class="preview-section">
                        <h3><i class="fas fa-list"></i> 单词预览 (悬停单词可删除)</h3>
                        
                        <div class="preview-filter">
                            <span>按分组筛选：</span>
                            <select id="previewGroupFilter">
                                <option value="">-- 所有分组 --</option>
                                <!-- 分组选项将通过JS动态生成 -->
                            </select>
                            <button id="syncToPlaybackBtn" class="filter-btn">
                                <i class="fas fa-sync"></i> 同步到播放列表
                            </button>
                        </div>
                        
                        <div class="preview-pane" id="previewPane">
                            <!-- 单词预览内容将通过JS动态生成 -->
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- 播放控制标签页 -->
            <div id="playback" class="tab-content">
                <!-- 单词预览 - 同步到播放控制标签页 -->
                <div class="preview-section">
                    <h3><i class="fas fa-list"></i> 当前播放列表</h3>
                    <div class="preview-pane" id="previewPanePlayback">
                        <!-- 播放列表内容将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 显示区域 -->
                <section class="display-area" id="displayArea">
                    <div class="favorite-badge" id="favoriteBadge">
                        <i class="fas fa-star"></i>
                    </div>
                    
                    <!-- 左侧图片 -->
                    <img class="word-image" id="leftImage" src="" alt="单词图片" style="display: none;">
                    
                    <!-- 中间单词内容 -->
                    <div class="word-content">
                        <div class="word" id="currentWord">Welcome</div>
                        <div class="phonetic" id="currentPhonetic">/ˈwɛlkəm/</div>
                        <div class="chinese" id="currentChinese">欢迎，迎接</div>
                        <div class="progress-bar">
                            <div class="progress" id="progressBar"></div>
                        </div>
                    </div>
                    
                    <!-- 右侧图片 -->
                    <img class="word-image" id="rightImage" src="" alt="单词图片" style="display: none;">
                </section>
                
                <!-- 播放控制栏 -->
                <div class="playback-controls">
                    <button id="prevBtn" class="btn-next-prev">
                        <i class="fas fa-arrow-left"></i> 上一个
                    </button>
                    <button id="playBtn" class="btn-large btn-play">
                        <i class="fas fa-play"></i> 开始自动播放
                    </button>
                    <button id="pauseBtn" class="btn-large btn-pause">
                        <i class="fas fa-pause"></i> 暂停
                    </button>
                    <button id="nextBtn" class="btn-next-prev">
                        下一个 <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <!-- 播放控制选项 -->
                <section class="controls">
                    <div class="control-group">
                        <h3><i class="fas fa-redo"></i> 重复设置</h3>
                        <label for="repeatCount">每个单词重复次数</label>
                        <input type="number" id="repeatCount" min="1" max="10" value="2">
                    </div>
                    
                    <div class="control-group">
                        <h3><i class="fas fa-clock"></i> 时间设置</h3>
                        <label for="intervalTime">间隔时间 (毫秒)</label>
                        <input type="range" id="intervalTime" min="500" max="5000" step="100" value="1500">
                        <div class="value-display" id="intervalValue">1500 ms</div>
                    </div>
                    
                    <div class="control-group">
                        <h3><i class="fas fa-volume-up"></i> 发音设置</h3>
                        <label for="voiceLanguage">发音语言</label>
                        <select id="voiceLanguage" class="language-select">
                            <option value="en-US">英语 (美国)</option>
                            <option value="en-GB">英语 (英国)</option>
                            <option value="fr-FR">法语</option>
                            <option value="de-DE">德语</option>
                            <option value="es-ES">西班牙语</option>
                            <option value="ja-JP">日语</option>
                            <option value="ko-KR">韩语</option>
                        </select>
                        
                        <label for="voiceSpeed">语速</label>
                        <input type="range" id="voiceSpeed" min="0.5" max="1.5" step="0.1" value="0.9">
                        <div class="value-display" id="voiceSpeedValue">0.9</div>
                        
                        <label for="voicePitch">音调</label>
                        <input type="range" id="voicePitch" min="0.5" max="2" step="0.1" value="1">
                        <div class="value-display" id="voicePitchValue">1.0</div>
                    </div>
                </section>
            </div>

            <!-- 新增趣味测试标签页 -->
            <div id="quiz" class="tab-content">
                <section class="quiz-section">
                    <h2><i class="fas fa-gamepad"></i> 趣味测试</h2>
                    
                    <!-- 学生管理 -->
                    <div class="student-management">
                        <div class="file-input">
                            <label for="studentFileInput">
                                <i class="fas fa-file"></i> 导入学生名单
                                <input type="file" id="studentFileInput" accept=".txt" style="display: none;">
                            </label>
                            <button id="randomStudentBtn">
                                <i class="fas fa-random"></i> 随机抽取学生
                            </button>
                            <button id="clearStudentsBtn" class="clear-btn">
                                <i class="fas fa-trash"></i> 清空学生
                            </button>
                        </div>
                    </div>
                    
                    <!-- 学生列表 -->
                    <div class="preview-section">
                        <h3><i class="fas fa-users"></i> 学生列表</h3>
                        <div class="student-list" id="studentList">
                            <!-- 学生列表将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 当前测试学生 -->
                    <div class="current-word-group">
                        <span><i class="fas fa-user"></i> 当前测试学生：</span>
                        <span id="currentStudent">未选择</span>
                        <div class="score-display" id="studentScoreDisplay">得分: 0</div>
                        <div class="title-display" id="studentTitleDisplay">称号: 新手</div>
                    </div>
                    
                    <!-- 自定义称号设置 -->
                    <div class="title-settings collapsed">
                        <h3><i class="fas fa-trophy"></i> 自定义称号设置</h3>
                        <button class="toggle-title">展开</button>
                        <p>设置不同分数段对应的称号：</p>
                        
                        <div class="title-list" id="titleList">
                            <!-- 称号列表将通过JS动态生成 -->
                        </div>
                        
                        <div class="word-input-group">
                            <input type="number" id="newTitleScore" placeholder="分数" min="0" step="10">
                            <input type="text" id="newTitleName" placeholder="称号名称">
                            <button id="addTitleBtn">
                                <i class="fas fa-plus"></i> 添加称号
                            </button>
                        </div>
                    </div>
                    
                    <!-- 测验设置 -->
                    <div class="control-group">
                        <h3><i class="fas fa-cog"></i> 测验设置</h3>
                        <label for="quizGroupFilter">选择测试分组</label>
                        <select id="quizGroupFilter">
                            <option value="">-- 所有分组 --</option>
                            <!-- 分组选项将通过JS动态生成 -->
                        </select>
                        
                        <label for="quizWordCount">测试单词数量</label>
                        <input type="number" id="quizWordCount" min="1" max="50" value="10">
                    </div>
                    
                    <!-- 自然拼读规则扩展 - 默认收起 -->
                    <div class="phonics-rules-expanded">
                        <h3><i class="fas fa-lightbulb"></i> 自然拼读规则参考 <button id="togglePhonicsRules" class="toggle-title">展开</button></h3>
                        <div class="phonics-rules-content" style="display: none;">
                            <p>以下是一些常见的自然拼读规则，可以帮助你更好地完成测验：</p>
                            
                            <div class="phonics-rules-categories">
                                <div class="phonics-category">
                                    <h4>
                                        <i class="fas fa-vihara"></i> 元音组合
                                        <button class="phonics-category-toggle">展开</button>
                                    </h4>
                                    <div class="phonics-patterns">
                                        <div class="phonics-pattern">ai (rain)</div>
                                        <div class="phonics-pattern">ay (day)</div>
                                        <div class="phonics-pattern">ee (tree)</div>
                                        <div class="phonics-pattern">ea (eat)</div>
                                        <div class="phonics-pattern">ie (pie)</div>
                                        <div class="phonics-pattern">oa (boat)</div>
                                        <div class="phonics-pattern">oe (toe)</div>
                                        <div class="phonics-pattern">ue (blue)</div>
                                        <div class="phonics-pattern">ui (fruit)</div>
                                        <div class="phonics-pattern">oo (moon)</div>
                                    </div>
                                    <div class="phonics-rule-detail">
                                        <p>元音组合通常发出长元音或双元音。例如："ai" 在 "rain" 中发 /eɪ/，"ee" 在 "tree" 中发 /iː/。</p>
                                    </div>
                                </div>
                                
                                <div class="phonics-category">
                                    <h4>
                                        <i class="fas fa-dice-d20"></i> 辅音组合
                                        <button class="phonics-category-toggle">展开</button>
                                    </h4>
                                    <div class="phonics-patterns">
                                        <div class="phonics-pattern">bl (blue)</div>
                                        <div class="phonics-pattern">br (brown)</div>
                                        <div class="phonics-pattern">cl (clap)</div>
                                        <div class="phonics-pattern">cr (cry)</div>
                                        <div class="phonics-pattern">dr (drum)</div>
                                        <div class="phonics-pattern">fl (fly)</div>
                                        <div class="phonics-pattern">fr (frog)</div>
                                        <div class="phonics-pattern">gl (glue)</div>
                                        <div class="phonics-pattern">gr (green)</div>
                                        <div class="phonics-pattern">pl (play)</div>
                                    </div>
                                    <div class="phonics-rule-detail">
                                        <p>辅音组合通常保持各自发音。例如："bl" 在 "blue" 中发 /bl/，"cr" 在 "cry" 中发 /kr/。</p>
                                    </div>
                                </div>
                                
                                <div class="phonics-category">
                                    <h4>
                                        <i class="fas fa-shield-alt"></i> 辅音连缀
                                        <button class="phonics-category-toggle">展开</button>
                                    </h4>
                                    <div class="phonics-patterns">
                                        <div class="phonics-pattern">ch (chair)</div>
                                        <div class="phonics-pattern">sh (ship)</div>
                                        <div class="phonics-pattern">th (think)</div>
                                        <div class="phonics-pattern">wh (when)</div>
                                        <div class="phonics-pattern">ph (phone)</div>
                                        <div class="phonics-pattern">gh (laugh)</div>
                                        <div class="phonics-pattern">ng (sing)</div>
                                        <div class="phonics-pattern">nk (bank)</div>
                                        <div class="phonics-pattern">ck (duck)</div>
                                    </div>
                                    <div class="phonics-rule-detail">
                                        <p>辅音连缀通常有特殊发音规则。例如："ch" 在 "chair" 中发 /tʃ/，"sh" 在 "ship" 中发 /ʃ/。</p>
                                    </div>
                                </div>
                                
                                <div class="phonics-category">
                                    <h4>
                                        <i class="fas fa-cubes"></i> 三字母组合
                                        <button class="phonics-category-toggle">展开</button>
                                    </h4>
                                    <div class="phonics-patterns">
                                        <div class="phonics-pattern">scr (screen)</div>
                                        <div class="phonics-pattern">spr (spring)</div>
                                        <div class="phonics-pattern">str (street)</div>
                                        <div class="phonics-pattern">spl (splash)</div>
                                        <div class="phonics-pattern">squ (square)</div>
                                        <div class="phonics-pattern">thr (three)</div>
                                    </div>
                                    <div class="phonics-rule-detail">
                                        <p>三字母组合通常由辅音组合和单个辅音组成。例如："scr" 在 "screen" 中发 /skr/。</p>
                                    </div>
                                </div>
                                
                                <div class="phonics-category">
                                    <h4>
                                        <i class="fas fa-layer-group"></i> 其他常见组合
                                        <button class="phonics-category-toggle">展开</button>
                                    </h4>
                                    <div class="phonics-patterns">
                                        <div class="phonics-pattern">tion (action)</div>
                                        <div class="phonics-pattern">sion (vision)</div>
                                        <div class="phonics-pattern">cian (musician)</div>
                                        <div class="phonics-pattern">ture (picture)</div>
                                        <div class="phonics-pattern">ous (famous)</div>
                                        <div class="phonics-pattern">ious (serious)</div>
                                        <div class="phonics-pattern">eous (courageous)</div>
                                    </div>
                                    <div class="phonics-rule-detail">
                                        <p>这些是常见的后缀组合，通常有固定的发音模式。例如："tion" 在 "action" 中发 /ʃən/。</p>
                                    </div>
                                </div>
                                
                                <div class="phonics-category">
                                    <h4>
                                        <i class="fas fa-code-branch"></i> 音节划分规则
                                        <button class="phonics-category-toggle">展开</button>
                                    </h4>
                                    <div class="phonics-patterns">
                                        <div class="phonics-pattern">VC/CV (rab-bit)</div>
                                        <div class="phonics-pattern">V/CV (ti-ger)</div>
                                        <div class="phonics-pattern">VC/V (cam-el)</div>
                                        <div class="phonics-pattern">C+le (ta-ble)</div>
                                        <div class="phonics-pattern">前缀/后缀</div>
                                    </div>
                                    <div class="phonics-rule-detail">
                                        <p>音节划分规则帮助确定单词的发音。例如：VC/CV 规则将 "rabbit" 分为 "rab-bit"。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 测验类型标签 -->
                    <div class="quiz-tabs">
                        <button class="quiz-tab-btn active" data-quiz-tab="phonics">
                            <i class="fas fa-spell-check"></i> 自然拼读测验
                        </button>
                        <button class="quiz-tab-btn" data-quiz-tab="listening">
                            <i class="fas fa-headphones"></i> 听力测试
                        </button>
                    </div>
                    
                    <!-- 自然拼读测验 -->
                    <div id="phonics" class="quiz-content active">
                        <!-- 自然拼读规则说明 -->
                        <div class="phonics-rule" id="phonicsRule">
                            <h4><i class="fas fa-lightbulb"></i> 自然拼读规则提示</h4>
                            <ul>
                                <li>选择正确的字母组合拼写单词</li>
                                <li>注意常见字母组合的发音规则</li>
                                <li>点击字母组合将其放入拼写区域</li>
                                <li>点击已选择的字母可将其移除</li>
                                <li>参考上方的自然拼读规则表</li>
                            </ul>
                            <button class="toggle-rule" id="toggleRule">隐藏提示</button>
                        </div>
                        
                        <!-- 自然拼读测试显示选项 -->
                        <div class="listening-options">
                            <div class="listening-option">
                                <input type="checkbox" id="showPhonicsPhonetic" checked>
                                <label for="showPhonicsPhonetic">显示音标</label>
                            </div>
                        </div>
                        
                        <div class="quiz-display" id="phonicsDisplay">
                            <div class="phonics-layout">
                                <!-- 左侧图片 -->
                                <div class="phonics-image-container">
                                    <img class="quiz-image" id="phonicsImage1" src="" alt="单词图片">
                                </div>
                                
                                <!-- 中间内容区域 -->
                                <div class="phonics-center-content">
                                    <div class="quiz-phonetic" id="phonicsPhonetic">/音标/</div>
                                    
                                    <!-- 拼写提示 -->
                                    <div class="phonics-hint" id="phonicsHint">
                                        <i class="fas fa-info-circle"></i>
                                        <span id="hintText">请根据发音拼写单词</span>
                                    </div>
                                    
                                    <!-- 拼写区域 -->
                                    <div class="phonics-spelling-area" id="phonicsSpellingArea">
                                        <!-- 拼写槽位将通过JS动态生成 -->
                                    </div>
                                    
                                    <!-- 字母和字母组合选项 -->
                                    <div class="phonics-letter-options" id="phonicsLetterOptions">
                                        <!-- 字母选项将通过JS动态生成 -->
                                    </div>
                                </div>
                                
                                <!-- 右侧图片 -->
                                <div class="phonics-image-container">
                                    <img class="quiz-image" id="phonicsImage2" src="" alt="单词图片">
                                </div>
                            </div>
                            
                            <div class="quiz-controls">
                                <button id="startPhonicsBtn" class="btn-play">
                                    <i class="fas fa-play"></i> 开始测验
                                </button>
                                <button id="playPhonicsBtn">
                                    <i class="fas fa-volume-up"></i> 播放发音 (2遍)
                                </button>
                                <button id="clearPhonicsBtn" class="btn-clear">
                                    <i class="fas fa-eraser"></i> 清空答案
                                </button>
                                <button id="checkPhonicsBtn" class="btn-save">
                                    <i class="fas fa-check"></i> 提交答案
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 听力测试 -->
                    <div id="listening" class="quiz-content">
                        <!-- 听力测试显示选项 -->
                        <div class="listening-options">
                            <div class="listening-option">
                                <input type="checkbox" id="showListeningPhonetic" checked>
                                <label for="showListeningPhonetic">显示大屏音标</label>
                            </div>
                            <div class="listening-option">
                                <input type="checkbox" id="showPhonetic" checked>
                                <label for="showPhonetic">显示答案音标</label>
                            </div>
                            <div class="listening-option">
                                <input type="checkbox" id="showEnglish" checked>
                                <label for="showEnglish">显示英文答案</label>
                            </div>
                            <div class="listening-option">
                                <input type="checkbox" id="showChinese" checked>
                                <label for="showChinese">显示中文答案</label>
                            </div>
                        </div>
                        
                        <div class="quiz-display" id="listeningDisplay">
                            <div class="quiz-phonetic" id="listeningPhonetic">/音标/</div>
                            <div class="answer-options" id="answerOptions">
                                <!-- 答案选项将通过JS动态生成 -->
                            </div>
                            <div class="quiz-controls">
                                <button id="startListeningBtn" class="btn-play">
                                    <i class="fas fa-play"></i> 开始测验
                                </button>
                                <button id="playListeningBtn">
                                    <i class="fas fa-volume-up"></i> 播放发音 (2遍)
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 成绩统计 -->
                    <div class="stats-section">
                        <div class="stat-card">
                            <h3><i class="fas fa-chart-bar"></i> 本次测试成绩</h3>
                            <div class="stat-item">
                                <span>得分：</span>
                                <span id="currentScore">0</span>
                            </div>
                            <div class="stat-item">
                                <span>正确：</span>
                                <span id="currentCorrect">0</span>
                            </div>
                            <div class="stat-item">
                                <span>错误：</span>
                                <span id="currentWrong">0</span>
                            </div>
                            <div class="stat-item">
                                <span>当前称号：</span>
                                <span id="currentTitle">-</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <h3><i class="fas fa-history"></i> 累计成绩统计</h3>
                            <div class="stat-item">
                                <span>总得分：</span>
                                <span id="totalScore">0</span>
                            </div>
                            <div class="stat-item">
                                <span>总正确：</span>
                                <span id="totalCorrect">0</span>
                            </div>
                            <div class="stat-item">
                                <span>总错误：</span>
                                <span id="totalWrong">0</span>
                            </div>
                            <div class="stat-item">
                                <span>最高称号：</span>
                                <span id="highestTitle">-</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- 设置标签页 -->
            <div id="settings" class="tab-content">
                <section class="controls">
                    <!-- 颜色控制 -->
                    <div class="control-group">
                        <h3><i class="fas fa-palette"></i> 颜色设置</h3>
                        <label for="wordBackgroundColor">单词背景颜色</label>
                        <input type="color" id="wordBackgroundColor" value="#ffffff">
                        
                        <label for="phoneticBackgroundColor">音标背景颜色</label>
                        <input type="color" id="phoneticBackgroundColor" value="#ffffff">
                        
                        <label for="chineseBackgroundColor">中文翻译背景颜色</label>
                        <input type="color" id="chineseBackgroundColor" value="#ffffff">
                        
                        <label for="displayBackgroundColor">单词带读大屏背景颜色</label>
                        <input type="color" id="displayBackgroundColor" value="#f8f9fa">
                        
                        <label for="studentDisplayBackgroundColor">随机抽取测试大屏颜色</label>
                        <input type="color" id="studentDisplayBackgroundColor" value="#4a90e2">
                    </div>
                    
                    <!-- 音频设置 -->
                    <div class="control-group">
                        <h3><i class="fas fa-volume-high"></i> 音效设置</h3>
                        <label for="studentSelectSound">抽取学生音效</label>
                        <div class="file-input">
                            <label for="studentSelectSound" style="display:flex; align-items:center; gap:10px; padding:12px 20px; background:#4a90e2; color:white; border-radius:8px; cursor:pointer; transition:all 0.3s; font-weight:500;">
                                <i class="fas fa-file"></i> 选择文件
                                <input type="file" id="studentSelectSound" accept=".mp3" style="display:none;">
                            </label>
                        </div>
                        <p class="help-text">上传MP3格式的音频文件，用于抽取到学生时播放</p>
                        <button id="playSoundPreview" class="btn btn-secondary">预览音效</button>
                    </div>
                    
                    <!-- 字体大小控制 -->
                    <div class="control-group">
                        <h3><i class="fas fa-text-height"></i> 字体大小设置</h3>
                        <label for="wordFontSize">单词字体大小</label>
                        <input type="range" id="wordFontSize" min="2" max="10" step="0.5" value="7">
                        <div class="value-display" id="wordFontSizeValue">7.0rem</div>
                        
                        <label for="phoneticFontSize">音标字体大小</label>
                        <input type="range" id="phoneticFontSize" min="1" max="5" step="0.5" value="3.5">
                        <div class="value-display" id="phoneticFontSizeValue">3.5rem</div>
                        
                        <label for="chineseFontSize">中文翻译字体大小</label>
                        <input type="range" id="chineseFontSize" min="1" max="4" step="0.2" value="2.5">
                        <div class="value-display" id="chineseFontSizeValue">2.5rem</div>
                    </div>
                </section>
                
                <!-- 数据管理 -->
                <div class="control-group">
                    <h3><i class="fas fa-database"></i> 数据管理</h3>
                    <div class="data-management-actions" style="display: flex; flex-direction: column; gap: 15px;">
                        <div>
                            <h4 style="margin-bottom: 10px;">缓存数据导入导出</h4>
                            <p class="help-text" style="margin-bottom: 15px;">导出所有存储和缓存的数据，或导入之前导出的数据文件</p>
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                <button id="exportDataBtn" class="btn btn-primary" style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-download"></i> 导出所有数据
                                </button>
                                
                                <label for="importDataFile" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: #28a745; color: white; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 500;">
                                    <i class="fas fa-upload"></i> 导入数据文件
                                    <input type="file" id="importDataFile" accept=".json" style="display: none;">
                                </label>
                                
                                <button id="clearAllDataBtn" class="btn btn-danger" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: #dc3545; color: white; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 500; border: 2px solid #dc3545;">
                                    <i class="fas fa-trash-alt"></i> 清除所有数据
                                </button>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 6px solid #ffc107; border-radius: 6px; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <i class="fas fa-exclamation-triangle" style="color: #ffc107; margin-right: 10px; font-size: 1.1rem;"></i>
                                <strong style="color: #856404;">警告：</strong>清除数据操作将永久删除所有单词、学生、设置等信息，此操作<span style="color: #dc3545; font-weight: bold;">不可恢复！</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 调试信息 -->
                <div class="debug-info">
                    <h4><i class="fas fa-bug"></i> 调试信息</h4>
                    <div class="debug-log" id="debugLog">
                        [系统] 应用已加载，等待用户操作...
                    </div>
                    <button id="clearLogBtn" style="margin-top: 10px; font-size: 0.8rem;">
                        <i class="fas fa-trash"></i> 清除日志
                    </button>
                </div>
                
                <script>
                    // 数据导出功能
                    document.getElementById('exportDataBtn').addEventListener('click', function() {
                        try {
                            // 收集所有localStorage数据
                            const allData = {
                                exportDate: new Date().toISOString(),
                                version: '1.0',
                                data: {}
                            };
                            
                            // 获取所有localStorage键值对
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                try {
                                    // 尝试解析JSON数据
                                    allData.data[key] = JSON.parse(localStorage.getItem(key));
                                } catch (e) {
                                    // 如果不是JSON格式，直接存储字符串
                                    allData.data[key] = localStorage.getItem(key);
                                }
                            }
                            
                            // 创建Blob对象
                            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            
                            // 创建下载链接
                            const a = document.createElement('a');
                            const dateStr = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                            a.href = url;
                            a.download = `yyds_data_backup_${dateStr}.json`;
                            document.body.appendChild(a);
                            a.click();
                            
                            // 清理
                            setTimeout(() => {
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                            }, 100);
                            
                            customAlert('数据导出成功！文件已开始下载。', 'success');
                        } catch (error) {
                            console.error('导出数据失败:', error);
                            customAlert('数据导出失败，请查看控制台获取详细错误信息。', 'error');
                        }
                    });
                    
                    // 数据导入功能
                    document.getElementById('importDataFile').addEventListener('change', function(event) {
                        const file = event.target.files[0];
                        if (!file) return;
                        
                        // 检查文件类型
                        if (file.type !== 'application/json') {
                            customAlert('请选择有效的JSON文件！', 'error');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                
                                // 验证数据格式
                                if (!importedData.data || typeof importedData.data !== 'object') {
                                    customAlert('无效的数据格式，请确保导入的是正确的备份文件。', 'error');
                                    return;
                                }
                                
                                // 确认导入
                                if (confirm('确定要导入数据吗？这将覆盖当前的所有设置和缓存数据。\n\n导入的文件：' + file.name + '\n导出日期：' + (importedData.exportDate || '未知'))) {
                                    // 清空现有数据
                                    localStorage.clear();
                                    
                                    // 导入所有数据
                                    for (const [key, value] of Object.entries(importedData.data)) {
                                        if (typeof value === 'object' && value !== null) {
                                            localStorage.setItem(key, JSON.stringify(value));
                                        } else {
                                            localStorage.setItem(key, String(value));
                                        }
                                    }
                                    
                                    customAlert('数据导入成功！应用将重新加载以应用所有更改。', 'success');
                                    
                                    // 延迟重新加载，让用户看到成功消息
                                    setTimeout(() => {
                                        location.reload();
                                    }, 1500);
                                }
                            } catch (error) {
                                console.error('导入数据失败:', error);
                                customAlert('数据解析失败，请确保文件格式正确。', 'error');
                            }
                        };
                        
                        reader.onerror = function() {
                            customAlert('文件读取失败，请重试。', 'error');
                        };
                        
                        reader.readAsText(file);
                        
                        // 清空文件输入，允许重复选择同一个文件
                        this.value = '';
                    });
                    
                    // 清除所有数据功能 - 增强版
                    document.getElementById('clearAllDataBtn').addEventListener('click', function() {
                        // 添加按钮动效以提供即时反馈
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => { this.style.transform = 'scale(1)'; }, 100);
                        
                        // 第一次确认对话框 - 详细说明影响范围
                        customConfirm('⚠️ 危险操作确认 ⚠️\n\n确定要清除所有数据吗？此操作将永久删除以下所有内容：\n\n📚 学习数据:\n- 所有单词及其分组\n- 所有学习记录和进度\n- 所有自定义设置和偏好\n\n👥 用户信息:\n- 所有学生信息和名单\n- 所有分数和成绩记录\n- 所有用户称号和奖励\n\n⚙️ 系统设置:\n- 所有外观和样式设置\n- 所有音频和音效配置\n- 所有API连接配置\n\n⚠️ 此操作无法撤销！⚠️', 
                        
                        // 第一次确认回调
                        function() {
                            // 第二次确认对话框 - 最终警告
                            customConfirm('🚨 最终确认 🚨\n\n这是最后一次警告！\n\n一旦确认，所有数据将被永久删除，无法恢复！\n\n即使是最专业的数据恢复工具也无法找回被删除的数据。\n\n如果您没有备份数据，请立即点击"取消"，然后先使用"导出数据"功能备份。\n\n您真的确定要继续吗？', 
                            
                            // 最终确认回调
                            function() {
                                try {
                                    // 清空所有localStorage数据
                                    localStorage.clear();
                                    
                                    // 提供成功反馈
                                    customAlert('✅ 所有数据已成功清除！\n\n应用将在几秒后自动重新加载，恢复到初始状态。', 'success');
                                    
                                    // 延迟重新加载，让用户看到成功消息
                                    setTimeout(() => {
                                        location.reload();
                                    }, 2000); // 增加延迟时间，确保用户有足够时间阅读消息
                                } catch (error) {
                                    // 错误处理
                                    console.error('清除数据失败:', error);
                                    customAlert('❌ 清除数据时发生错误\n\n请刷新页面后重试。如果问题持续，请检查浏览器存储权限设置。', 'error');
                                }
                            }, 
                            
                            // 取消回调 - 提供取消反馈
                            function() {
                                customAlert('操作已取消，您的数据安全保留。', 'info');
                            }, 
                            
                            'confirm');
                        }, 
                        
                        // 取消回调 - 提供取消反馈
                        function() {
                            customAlert('操作已取消，您的数据安全保留。', 'info');
                        }, 
                        
                        'confirm');
                    });
                </script>
            </div>
        </div>
    </div>
    
    <!-- 分组编辑模态框 -->
    <div class="group-modal" id="groupModal">
        <div class="modal-content">
            <h3><i class="fas fa-edit"></i> 编辑分组</h3>
            <div class="modal-form">
                <div id="editGroupList">
                    <!-- 分组编辑列表将通过JS动态生成 -->
                </div>
            </div>
            <div class="modal-actions">
                <button id="closeGroupModal">取消</button>
                <button id="saveGroupChanges" class="btn-save">保存更改</button>
            </div>
        </div>
    </div>

    <!-- 学生信息大屏显示 -->
    <div class="student-display" id="studentDisplay">
        <div class="student-name" id="displayStudentName">学生姓名</div>
        <div class="student-score-display" id="displayStudentScore">分数: 0</div>
        <div class="student-title-display" id="displayStudentTitle">称号: 新手</div>
    </div>

    <script>
        // 自定义弹窗函数
        function customAlert(message, type = 'info') {
            const modal = document.getElementById('customModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitleText = document.getElementById('modalTitleText');
            const modalBodyText = document.getElementById('modalBodyText');
            const modalFooter = document.getElementById('modalFooter');
            
            // 设置图标和标题
            modalIcon.className = 'modal-icon ' + type;
            modalTitleText.textContent = type === 'info' ? '提示' : 
                                       type === 'success' ? '成功' : 
                                       type === 'error' ? '错误' : '提示';
            
            // 设置图标内容
            modalIcon.innerHTML = type === 'info' ? '<i class="fas fa-info-circle"></i>' : 
                                 type === 'success' ? '<i class="fas fa-check-circle"></i>' : 
                                 type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : 
                                 '<i class="fas fa-info-circle"></i>';
            
            // 设置消息内容
            modalBodyText.textContent = message;
            
            // 清空并添加确定按钮
            modalFooter.innerHTML = '';
            const okBtn = document.createElement('button');
            okBtn.className = 'modal-btn primary';
            okBtn.textContent = '确定';
            okBtn.onclick = function() {
                modal.classList.remove('active');
            };
            modalFooter.appendChild(okBtn);
            
            // 显示弹窗
            modal.classList.add('active');
        }
        
        function customConfirm(message, onConfirm, onCancel = null, type = 'confirm') {
            const modal = document.getElementById('customModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitleText = document.getElementById('modalTitleText');
            const modalBodyText = document.getElementById('modalBodyText');
            const modalFooter = document.getElementById('modalFooter');
            
            // 设置图标和标题
            modalIcon.className = 'modal-icon ' + type;
            modalTitleText.textContent = '确认';
            modalIcon.innerHTML = '<i class="fas fa-question-circle"></i>';
            
            // 设置消息内容
            modalBodyText.textContent = message;
            
            // 清空并添加按钮
            modalFooter.innerHTML = '';
            
            // 取消按钮
            if (onCancel !== null) {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'modal-btn secondary';
                cancelBtn.textContent = '取消';
                cancelBtn.onclick = function() {
                    modal.classList.remove('active');
                    if (typeof onCancel === 'function') {
                        onCancel();
                    }
                };
                modalFooter.appendChild(cancelBtn);
            }
            
            // 确定按钮
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'modal-btn primary';
            confirmBtn.textContent = '确定';
            confirmBtn.onclick = function() {
                modal.classList.remove('active');
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            };
            modalFooter.appendChild(confirmBtn);
            
            // 显示弹窗
            modal.classList.add('active');
        }
        
        // 关闭按钮事件
        document.getElementById('modalCloseBtn').addEventListener('click', function() {
            document.getElementById('customModal').classList.remove('active');
        });
        
        // 点击遮罩层关闭弹窗
        document.getElementById('customModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
        
        // 监听ESC键关闭弹窗
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById('customModal').classList.remove('active');
            }
        });
        
        // 替换原生alert和confirm
        window.alert = customAlert;
        
        // 为confirm创建一个包装函数，保持与原生confirm类似的接口
        const originalConfirm = window.confirm;
        window.confirm = function(message) {
            // 创建一个Promise来模拟同步返回
            return new Promise(function(resolve) {
                customConfirm(message, 
                    function() { resolve(true); },  // 确定回调
                    function() { resolve(false); } // 取消回调
                );
            });
        };

        document.addEventListener('DOMContentLoaded', function() {
            // 标签页切换功能
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 移除所有标签页的活动状态
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // 激活当前标签页
                    btn.classList.add('active');
                    const tabId = btn.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    addDebugLog(`切换到标签页: ${btn.textContent.trim()}`);
                });
            });
            
            // 获取DOM元素
            const fileInput = document.getElementById('fileInput');
            const excelInput = document.getElementById('excelInput');
            const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
            const clearGroupSelect = document.getElementById('clearGroupSelect');
            const importBtn = document.getElementById('importBtn');
            const clearWordsBtn = document.getElementById('clearWordsBtn');
            const previewPane = document.getElementById('previewPane');
            const previewPanePlayback = document.getElementById('previewPanePlayback');
            const currentWord = document.getElementById('currentWord');
            const currentPhonetic = document.getElementById('currentPhonetic');
            const currentChinese = document.getElementById('currentChinese');
            const leftImage = document.getElementById('leftImage');
            const rightImage = document.getElementById('rightImage');
            const repeatCount = document.getElementById('repeatCount');
            const intervalTime = document.getElementById('intervalTime');
            const intervalValue = document.getElementById('intervalValue');
            const voiceSpeed = document.getElementById('voiceSpeed');
            const voiceSpeedValue = document.getElementById('voiceSpeedValue');
            const voicePitch = document.getElementById('voicePitch');
            const voicePitchValue = document.getElementById('voicePitchValue');
            const voiceLanguage = document.getElementById('voiceLanguage');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const progressBar = document.getElementById('progressBar');
            const appIdInput = document.getElementById('appId');
            const appKeyInput = document.getElementById('appKey');
            const testApiBtn = document.getElementById('testApiBtn');
            const saveApiBtn = document.getElementById('saveApiBtn');
            const clearApiBtn = document.getElementById('clearApiBtn');
            const apiMessage = document.getElementById('apiMessage');
            const apiStatusIndicator = document.getElementById('apiStatusIndicator');
            const apiStatusText = document.getElementById('apiStatusText');
            const debugLog = document.getElementById('debugLog');
            const clearLogBtn = document.getElementById('clearLogBtn');
            const favoriteBadge = document.getElementById('favoriteBadge');
            const allWordsBtn = document.getElementById('allWordsBtn');
            const favoriteWordsBtn = document.getElementById('favoriteWordsBtn');
            const exportWordsBtn = document.getElementById('exportWordsBtn');
            
            // Pixabay API相关元素
            const pixabayApiKeyInput = document.getElementById('pixabayApiKey');
            const testPixabayApiBtn = document.getElementById('testPixabayApiBtn');
            const savePixabayApiBtn = document.getElementById('savePixabayApiBtn');
            const clearPixabayApiBtn = document.getElementById('clearPixabayApiBtn');
            const pixabayApiStatusIndicator = document.getElementById('pixabayApiStatusIndicator');
            const pixabayApiStatusText = document.getElementById('pixabayApiStatusText');
            const pixabayApiMessage = document.getElementById('pixabayApiMessage');
            
            // 手动添加单词相关元素
            const manualWordInput = document.getElementById('manualWordInput');
            const addWordBtn = document.getElementById('addWordBtn');
            
            // 颜色和字体控制相关元素
            const wordBackgroundColor = document.getElementById('wordBackgroundColor');
            const phoneticBackgroundColor = document.getElementById('phoneticBackgroundColor');
            const chineseBackgroundColor = document.getElementById('chineseBackgroundColor');
            const displayBackgroundColor = document.getElementById('displayBackgroundColor');
const studentDisplayBackgroundColor = document.getElementById('studentDisplayBackgroundColor');
            const wordFontSize = document.getElementById('wordFontSize');
            const wordFontSizeValue = document.getElementById('wordFontSizeValue');
            const phoneticFontSize = document.getElementById('phoneticFontSize');
            const phoneticFontSizeValue = document.getElementById('phoneticFontSizeValue');
            const chineseFontSize = document.getElementById('chineseFontSize');
            const chineseFontSizeValue = document.getElementById('chineseFontSizeValue');
            const displayArea = document.getElementById('displayArea');
            
            // 分组管理相关元素
            const newGroupName = document.getElementById('newGroupName');
            const newGroupColor = document.getElementById('newGroupColor');
            const createGroupBtn = document.getElementById('createGroupBtn');
            const editGroupsBtn = document.getElementById('editGroupsBtn');
            const groupList = document.getElementById('groupList');
            const allGroupsBtn = document.getElementById('allGroupsBtn');
            const wordGroupSelect = document.getElementById('wordGroupSelect');
            const assignGroupBtn = document.getElementById('assignGroupBtn');
            const manualWordGroup = document.getElementById('manualWordGroup');
            const groupModal = document.getElementById('groupModal');
            const closeGroupModal = document.getElementById('closeGroupModal');
            const saveGroupChanges = document.getElementById('saveGroupChanges');
            const editGroupList = document.getElementById('editGroupList');
            
            // 导入和预览相关元素
            const importGroupSelect = document.getElementById('importGroupSelect');
            const previewGroupFilter = document.getElementById('previewGroupFilter');
            const syncToPlaybackBtn = document.getElementById('syncToPlaybackBtn');
            
            // 趣味测试相关元素
            const studentFileInput = document.getElementById('studentFileInput');
            const randomStudentBtn = document.getElementById('randomStudentBtn');
            const clearStudentsBtn = document.getElementById('clearStudentsBtn');
            const studentList = document.getElementById('studentList');
            const currentStudentDisplay = document.getElementById('currentStudent');
            const studentScoreDisplay = document.getElementById('studentScoreDisplay');
            const studentTitleDisplay = document.getElementById('studentTitleDisplay');
            const quizGroupFilter = document.getElementById('quizGroupFilter');
            const quizWordCount = document.getElementById('quizWordCount');
            
            // 自然拼读测验元素
            const phonicsDisplay = document.getElementById('phonicsDisplay');
            const phonicsImage1 = document.getElementById('phonicsImage1');
            const phonicsImage2 = document.getElementById('phonicsImage2');
            const phonicsPhonetic = document.getElementById('phonicsPhonetic');
            const phonicsHint = document.getElementById('phonicsHint');
            const hintText = document.getElementById('hintText');
            const phonicsSpellingArea = document.getElementById('phonicsSpellingArea');
            const phonicsLetterOptions = document.getElementById('phonicsLetterOptions');
            const startPhonicsBtn = document.getElementById('startPhonicsBtn');
            const playPhonicsBtn = document.getElementById('playPhonicsBtn');
            const clearPhonicsBtn = document.getElementById('clearPhonicsBtn');
            const checkPhonicsBtn = document.getElementById('checkPhonicsBtn');
            const phonicsRule = document.getElementById('phonicsRule');
            const toggleRuleBtn = document.getElementById('toggleRule');
            
            // 听力测试元素
            const listeningDisplay = document.getElementById('listeningDisplay');
            const listeningPhonetic = document.getElementById('listeningPhonetic');
            const answerOptions = document.getElementById('answerOptions');
            const startListeningBtn = document.getElementById('startListeningBtn');
            const playListeningBtn = document.getElementById('playListeningBtn');
            
            // 成绩统计元素
            const currentScoreDisplay = document.getElementById('currentScore');
            const currentCorrectDisplay = document.getElementById('currentCorrect');
            const currentWrongDisplay = document.getElementById('currentWrong');
            const currentTitleDisplay = document.getElementById('currentTitle');
            const totalScoreDisplay = document.getElementById('totalScore');
            const totalCorrectDisplay = document.getElementById('totalCorrect');
            const totalWrongDisplay = document.getElementById('totalWrong');
            const highestTitleDisplay = document.getElementById('highestTitle');
            
            // 自定义称号设置元素
            const titleList = document.getElementById('titleList');
            const newTitleScore = document.getElementById('newTitleScore');
            const newTitleName = document.getElementById('newTitleName');
            const addTitleBtn = document.getElementById('addTitleBtn');
            const toggleTitleBtn = document.querySelector('.toggle-title');
            const titleSettings = document.querySelector('.title-settings');
            
            // 自然拼读规则展开按钮
            const categoryToggles = document.querySelectorAll('.phonics-category-toggle');
            
            // 听力测试显示选项
            const showListeningPhoneticCheckbox = document.getElementById('showListeningPhonetic');
            const showPhoneticCheckbox = document.getElementById('showPhonetic');
            const showEnglishCheckbox = document.getElementById('showEnglish');
            const showChineseCheckbox = document.getElementById('showChinese');
            
            // 自然拼读测试显示选项
            const showPhonicsPhoneticCheckbox = document.getElementById('showPhonicsPhonetic');
            
            // 自然拼读规则区域切换按钮
            const togglePhonicsRulesBtn = document.getElementById('togglePhonicsRules');
            const phonicsRulesContent = document.querySelector('.phonics-rules-content');
            
            // 新增学生信息大屏显示元素
            const studentDisplay = document.getElementById('studentDisplay');
            const displayStudentName = document.getElementById('displayStudentName');
            const displayStudentScore = document.getElementById('displayStudentScore');
            const displayStudentTitle = document.getElementById('displayStudentTitle');
            
            // 单词列表和当前索引
            let words = [];
            let filteredWords = [];
            let currentIndex = 0;
            let isPlaying = false;
            let playInterval;
            let speechSynth = window.speechSynthesis;
            let showOnlyFavorites = false;
            let currentGroupFilter = null;
            let previewGroupFilterValue = null;
            
            // 分组数据
            let groups = [];
            
            // 趣味测试相关变量
            let students = [];
            let currentStudent = null;
            let quizWords = [];
            let currentQuizIndex = 0;
            let currentQuizType = 'phonics';
            let isQuizActive = false;
            
            // 自然拼读测验相关变量
            let phonicsSpellingSlots = [];
            let phonicsSelectedLetters = [];
            let phonicsCorrectWord = '';
            let phonicsLetterOptionsArray = [];
            
            // 成绩统计
            let currentScore = 0;
            let currentCorrect = 0;
            let currentWrong = 0;
            let totalScore = 0;
            let totalCorrect = 0;
            let totalWrong = 0;
            let studentRecords = {};
            
            // 自定义称号系统
            let customTitles = [];
            
            // 扩展的自然拼读规则库
            const phonicsPatterns = {
                // 元音组合
                vowelTeams: [
                    'ai', 'ay', 'ea', 'ee', 'ie', 'oa', 'oe', 'ue', 'ui',
                    'ei', 'ey', 'ow', 'ou', 'oo', 'au', 'aw', 'ew'
                ],
                // 辅音组合
                consonantBlends: [
                    'bl', 'br', 'cl', 'cr', 'dr', 'fl', 'fr', 'gl', 'gr',
                    'pl', 'pr', 'sc', 'sk', 'sl', 'sm', 'sn', 'sp', 'st', 'sw', 'tr', 'tw'
                ],
                // 辅音连缀
                consonantDigraphs: [
                    'ch', 'sh', 'th', 'wh', 'ph', 'gh', 'ng', 'nk', 'ck'
                ],
                // 三字母组合
                threeLetterBlends: [
                    'scr', 'spr', 'str', 'spl', 'squ', 'thr'
                ],
                // 其他常见组合
                otherPatterns: [
                    'tion', 'sion', 'cian', 'ture', 'ous', 'ious', 'eous'
                ],
                // 音节划分模式
                syllablePatterns: [
                    'VC/CV', 'V/CV', 'VC/V', 'C+le'
                ],
                // 前缀和后缀
                affixes: [
                    'un', 're', 'pre', 'dis', 'mis', 'non', 'in', 'im', 'il', 'ir',
                    'able', 'ible', 'ful', 'less', 'ness', 'ment', 'er', 'est', 'ly', 'y'
                ]
            };
            
            // 扩展的自然拼读提示语
            const phonicsHints = [
                "注意元音组合的发音规则",
                "辅音组合通常保持各自发音",
                "双辅音组合有特殊发音规则",
                "注意单词中的常见字母组合",
                "根据音节划分来拼写单词",
                "注意前缀和后缀的发音规则",
                "尝试根据单词的音节来拼写",
                "记住常见的自然拼读模式"
            ];
            
            // 从本地缓存加载数据
            loadCachedWords();
            loadCachedGroups();
            loadStyleSettings();
            loadStudentData();
            loadScoreData();
            loadCustomTitles();
            loadListeningOptions();
            loadLastUsedGroup();
            
            // 示例单词数据
            const sampleWords = [
                { 
                    word: "apple", 
                    phonetic: "/ˈæp.əl/", 
                    chinese: "苹果",
                    favorite: false,
                    groupId: null,
                    leftImageUrl: "https://cdn.pixabay.com/photo/2014/02/01/17/28/apple-256261_1280.jpg",
                    rightImageUrl: "https://cdn.pixabay.com/photo/2017/09/26/13/42/apple-2788662_1280.jpg"
                },
                { 
                    word: "banana", 
                    phonetic: "/bəˈnɑː.nə/", 
                    chinese: "香蕉",
                    favorite: false,
                    groupId: null,
                    leftImageUrl: "https://cdn.pixabay.com/photo/2017/06/27/22/21/banana-2449019_1280.jpg",
                    rightImageUrl: "https://cdn.pixabay.com/photo/2016/01/03/17/59/bananas-1119790_1280.jpg"
                },
                { 
                    word: "computer", 
                    phonetic: "/kəmˈpjuː.tər/", 
                    chinese: "电脑，计算机",
                    favorite: false,
                    groupId: null,
                    leftImageUrl: "https://cdn.pixabay.com/photo/2015/01/21/14/14/apple-606761_1280.jpg",
                    rightImageUrl: "https://cdn.pixabay.com/photo/2015/05/31/10/55/technology-791028_1280.jpg"
                },
                { 
                    word: "teacher", 
                    phonetic: "/ˈtiː.tʃər/", 
                    chinese: "老师",
                    favorite: false,
                    groupId: null,
                    leftImageUrl: "https://cdn.pixabay.com/photo/2016/11/14/17/39/person-1824144_1280.jpg",
                    rightImageUrl: "https://cdn.pixabay.com/photo/2015/07/31/11/45/library-869061_1280.jpg"
                },
                { 
                    word: "elephant", 
                    phonetic: "/ˈel.ɪ.fənt/", 
                    chinese: "大象",
                    favorite: false,
                    groupId: null,
                    leftImageUrl: "https://cdn.pixabay.com/photo/2016/11/14/04/45/elephant-1822636_1280.jpg",
                    rightImageUrl: "https://cdn.pixabay.com/photo/2017/10/06/13/50/elephant-2822467_1280.jpg"
                }
            ];
            
            // 如果没有缓存数据，使用示例单词
            if (words.length === 0) {
                words = sampleWords;
                cacheWordsData();
            }
            
            // 初始化分组（如果没有分组）
            if (groups.length === 0) {
                groups = [
                    { id: generateId(), name: "日常词汇", color: "#4a90e2" },
                    { id: generateId(), name: "学术词汇", color: "#5cb85c" },
                    { id: generateId(), name: "备考词汇", color: "#f0ad4e" }
                ];
                cacheGroupsData();
            }
            
            // 初始化自定义称号（如果没有自定义称号）
            if (customTitles.length === 0) {
                customTitles = [
                    { score: 0, name: "新手" },
                    { score: 50, name: "学习者" },
                    { score: 100, name: "进步者" },
                    { score: 200, name: "熟练者" },
                    { score: 500, name: "高手" },
                    { score: 1000, name: "大师" }
                ];
                cacheCustomTitles();
            }
            
            // 初始化界面
            updateGroupUI();
            filterWords();
            updatePreviewPane();
            displayCurrentWord();
            updateStudentList();
            updateScoreDisplay();
            updateTitleList();
            
            // 从本地存储加载API配置
            loadApiConfig();
            loadPixabayApiConfig();
            
            // 添加事件监听器
            importBtn.addEventListener('click', handleFileImport);
            downloadTemplateBtn.addEventListener('click', downloadExcelTemplate);
            clearWordsBtn.addEventListener('click', clearAllWords);
            clearApiBtn.addEventListener('click', clearApiConfig);
            intervalTime.addEventListener('input', updateIntervalValue);
            voiceSpeed.addEventListener('input', updateVoiceSpeedValue);
            voicePitch.addEventListener('input', updateVoicePitchValue);
            prevBtn.addEventListener('click', goToPreviousWord);
            nextBtn.addEventListener('click', goToNextWord);
            playBtn.addEventListener('click', startAutoPlay);
            pauseBtn.addEventListener('click', pauseAutoPlay);
            testApiBtn.addEventListener('click', testApiConnection);
            saveApiBtn.addEventListener('click', saveApiConfig);
            clearLogBtn.addEventListener('click', clearDebugLog);
            favoriteBadge.addEventListener('click', toggleFavorite);
            allWordsBtn.addEventListener('click', () => setFilter(false));
            favoriteWordsBtn.addEventListener('click', () => setFilter(true));
            exportWordsBtn.addEventListener('click', exportWordList);
            
            // Pixabay API事件
            testPixabayApiBtn.addEventListener('click', testPixabayApiConnection);
            savePixabayApiBtn.addEventListener('click', savePixabayApiConfig);
            clearPixabayApiBtn.addEventListener('click', clearPixabayApiConfig);
            
            // 手动添加单词事件
            addWordBtn.addEventListener('click', addManualWord);
            manualWordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addManualWord();
                }
            });
            
            // 颜色和字体控制事件
            wordBackgroundColor.addEventListener('input', updateWordBackgroundColor);
            phoneticBackgroundColor.addEventListener('input', updatePhoneticBackgroundColor);
            chineseBackgroundColor.addEventListener('input', updateChineseBackgroundColor);
            displayBackgroundColor.addEventListener('input', updateDisplayBackgroundColor);
            studentDisplayBackgroundColor.addEventListener('input', updateStudentDisplayBackgroundColor);
            wordFontSize.addEventListener('input', updateWordFontSize);
            phoneticFontSize.addEventListener('input', updatePhoneticFontSize);
            chineseFontSize.addEventListener('input', updateChineseFontSize);
            
            // 分组管理事件
            createGroupBtn.addEventListener('click', createNewGroup);
            editGroupsBtn.addEventListener('click', openGroupEditModal);
            closeGroupModal.addEventListener('click', closeGroupEditModal);
            saveGroupChanges.addEventListener('click', saveGroupEditChanges);
            allGroupsBtn.addEventListener('click', () => filterByGroup(null));
            assignGroupBtn.addEventListener('click', assignWordToGroup);
            
            // 导入和预览事件
            previewGroupFilter.addEventListener('change', updatePreviewFilter);
            syncToPlaybackBtn.addEventListener('click', syncPreviewToPlayback);
            
            // 自然拼读规则展开按钮事件
            categoryToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const category = this.closest('.phonics-category');
                    const detail = category.querySelector('.phonics-rule-detail');
                    
                    if (detail.classList.contains('active')) {
                        detail.classList.remove('active');
                        this.textContent = '展开';
                    } else {
                        detail.classList.add('active');
                        this.textContent = '收起';
                    }
                });
            });
            
            // 趣味测试事件
            studentFileInput.addEventListener('change', handleStudentFileImport);
            randomStudentBtn.addEventListener('click', selectRandomStudent);
            clearStudentsBtn.addEventListener('click', clearAllStudents);
            startPhonicsBtn.addEventListener('click', startPhonicsQuiz);
            playPhonicsBtn.addEventListener('click', playPhonicsWord);
            clearPhonicsBtn.addEventListener('click', clearPhonicsAnswer);
            checkPhonicsBtn.addEventListener('click', checkPhonicsAnswer);
            startListeningBtn.addEventListener('click', startListeningQuiz);
            playListeningBtn.addEventListener('click', playListeningWord);
            
            // 自定义称号事件
            addTitleBtn.addEventListener('click', addCustomTitle);
            toggleTitleBtn.addEventListener('click', function() {
                titleSettings.classList.toggle('collapsed');
                this.textContent = titleSettings.classList.contains('collapsed') ? '展开' : '收起';
            });
            
            // 自然拼读规则显示切换
            toggleRuleBtn.addEventListener('click', togglePhonicsRule);
            
            // 听力测试显示选项事件
            showListeningPhoneticCheckbox.addEventListener('change', function() {
                saveListeningOptions();
                // 如果当前正在进行听力测试，立即更新显示
                if (isQuizActive && currentQuizType === 'listening' && listeningPhonetic) {
                    listeningPhonetic.style.display = this.checked ? 'block' : 'none';
                }
            });
            showPhoneticCheckbox.addEventListener('change', saveListeningOptions);
            showEnglishCheckbox.addEventListener('change', saveListeningOptions);
            showChineseCheckbox.addEventListener('change', saveListeningOptions);
            
            // 自然拼读测试显示选项事件
            if (showPhonicsPhoneticCheckbox) {
                showPhonicsPhoneticCheckbox.addEventListener('change', function() {
                    saveListeningOptions();
                    // 如果当前正在进行自然拼读测试，立即更新显示
                    if (isQuizActive && currentQuizType === 'phonics' && phonicsPhonetic) {
                        phonicsPhonetic.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // 自然拼读规则区域切换事件
            togglePhonicsRulesBtn.addEventListener('click', function() {
                if (phonicsRulesContent.style.display === 'none') {
                    phonicsRulesContent.style.display = 'block';
                    this.textContent = '收起';
                } else {
                    phonicsRulesContent.style.display = 'none';
                    this.textContent = '展开';
                }
            });
            
            // 测验标签切换
            const quizTabBtns = document.querySelectorAll('.quiz-tab-btn');
            const quizContents = document.querySelectorAll('.quiz-content');
            
            quizTabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 移除所有标签页的活动状态
                    quizTabBtns.forEach(b => b.classList.remove('active'));
                    quizContents.forEach(c => c.classList.remove('active'));
                    
                    // 激活当前标签页
                    btn.classList.add('active');
                    const quizTabId = btn.getAttribute('data-quiz-tab');
                    document.getElementById(quizTabId).classList.add('active');
                    
                    currentQuizType = quizTabId;
                    addDebugLog(`切换到测验类型: ${btn.textContent.trim()}`);
                });
            });
            
            // 窗口大小改变时调整显示内容
            window.addEventListener('resize', function() {
                adjustDisplayContent();
            });
            
            // 调试日志功能
            function addDebugLog(message) {
                const timestamp = new Date().toLocaleTimeString();
                debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
                debugLog.scrollTop = debugLog.scrollHeight;
            }
            
            function clearDebugLog() {
                debugLog.innerHTML = '[系统] 日志已清除<br>';
            }
            
            // 清除API配置
            function clearApiConfig() {
                customConfirm('确定要清除API配置吗？', function() {
                    localStorage.removeItem('baiduAppId');
                    localStorage.removeItem('baiduAppKey');
                    appIdInput.value = '';
                    appKeyInput.value = '';
                    showApiMessage('API配置已清除', 'success');
                    addDebugLog('已清除百度翻译API配置');
                });
            }
            
            // 清除Pixabay API配置
            function clearPixabayApiConfig() {
                customConfirm('确定要清除Pixabay API配置吗？', function() {
                    localStorage.removeItem('pixabayApiKey');
                    pixabayApiKeyInput.value = '';
                    showPixabayApiMessage('Pixabay API配置已清除', 'success');
                    setPixabayApiStatus('disconnected');
                    addDebugLog('已清除Pixabay API配置');
                });
            }
            
            // 按分组清除单词功能
            function clearAllWords() {
                const selectedGroupId = clearGroupSelect.value;
                
                // 验证是否选择了分组
                if (!selectedGroupId) {
                    customAlert('请选择要清除的分组', 'warning');
                    return;
                }
                
                // 检查是否有单词
                if (words.length === 0) {
                    customAlert('当前没有单词可清除', 'info');
                    return;
                }
                
                let wordsToClear = [];
                let confirmMessage = '';
                let successMessage = '';
                
                // 根据选择的分组确定要清除的单词
                if (selectedGroupId === 'all') {
                    // 清除所有单词
                    wordsToClear = [...words];
                    confirmMessage = '确定要清除所有单词吗？此操作不可恢复。';
                    successMessage = '所有单词已清除';
                } else {
                    // 只清除指定分组的单词
                    wordsToClear = words.filter(word => word.groupId === selectedGroupId);
                    const groupName = getGroupNameById(selectedGroupId);
                    confirmMessage = `确定要清除"${groupName}"分组下的所有单词吗？此操作不可恢复。`;
                    successMessage = `"${groupName}"分组下的单词已清除`;
                    
                    if (wordsToClear.length === 0) {
                        customAlert(`"${groupName}"分组下没有单词可清除`, 'info');
                        return;
                    }
                }
                
                customConfirm(confirmMessage, function() {
                    if (selectedGroupId === 'all') {
                        // 清除所有单词
                        words = [];
                        addDebugLog('已清除所有单词');
                    } else {
                        // 只清除指定分组的单词
                        words = words.filter(word => word.groupId !== selectedGroupId);
                        const groupName = getGroupNameById(selectedGroupId);
                        addDebugLog(`已清除"${groupName}"分组下的所有单词`);
                    }
                    
                    // 重置状态
                    filteredWords = [];
                    currentIndex = 0;
                    cacheWordsData();
                    filterWords();
                    updatePreviewPane();
                    
                    // 如果没有剩余单词，更新显示
                    if (words.length === 0) {
                        currentWord.textContent = '无单词';
                        currentPhonetic.textContent = '';
                        currentChinese.textContent = '';
                        leftImage.style.display = 'none';
                        rightImage.style.display = 'none';
                        favoriteBadge.classList.remove('active');
                    }
                    
                    // 重置选择框
                    clearGroupSelect.value = '';
                    
                    customAlert(successMessage, 'success');
                });
            }
            
            // 删除单个单词
            function deleteWord(wordToDelete) {
                customConfirm(`确定要删除单词 "${wordToDelete}" 吗？`, function() {
                    // 从单词列表中移除
                    const wordIndex = words.findIndex(w => w.word === wordToDelete);
                    if (wordIndex !== -1) {
                        words.splice(wordIndex, 1);
                    }
                    
                    // 更新过滤后的单词列表
                    filterWords();
                    
                    // 如果删除的是当前显示的单词，切换到下一个单词
                    if (filteredWords.length > 0) {
                        if (currentIndex >= filteredWords.length) {
                            currentIndex = filteredWords.length - 1;
                        }
                        displayCurrentWord();
                    } else {
                        // 如果没有单词了，清空显示
                        currentWord.textContent = '无单词';
                        currentPhonetic.textContent = '';
                        currentChinese.textContent = '';
                        leftImage.style.display = 'none';
                        rightImage.style.display = 'none';
                        favoriteBadge.classList.remove('active');
                    }
                    
                    // 更新缓存和预览
                    cacheWordsData();
                    updatePreviewPane();
                    
                    addDebugLog(`已删除单词: ${wordToDelete}`);
                });
            }
            
            // 手动添加单词
            function addManualWord() {
                const wordText = manualWordInput.value.trim();
                
                if (!wordText) {
                    customAlert('请输入单词', 'warning');
                    return;
                }
                
                // 检查单词是否已存在
                const existingWordIndex = words.findIndex(w => w.word.toLowerCase() === wordText.toLowerCase());
                if (existingWordIndex !== -1) {
                    customAlert(`单词 "${wordText}" 已存在`, 'warning');
                    manualWordInput.value = '';
                    return;
                }
                
                // 获取选中的分组（使用上次选择的分组）
                const selectedGroupId = manualWordGroup.value || getLastUsedGroup();
                
                // 添加新单词
                const newWordIndex = words.length;
                words.push({
                    word: wordText,
                    phonetic: "/加载中/",
                    chinese: "正在获取中文释义... <span class='loading'></span>",
                    favorite: false,
                    groupId: selectedGroupId || null,
                    leftImageUrl: "",
                    rightImageUrl: ""
                });
                
                // 保存到缓存
                cacheWordsData();
                
                // 更新界面
                filterWords();
                updatePreviewPane();
                
                // 切换到新添加的单词
                currentIndex = filteredWords.length - 1;
                updatePreviewPane();
                displayCurrentWord();
                
                // 获取单词详情
                fetchWordDetails(wordText, newWordIndex);
                
                // 清空输入框
                manualWordInput.value = '';
                
                addDebugLog(`已手动添加单词: ${wordText}`);
            }
            
            // 获取上次使用的分组
            function getLastUsedGroup() {
                return localStorage.getItem('lastUsedGroup') || '';
            }
            
            // 保存上次使用的分组
            function saveLastUsedGroup(groupId) {
                localStorage.setItem('lastUsedGroup', groupId || '');
            }
            
            // 从本地存储加载上次使用的分组
            function loadLastUsedGroup() {
                const lastUsedGroup = getLastUsedGroup();
                if (lastUsedGroup) {
                    manualWordGroup.value = lastUsedGroup;
                }
            }
            
            // 更新单词背景颜色
            function updateWordBackgroundColor() {
                currentWord.style.backgroundColor = wordBackgroundColor.value;
                saveStyleSetting('wordBackgroundColor', wordBackgroundColor.value);
                
                // 计算文本颜色（基于背景色的对比度）
                const bgColor = hexToRgb(wordBackgroundColor.value);
                const textColor = getContrastColor(bgColor);
                currentWord.style.color = textColor;
                saveStyleSetting('wordTextColor', textColor);
            }
            
            // 更新音标背景颜色
            function updatePhoneticBackgroundColor() {
                currentPhonetic.style.backgroundColor = phoneticBackgroundColor.value;
                saveStyleSetting('phoneticBackgroundColor', phoneticBackgroundColor.value);
                
                // 计算文本颜色（基于背景色的对比度）
                const bgColor = hexToRgb(phoneticBackgroundColor.value);
                const textColor = getContrastColor(bgColor);
                currentPhonetic.style.color = textColor;
                saveStyleSetting('phoneticTextColor', textColor);
            }
            
            // 更新中文翻译背景颜色
            function updateChineseBackgroundColor() {
                currentChinese.style.backgroundColor = chineseBackgroundColor.value;
                saveStyleSetting('chineseBackgroundColor', chineseBackgroundColor.value);
                
                // 计算文本颜色（基于背景色的对比度）
                const bgColor = hexToRgb(chineseBackgroundColor.value);
                const textColor = getContrastColor(bgColor);
                currentChinese.style.color = textColor;
                saveStyleSetting('chineseTextColor', textColor);
            }
            
            // 更新大屏背景颜色
            function updateDisplayBackgroundColor() {
                displayArea.style.background = displayBackgroundColor.value;
                saveStyleSetting('displayBackgroundColor', displayBackgroundColor.value);
                
                // 隐藏背景图案
                displayArea.style.backgroundImage = 'none';
            }
            
            // 更新学生大屏背景颜色
            function updateStudentDisplayBackgroundColor() {
                saveStyleSetting('studentDisplayBackgroundColor', studentDisplayBackgroundColor.value);
                // 立即应用到当前显示（如果大屏正在显示）
                if (studentDisplay.classList.contains('active')) {
                    studentDisplay.style.background = studentDisplayBackgroundColor.value;
                }
            }
            
            // 更新单词字体大小
            function updateWordFontSize() {
                const size = wordFontSize.value;
                currentWord.style.fontSize = `${size}rem`;
                wordFontSizeValue.textContent = `${size}rem`;
                saveStyleSetting('wordFontSize', size);
            }
            
            // 更新音标字体大小
            function updatePhoneticFontSize() {
                const size = phoneticFontSize.value;
                currentPhonetic.style.fontSize = `${size}rem`;
                phoneticFontSizeValue.textContent = `${size}rem`;
                saveStyleSetting('phoneticFontSize', size);
            }
            
            // 更新中文翻译字体大小
            function updateChineseFontSize() {
                const size = chineseFontSize.value;
                currentChinese.style.fontSize = `${size}rem`;
                chineseFontSizeValue.textContent = `${size}rem`;
                saveStyleSetting('chineseFontSize', size);
            }
            
            // 调整大屏内部内容以适应高度变化
            function adjustDisplayContent() {
                const displayHeight = displayArea.clientHeight;
                const displayWidth = displayArea.clientWidth;
                
                // 非全屏模式下的字体大小调整
                if (displayHeight < 400) {
                    currentWord.style.fontSize = '3rem';
                    currentPhonetic.style.fontSize = '1.8rem';
                    currentChinese.style.fontSize = '1.5rem';
                } else if (displayHeight < 600) {
                    currentWord.style.fontSize = '5rem';
                    currentPhonetic.style.fontSize = '2.5rem';
                    currentChinese.style.fontSize = '2rem';
                } else {
                    currentWord.style.fontSize = '7rem';
                    currentPhonetic.style.fontSize = '3.5rem';
                    currentChinese.style.fontSize = '2.5rem';
                }
                
                // 其他调整逻辑
                const borderRadius = Math.min(displayWidth, displayHeight) * 0.02;
                displayArea.style.borderRadius = `${borderRadius}px`;
                
                const elements = [currentWord, currentPhonetic, currentChinese, leftImage, rightImage];
                elements.forEach(el => {
                    el.style.borderRadius = `${borderRadius * 0.5}px`;
                });
            }
            
            // 保存样式设置到本地存储
            function saveStyleSetting(key, value) {
                try {
                    let settings = JSON.parse(localStorage.getItem('styleSettings') || '{}');
                    settings[key] = value;
                    localStorage.setItem('styleSettings', JSON.stringify(settings));
                    addDebugLog(`已保存样式设置: ${key} = ${value}`);
                } catch (error) {
                    addDebugLog(`保存样式设置失败: ${error.message}`);
                }
            }
            
            // 从本地存储加载样式设置
            function loadStyleSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('styleSettings') || '{}');
                    
                    // 应用颜色设置
                    if (settings.wordBackgroundColor) {
                        wordBackgroundColor.value = settings.wordBackgroundColor;
                        currentWord.style.backgroundColor = settings.wordBackgroundColor;
                    }
                    
                    if (settings.phoneticBackgroundColor) {
                        phoneticBackgroundColor.value = settings.phoneticBackgroundColor;
                        currentPhonetic.style.backgroundColor = settings.phoneticBackgroundColor;
                    }
                    
                    if (settings.chineseBackgroundColor) {
                        chineseBackgroundColor.value = settings.chineseBackgroundColor;
                        currentChinese.style.backgroundColor = settings.chineseBackgroundColor;
                    }
                    
                    if (settings.displayBackgroundColor) {
                        displayBackgroundColor.value = settings.displayBackgroundColor;
                        displayArea.style.background = settings.displayBackgroundColor;
                        displayArea.style.backgroundImage = 'none';
                    }
                    
                    if (settings.studentDisplayBackgroundColor) {
                        studentDisplayBackgroundColor.value = settings.studentDisplayBackgroundColor;
                    }
                    
                    // 应用文本颜色设置
                    if (settings.wordTextColor) {
                        currentWord.style.color = settings.wordTextColor;
                    }
                    
                    if (settings.phoneticTextColor) {
                        currentPhonetic.style.color = settings.phoneticTextColor;
                    }
                    
                    if (settings.chineseTextColor) {
                        currentChinese.style.color = settings.chineseTextColor;
                    }
                    
                    // 应用字体大小设置
                    if (settings.wordFontSize) {
                        wordFontSize.value = settings.wordFontSize;
                        currentWord.style.fontSize = `${settings.wordFontSize}rem`;
                        wordFontSizeValue.textContent = `${settings.wordFontSize}rem`;
                    }
                    
                    if (settings.phoneticFontSize) {
                        phoneticFontSize.value = settings.phoneticFontSize;
                        currentPhonetic.style.fontSize = `${settings.phoneticFontSize}rem`;
                        phoneticFontSizeValue.textContent = `${settings.phoneticFontSize}rem`;
                    }
                    
                    if (settings.chineseFontSize) {
                        chineseFontSize.value = settings.chineseFontSize;
                        currentChinese.style.fontSize = `${settings.chineseFontSize}rem`;
                        chineseFontSizeValue.textContent = `${settings.chineseFontSize}rem`;
                    }
                    
                    // 调整大屏内容
                    adjustDisplayContent();
                    
                    addDebugLog('已加载保存的样式设置');
                } catch (error) {
                    addDebugLog(`加载样式设置失败: ${error.message}`);
                }
            }
            
            // 辅助函数：将十六进制颜色转换为RGB
            function hexToRgb(hex) {
                // 移除#号
                hex = hex.replace('#', '');
                
                // 解析RGB值
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                
                return { r, g, b };
            }
            
            // 辅助函数：根据背景色获取对比度文本色（黑或白）
            function getContrastColor(rgb) {
                // 计算亮度
                const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
                
                // 如果亮度大于0.5，使用黑色文本，否则使用白色文本
                return luminance > 0.5 ? '#000000' : '#ffffff';
            }
            
            // 从本地存储加载API配置
            function loadApiConfig() {
                const savedAppId = localStorage.getItem('baiduAppId');
                const savedAppKey = localStorage.getItem('baiduAppKey');
                
                if (savedAppId) {
                    appIdInput.value = savedAppId;
                }
                
                if (savedAppKey) {
                    appKeyInput.value = savedAppKey;
                }
                
                if (savedAppId && savedAppKey) {
                    showApiMessage('已加载保存的API配置', 'success');
                    addDebugLog('已从本地存储加载百度翻译API配置');
                }
            }
            
            // 从本地存储加载Pixabay API配置
            function loadPixabayApiConfig() {
                const savedPixabayApiKey = localStorage.getItem('pixabayApiKey');
                
                if (savedPixabayApiKey) {
                    pixabayApiKeyInput.value = savedPixabayApiKey;
                    setPixabayApiStatus('connected');
                    showPixabayApiMessage('已加载保存的Pixabay API配置', 'success');
                    addDebugLog('已从本地存储加载Pixabay API配置');
                }
            }
            
            // 保存API配置到本地存储
            function saveApiConfig() {
                const appId = appIdInput.value.trim();
                const appKey = appKeyInput.value.trim();
                
                if (!appId || !appKey) {
                    showApiMessage('请填写APP ID和密钥', 'error');
                    addDebugLog('保存百度翻译API配置失败：APP ID或密钥为空');
                    return;
                }
                
                localStorage.setItem('baiduAppId', appId);
                localStorage.setItem('baiduAppKey', appKey);
                
                showApiMessage('API配置已保存', 'success');
                addDebugLog('百度翻译API配置已保存到本地存储');
            }
            
            // 保存Pixabay API配置到本地存储
            function savePixabayApiConfig() {
                const pixabayApiKey = pixabayApiKeyInput.value.trim();
                
                if (!pixabayApiKey) {
                    showPixabayApiMessage('请填写Pixabay API密钥', 'error');
                    addDebugLog('保存Pixabay API配置失败：API密钥为空');
                    return;
                }
                
                localStorage.setItem('pixabayApiKey', pixabayApiKey);
                
                showPixabayApiMessage('Pixabay API配置已保存', 'success');
                setPixabayApiStatus('connected');
                addDebugLog('Pixabay API配置已保存到本地存储');
            }
            
            // 测试API连接
            async function testApiConnection() {
                const appId = appIdInput.value.trim();
                const appKey = appKeyInput.value.trim();
                
                if (!appId || !appKey) {
                    showApiMessage('请填写APP ID和密钥', 'error');
                    addDebugLog('测试百度翻译API连接失败：APP ID或密钥为空');
                    return;
                }
                
                showApiMessage('正在测试API连接...', '');
                setApiStatus('testing');
                addDebugLog('开始测试百度翻译API连接...');
                
                try {
                    // 先尝试主API
                    let result = await fetchBaiduTranslation('hello', appId, appKey);
                    
                    if (result && result !== '请先配置百度翻译API' && !result.includes('失败')) {
                        showApiMessage('API连接成功！翻译结果: ' + result, 'success');
                        setApiStatus('connected');
                        addDebugLog('百度翻译API连接测试成功，翻译结果: ' + result);
                        return;
                    }
                    
                    // 主API失败，尝试备用API
                    addDebugLog('主API测试失败，尝试备用翻译服务');
                    const fallbackResult = await fetchFallbackTranslation('hello');
                    
                    if (fallbackResult) {
                        showApiMessage('主API不可用，但备用翻译服务可用: ' + fallbackResult, 'success');
                        setApiStatus('connected-fallback');
                        addDebugLog('备用翻译服务测试成功: ' + fallbackResult);
                    } else {
                        showApiMessage('所有翻译服务均不可用', 'error');
                        setApiStatus('error');
                        addDebugLog('所有翻译服务测试失败');
                    }
                } catch (error) {
                    showApiMessage('API连接失败: ' + error.message, 'error');
                    setApiStatus('error');
                    addDebugLog('百度翻译API连接测试异常: ' + error.message);
                }
            }
            
            // 测试Pixabay API连接
            async function testPixabayApiConnection() {
                const pixabayApiKey = pixabayApiKeyInput.value.trim();
                
                if (!pixabayApiKey) {
                    showPixabayApiMessage('请填写Pixabay API密钥', 'error');
                    addDebugLog('测试Pixabay API连接失败：API密钥为空');
                    return;
                }
                
                showPixabayApiMessage('正在测试Pixabay API连接...', '');
                setPixabayApiStatus('testing');
                addDebugLog('开始测试Pixabay API连接...');
                
                try {
                    const result = await fetchPixabayImages('apple', pixabayApiKey);
                    
                    if (result && result.leftImage && result.rightImage && 
                        result.leftImage !== '请先配置Pixabay API' && !result.leftImage.includes('失败') &&
                        result.rightImage !== '请先配置Pixabay API' && !result.rightImage.includes('失败')) {
                        showPixabayApiMessage('Pixabay API连接成功！', 'success');
                        setPixabayApiStatus('connected');
                        addDebugLog('Pixabay API连接测试成功');
                        return;
                    } else {
                        showPixabayApiMessage('Pixabay API连接失败', 'error');
                        setPixabayApiStatus('error');
                        addDebugLog('Pixabay API连接测试失败');
                    }
                } catch (error) {
                    showPixabayApiMessage('Pixabay API连接失败: ' + error.message, 'error');
                    setPixabayApiStatus('error');
                    addDebugLog('Pixabay API连接测试异常: ' + error.message);
                }
            }
            
            // 设置API状态
            function setApiStatus(status) {
                switch(status) {
                    case 'connected':
                        apiStatusIndicator.style.backgroundColor = '#5cb85c';
                        apiStatusText.textContent = '词典API: 已连接 (主服务)';
                        break;
                    case 'connected-fallback':
                        apiStatusIndicator.style.backgroundColor = '#f0ad4e';
                        apiStatusText.textContent = '词典API: 已连接 (备用服务)';
                        break;
                    case 'error':
                        apiStatusIndicator.style.backgroundColor = '#d9534f';
                        apiStatusText.textContent = '词典API: 音标and释义均可正常使用，莫怕！';
                        break;
                    case 'testing':
                        apiStatusIndicator.style.backgroundColor = '#f0ad4e';
                        apiStatusText.textContent = '词典API: 测试中...';
                        break;
                    default:
                        apiStatusIndicator.style.backgroundColor = '#5cb85c';
                        apiStatusText.textContent = '词典API: 就绪 (主服务 + 备用服务)';
                }
            }
            
            // 设置Pixabay API状态
            function setPixabayApiStatus(status) {
                switch(status) {
                    case 'connected':
                        pixabayApiStatusIndicator.style.backgroundColor = '#5cb85c';
                        pixabayApiStatusText.textContent = '图片API: 已连接';
                        break;
                    case 'error':
                        pixabayApiStatusIndicator.style.backgroundColor = '#d9534f';
                        pixabayApiStatusText.textContent = '图片API: 连接错误';
                        break;
                    case 'testing':
                        pixabayApiStatusIndicator.style.backgroundColor = '#f0ad4e';
                        pixabayApiStatusText.textContent = '图片API: 测试中...';
                        break;
                    default:
                        pixabayApiStatusIndicator.style.backgroundColor = '#d9534f';
                        pixabayApiStatusText.textContent = '图片API: 未配置';
                }
            }
            
            // 显示API消息
            function showApiMessage(message, type) {
                apiMessage.textContent = message;
                apiMessage.className = 'message';
                
                if (type) {
                    apiMessage.classList.add(type);
                }
                
                setTimeout(() => {
                    apiMessage.style.display = 'none';
                }, 5000);
            }
            
            // 显示Pixabay API消息
            function showPixabayApiMessage(message, type) {
                pixabayApiMessage.textContent = message;
                pixabayApiMessage.className = 'message';
                
                if (type) {
                    pixabayApiMessage.classList.add(type);
                }
                
                setTimeout(() => {
                    pixabayApiMessage.style.display = 'none';
                }, 5000);
            }
            
            // 文件导入处理
            function handleFileImport() {
                const txtFile = fileInput.files[0];
                const excelFile = excelInput.files[0];
                
                // 检查选择了哪个文件
                if (!txtFile && !excelFile) {
                    customAlert('请先选择一个TXT或Excel文件', 'warning');
                    addDebugLog('文件导入失败：未选择文件');
                    return;
                }
                
                // 如果两个都选了，优先处理Excel
                if (excelFile) {
                    handleExcelImport(excelFile);
                } else {
                    handleTxtImport(txtFile);
                }
            }
            
            // TXT文件导入处理
            function handleTxtImport(file) {
                addDebugLog('开始导入TXT文件: ' + file.name);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    const newWords = [];
                    
                    let importedCount = 0;
                    let skippedCount = 0;
                    
                    for (let line of lines) {
                        const word = line.trim();
                        if (word && !words.some(w => w.word.toLowerCase() === word.toLowerCase())) {
                            // 获取选中的分组
                            const selectedGroupId = importGroupSelect.value || null;
                            
                            newWords.push({
                                word: word,
                                phonetic: "/加载中/",
                                chinese: "正在获取中文释义... <span class='loading'></span>",
                                favorite: false,
                                groupId: selectedGroupId,
                                leftImageUrl: "",
                                rightImageUrl: ""
                            });
                            importedCount++;
                        } else if (word) {
                            skippedCount++;
                        }
                    }
                    
                    if (newWords.length > 0) {
                        // 添加到单词列表
                        words.push(...newWords);
                        cacheWordsData();
                        filterWords();
                        updatePreviewPane();
                        
                        // 批量获取单词详情
                        for (let i = 0; i < newWords.length; i++) {
                            const index = words.length - newWords.length + i;
                            fetchWordDetails(newWords[i].word, index);
                        }
                        
                        customAlert(`成功导入 ${importedCount} 个单词，跳过 ${skippedCount} 个重复单词`, 'success');
                        addDebugLog(`成功导入 ${importedCount} 个单词，跳过 ${skippedCount} 个重复单词`);
                    } else {
                        customAlert('没有成功导入任何单词', 'info');
                        addDebugLog('没有成功导入任何单词');
                    }
                    
                    // 清空文件输入
                    fileInput.value = '';
                };
                
                reader.readAsText(file);
            }
            
            // Excel文件导入处理
            function handleExcelImport(file) {
                addDebugLog('开始导入Excel文件: ' + file.name);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // 获取第一个工作表
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // 将工作表转换为JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        const newWords = [];
                        let importedCount = 0;
                        let skippedCount = 0;
                        
                        // 假设第一行为标题行，从第二行开始读取
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            // 检查是否有空行
                            if (!row || row.length === 0) continue;
                            
                            // 提取单词、音标、释义，容错处理
                            const word = (row[0] || '').toString().trim();
                            const phonetic = (row[1] || '').toString().trim();
                            const chinese = (row[2] || '').toString().trim();
                            
                            // 只处理非空单词，且不重复
                            if (word && !words.some(w => w.word.toLowerCase() === word.toLowerCase())) {
                                // 获取选中的分组
                                const selectedGroupId = importGroupSelect.value || null;
                                
                                newWords.push({
                                    word: word,
                                    phonetic: phonetic || "/未知/", // 使用Excel中的音标，没有则使用默认值
                                    chinese: chinese || "未知释义", // 使用Excel中的释义，没有则使用默认值
                                    favorite: false,
                                    groupId: selectedGroupId,
                                    leftImageUrl: "",
                                    rightImageUrl: ""
                                });
                                importedCount++;
                            } else if (word) {
                                skippedCount++;
                            }
                        }
                        
                        if (newWords.length > 0) {
                            // 添加到单词列表
                            words.push(...newWords);
                            cacheWordsData();
                            filterWords();
                            updatePreviewPane();
                            
                            // 对于Excel导入的单词，如果缺少音标或释义，仍然尝试获取完整信息
                            for (let i = 0; i < newWords.length; i++) {
                                const index = words.length - newWords.length + i;
                                const wordItem = newWords[i];
                                
                                // 如果音标或释义不完整，获取详细信息
                                if (wordItem.phonetic === '/未知/' || wordItem.chinese === '未知释义') {
                                    fetchWordDetails(wordItem.word, index);
                                } else {
                                    // 即使音标和释义都有，也尝试获取图片
                                    fetchPixabayImagesAsync(wordItem.word, index);
                                }
                            }
                            
                            customAlert(`成功导入 ${importedCount} 个单词，跳过 ${skippedCount} 个重复单词`, 'success');
                            addDebugLog(`成功导入 ${importedCount} 个单词，跳过 ${skippedCount} 个重复单词`);
                        } else {
                            customAlert('没有成功导入任何单词', 'info');
                            addDebugLog('没有成功导入任何单词');
                        }
                    } catch (error) {
                        customAlert('Excel文件解析失败: ' + error.message, 'error');
                        addDebugLog('Excel文件解析失败: ' + error.message);
                    }
                    
                    // 清空文件输入
                    excelInput.value = '';
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            // 异步获取Pixabay图片
            async function fetchPixabayImagesAsync(word, index) {
                try {
                    const pixabayApiKey = localStorage.getItem('pixabayApiKey');
                    if (pixabayApiKey) {
                        const images = await fetchPixabayImages(word, pixabayApiKey);
                        
                        // 更新单词图片信息
                        if (words[index] && words[index].word === word) {
                            if (images.leftImage && images.leftImage !== '请先配置Pixabay API' && !images.leftImage.includes('失败')) {
                                words[index].leftImageUrl = images.leftImage;
                            }
                            
                            if (images.rightImage && images.rightImage !== '请先配置Pixabay API' && !images.rightImage.includes('失败')) {
                                words[index].rightImageUrl = images.rightImage;
                            }
                            
                            cacheWordsData();
                            updatePreviewPane();
                        }
                    }
                } catch (error) {
                    addDebugLog(`获取图片失败: ${word}, 错误: ${error.message}`);
                }
            }
            
            // 下载Excel模板文件
            function downloadExcelTemplate() {
                // 创建模板数据，第一行为标题行，包含示例数据
                const templateData = [
                    ['单词', '音标', '释义'], // 列标题
                    ['apple', '/ˈæpl/', '苹果'],  // 示例1
                    ['book', '/bʊk/', '书；书籍'], // 示例2
                    ['computer', '/kəmˈpjuːtər/', '计算机；电脑'], // 示例3
                    ['study', '/ˈstʌdi/', '学习；研究'] // 示例4
                ];
                
                // 创建工作簿和工作表
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(templateData);
                
                // 设置列宽（根据内容调整）
                ws['!cols'] = [
                    {wch: 15}, // 单词列宽度
                    {wch: 15}, // 音标列宽度
                    {wch: 30}  // 释义列宽度
                ];
                
                // 添加工作表到工作簿
                XLSX.utils.book_append_sheet(wb, ws, '单词列表模板');
                
                // 下载Excel文件
                XLSX.writeFile(wb, '单词导入模板.xlsx');
                
                addDebugLog('Excel模板文件已下载');
            }
            
            // 获取单词详情（音标、中文释义、图片）
            async function fetchWordDetails(word, index) {
                try {
                    addDebugLog(`开始获取单词详情: ${word}`);
                    
                    // 获取翻译
                    const appId = localStorage.getItem('baiduAppId');
                    const appKey = localStorage.getItem('baiduAppKey');
                    
                    let translation = '';
                    if (appId && appKey) {
                        translation = await fetchBaiduTranslation(word, appId, appKey);
                    } else {
                        translation = await fetchFallbackTranslation(word);
                    }
                    
                    // 获取图片
                    const pixabayApiKey = localStorage.getItem('pixabayApiKey');
                    let images = { leftImage: '', rightImage: '' };
                    if (pixabayApiKey) {
                        images = await fetchPixabayImages(word, pixabayApiKey);
                    }
                    
                    // 更新单词信息
                    if (words[index] && words[index].word === word) {
                        words[index].chinese = translation || '未找到释义';
                        words[index].phonetic = await fetchPhonetic(word) || "/未知/";
                        
                        if (images.leftImage && images.leftImage !== '请先配置Pixabay API' && !images.leftImage.includes('失败')) {
                            words[index].leftImageUrl = images.leftImage;
                        }
                        
                        if (images.rightImage && images.rightImage !== '请先配置Pixabay API' && !images.rightImage.includes('失败')) {
                            words[index].rightImageUrl = images.rightImage;
                        }
                        
                        cacheWordsData();
                        
                        // 如果当前显示的是这个单词，更新显示
                        if (filteredWords[currentIndex] && filteredWords[currentIndex].word === word) {
                            displayCurrentWord();
                        }
                        
                        updatePreviewPane();
                        
                        addDebugLog(`成功获取单词详情: ${word}`);
                    }
                } catch (error) {
                    addDebugLog(`获取单词详情失败: ${word}, 错误: ${error.message}`);
                    
                    // 如果获取失败，使用默认值
                    if (words[index] && words[index].word === word) {
                        words[index].chinese = '获取释义失败';
                        words[index].phonetic = "/未知/";
                        cacheWordsData();
                        updatePreviewPane();
                    }
                }
            }
            
            // 百度翻译API
            async function fetchBaiduTranslation(word, appId, appKey) {
                try {
                    const salt = Date.now().toString();
                    const sign = md5(appId + word + salt + appKey);
                    
                    const response = await fetch(`https://fanyi-api.baidu.com/api/trans/vip/translate?q=${encodeURIComponent(word)}&from=en&to=zh&appid=${appId}&salt=${salt}&sign=${sign}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.trans_result && data.trans_result.length > 0) {
                        return data.trans_result[0].dst;
                    } else {
                        throw new Error('No translation result');
                    }
                } catch (error) {
                    addDebugLog(`百度翻译API请求失败: ${error.message}`);
                    throw error;
                }
            }
            
            // 备用翻译服务
            async function fetchFallbackTranslation(word) {
                try {
                    // 尝试使用免费的翻译API
                    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|zh`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.responseData && data.responseData.translatedText) {
                        return data.responseData.translatedText;
                    } else {
                        throw new Error('No translation result');
                    }
                } catch (error) {
                    addDebugLog(`备用翻译服务请求失败: ${error.message}`);
                    return '备用翻译服务不可用';
                }
            }
            
            // 获取音标
            async function fetchPhonetic(word) {
                try {
                    // 使用免费词典API获取音标
                    const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.length > 0 && data[0].phonetics && data[0].phonetics.length > 0) {
                        // 查找包含音标的条目
                        for (let phonetic of data[0].phonetics) {
                            if (phonetic.text) {
                                return phonetic.text;
                            }
                        }
                    }
                    
                    throw new Error('No phonetic found');
                } catch (error) {
                    addDebugLog(`获取音标失败: ${error.message}`);
                    return null;
                }
            }
            
            // 从Pixabay获取图片
            async function fetchPixabayImages(word, apiKey) {
                try {
                    if (!apiKey) {
                        return {
                            leftImage: '请先配置Pixabay API',
                            rightImage: '请先配置Pixabay API'
                        };
                    }
                    
                    // 尝试多种搜索策略
                    const searchTerms = [
                        word,
                        `${word} object`,
                        `${word} item`,
                        word + 's', // 复数形式
                        getRelatedTerm(word) // 相关术语
                    ];
                    
                    let leftImageUrl = '';
                    let rightImageUrl = '';
                    
                    for (let term of searchTerms) {
                        if (leftImageUrl && rightImageUrl) break;
                        
                        const response = await fetch(`https://pixabay.com/api/?key=${apiKey}&q=${encodeURIComponent(term)}&image_type=photo&per_page=20&safesearch=true`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.hits && data.hits.length > 0) {
                            // 选择两张不同的图片
                            const hits = data.hits;
                            
                            if (!leftImageUrl && hits[0]) {
                                leftImageUrl = hits[0].webformatURL;
                            }
                            
                            if (!rightImageUrl && hits.length > 1) {
                                rightImageUrl = hits[1].webformatURL;
                            } else if (!rightImageUrl && hits.length > 0) {
                                rightImageUrl = hits[0].webformatURL;
                            }
                        }
                    }
                    
                    return {
                        leftImage: leftImageUrl || '未找到图片',
                        rightImage: rightImageUrl || '未找到图片'
                    };
                } catch (error) {
                    addDebugLog(`Pixabay API请求失败: ${error.message}`);
                    return {
                        leftImage: `获取图片失败: ${error.message}`,
                        rightImage: `获取图片失败: ${error.message}`
                    };
                }
            }
            
            // 获取相关术语（简化版）
            function getRelatedTerm(word) {
                const relatedTerms = {
                    'computer': 'technology',
                    'teacher': 'education',
                    'elephant': 'animal',
                    'apple': 'fruit',
                    'banana': 'fruit'
                };
                
                return relatedTerms[word.toLowerCase()] || word;
            }
            
            // 更新间隔时间显示
            function updateIntervalValue() {
                intervalValue.textContent = `${intervalTime.value} ms`;
            }
            
            // 更新语速显示
            function updateVoiceSpeedValue() {
                voiceSpeedValue.textContent = voiceSpeed.value;
            }
            
            // 更新音调显示
            function updateVoicePitchValue() {
                voicePitchValue.textContent = voicePitch.value;
            }
            
            // 播放单词发音
            function speakWord(word, onComplete = null) {
                if (!word) return;
                
                // 停止任何正在进行的语音
                speechSynth.cancel();
                
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = voiceLanguage.value;
                utterance.rate = parseFloat(voiceSpeed.value);
                utterance.pitch = parseFloat(voicePitch.value);
                
                // 查找可用的语音
                const voices = speechSynth.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.lang.startsWith(voiceLanguage.value.split('-')[0])
                );
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                // 添加语音播放完成事件处理
                utterance.onend = function() {
                    if (typeof onComplete === 'function') {
                        onComplete();
                    }
                };
                
                speechSynth.speak(utterance);
            }
            
            // 上一个单词
            function goToPreviousWord() {
                if (filteredWords.length === 0) return;
                
                currentIndex = (currentIndex - 1 + filteredWords.length) % filteredWords.length;
                displayCurrentWord();
            }
            
            // 下一个单词
            function goToNextWord() {
                if (filteredWords.length === 0) return;
                
                currentIndex = (currentIndex + 1) % filteredWords.length;
                displayCurrentWord();
            }
            
            // 开始自动播放
            function startAutoPlay() {
                if (filteredWords.length === 0) {
                    customAlert('没有单词可播放', 'info');
                    return;
                }
                
                if (isPlaying) return;
                
                isPlaying = true;
                playBtn.disabled = true;
                pauseBtn.disabled = false;
                
                const totalRepeats = parseInt(repeatCount.value);
                const interval = parseInt(intervalTime.value);
                
                // 使用语音朗读完成事件来控制播放流程
                let currentRepeats = 0;
                let currentWordIndex = currentIndex;
                
                function playWithRepeats() {
                    if (!isPlaying) return;
                    
                    // 播放当前单词，并在朗读完成后执行回调
                    speakWord(filteredWords[currentWordIndex].word, function() {
                        if (!isPlaying) return; // 如果已经暂停，则不再继续
                        
                        currentRepeats++;
                        
                        if (currentRepeats >= totalRepeats) {
                            // 当前单词已播放完指定次数，切换到下一个单词
                            currentRepeats = 0;
                            currentWordIndex = (currentWordIndex + 1) % filteredWords.length;
                            currentIndex = currentWordIndex; // 更新全局索引
                            displayCurrentWord();
                            
                            // 更新进度条
                            const progress = ((currentIndex + 1) / filteredWords.length) * 100;
                            progressBar.style.width = `${progress}%`;
                        }
                        
                        // 设置间隔时间后继续播放（无论是重复当前单词还是切换后播放）
                        // 注意：这里只有在语音播放完成后才会设置下一次播放
                        setTimeout(function() {
                            if (isPlaying) {
                                playWithRepeats();
                            }
                        }, interval);
                    });
                }
                
                // 开始播放
                playWithRepeats();
                
                addDebugLog(`开始自动播放，间隔: ${interval}ms, 重复次数: ${totalRepeats}`);
            }
            
            // 暂停自动播放
            function pauseAutoPlay() {
                if (!isPlaying) return;
                
                isPlaying = false;
                playBtn.disabled = false;
                pauseBtn.disabled = true;
                
                clearTimeout(playInterval); // 修改为clearTimeout
                speechSynth.cancel();
                
                addDebugLog('已暂停自动播放');
            }
            
            // 显示当前单词
            function displayCurrentWord() {
                if (filteredWords.length === 0) {
                    currentWord.textContent = '无单词';
                    currentPhonetic.textContent = '';
                    currentChinese.textContent = '';
                    leftImage.style.display = 'none';
                    rightImage.style.display = 'none';
                    favoriteBadge.classList.remove('active');
                    return;
                }
                
                const wordObj = filteredWords[currentIndex];
                
                currentWord.textContent = wordObj.word;
                currentPhonetic.textContent = wordObj.phonetic;
                currentChinese.innerHTML = wordObj.chinese;
                
                // 更新收藏状态
                if (wordObj.favorite) {
                    favoriteBadge.classList.add('active');
                } else {
                    favoriteBadge.classList.remove('active');
                }
                
                // 显示图片
                if (wordObj.leftImageUrl && wordObj.leftImageUrl !== '未找到图片' && 
                    !wordObj.leftImageUrl.includes('失败') && 
                    wordObj.leftImageUrl !== '请先配置Pixabay API') {
                    leftImage.src = wordObj.leftImageUrl;
                    leftImage.style.display = 'block';
                } else {
                    leftImage.style.display = 'none';
                }
                
                if (wordObj.rightImageUrl && wordObj.rightImageUrl !== '未找到图片' && 
                    !wordObj.rightImageUrl.includes('失败') && 
                    wordObj.rightImageUrl !== '请先配置Pixabay API') {
                    rightImage.src = wordObj.rightImageUrl;
                    rightImage.style.display = 'block';
                } else {
                    rightImage.style.display = 'none';
                }
                
                // 更新进度条
                const progress = ((currentIndex + 1) / filteredWords.length) * 100;
                progressBar.style.width = `${progress}%`;
                
                // 更新分组选择
                if (wordObj.groupId) {
                    wordGroupSelect.value = wordObj.groupId;
                } else {
                    wordGroupSelect.value = '';
                }
                
                // 朗读单词
                speakWord(wordObj.word);
                
                addDebugLog(`显示单词: ${wordObj.word}`);
            }
            
            // 切换收藏状态
            function toggleFavorite() {
                if (filteredWords.length === 0) return;
                
                const currentWordObj = filteredWords[currentIndex];
                const originalIndex = words.findIndex(w => w.word === currentWordObj.word);
                
                if (originalIndex !== -1) {
                    words[originalIndex].favorite = !words[originalIndex].favorite;
                    currentWordObj.favorite = words[originalIndex].favorite;
                    
                    if (currentWordObj.favorite) {
                        favoriteBadge.classList.add('active');
                        addDebugLog(`已收藏单词: ${currentWordObj.word}`);
                    } else {
                        favoriteBadge.classList.remove('active');
                        addDebugLog(`已取消收藏单词: ${currentWordObj.word}`);
                    }
                    
                    cacheWordsData();
                    updatePreviewPane();
                }
            }
            
            // 设置单词过滤器
            function setFilter(showFavoritesOnly) {
                showOnlyFavorites = showFavoritesOnly;
                
                if (showFavoritesOnly) {
                    allWordsBtn.classList.remove('active');
                    favoriteWordsBtn.classList.add('active');
                    addDebugLog('已切换到仅显示收藏单词');
                } else {
                    allWordsBtn.classList.add('active');
                    favoriteWordsBtn.classList.remove('active');
                    addDebugLog('已切换到显示所有单词');
                }
                
                filterWords();
                updatePreviewPane();
                currentIndex = 0;
                displayCurrentWord();
            }
            
            // 过滤单词
            function filterWords() {
                filteredWords = words.filter(word => {
                    // 按收藏状态过滤
                    if (showOnlyFavorites && !word.favorite) {
                        return false;
                    }
                    
                    // 按分组过滤
                    if (currentGroupFilter && word.groupId !== currentGroupFilter) {
                        return false;
                    }
                    
                    return true;
                });
                
                // 如果当前索引超出范围，重置为0
                if (currentIndex >= filteredWords.length) {
                    currentIndex = 0;
                }
            }
            
            // 导出单词列表
            function exportWordList() {
                if (words.length === 0) {
                    customAlert('没有单词可导出', 'info');
                    return;
                }
                
                // 创建CSV内容
                let csvContent = "单词,音标,中文释义,收藏状态,分组\n";
                
                words.forEach(word => {
                    const favoriteStatus = word.favorite ? "是" : "否";
                    const groupName = word.groupId ? getGroupNameById(word.groupId) : "未分组";
                    csvContent += `"${word.word}","${word.phonetic}","${word.chinese}","${favoriteStatus}","${groupName}"\n`;
                });
                
                // 创建下载链接
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', '单词列表.csv');
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addDebugLog(`已导出单词列表，共 ${words.length} 个单词`);
            }
            
            // 更新单词预览面板
            function updatePreviewPane() {
                // 更新导入标签页的预览面板
                previewPane.innerHTML = '';
                
                filteredWords.forEach((word, index) => {
                    const wordChip = document.createElement('div');
                    wordChip.className = 'word-chip';
                    wordChip.textContent = word.word;
                    
                    if (word.favorite) {
                        wordChip.classList.add('favorite');
                    }
                    
                    if (word.groupId) {
                        const groupIndicator = document.createElement('span');
                        groupIndicator.className = 'word-chip group-indicator';
                        groupIndicator.textContent = getGroupNameById(word.groupId);
                        groupIndicator.style.backgroundColor = getGroupColorById(word.groupId);
                        wordChip.appendChild(groupIndicator);
                    }
                    
                    // 添加删除按钮
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-word-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteWord(word.word);
                    });
                    wordChip.appendChild(deleteBtn);
                    
                    // 点击单词跳转到该单词
                    wordChip.addEventListener('click', () => {
                        currentIndex = index;
                        displayCurrentWord();
                    });
                    
                    // 高亮当前单词
                    if (index === currentIndex) {
                        wordChip.classList.add('active');
                    }
                    
                    previewPane.appendChild(wordChip);
                });
                
                // 更新播放控制标签页的预览面板
                previewPanePlayback.innerHTML = '';
                
                filteredWords.forEach((word, index) => {
                    const wordChip = document.createElement('div');
                    wordChip.className = 'word-chip';
                    wordChip.textContent = word.word;
                    
                    if (word.favorite) {
                        wordChip.classList.add('favorite');
                    }
                    
                    if (word.groupId) {
                        const groupIndicator = document.createElement('span');
                        groupIndicator.className = 'word-chip group-indicator';
                        groupIndicator.textContent = getGroupNameById(word.groupId);
                        groupIndicator.style.backgroundColor = getGroupColorById(word.groupId);
                        wordChip.appendChild(groupIndicator);
                    }
                    
                    // 点击单词跳转到该单词并朗读
                    wordChip.addEventListener('click', () => {
                        currentIndex = index;
                        displayCurrentWord();
                        // 修复：点击播放列表时朗读单词
                        speakWord(word.word);
                    });
                    
                    // 高亮当前单词
                    if (index === currentIndex) {
                        wordChip.classList.add('active');
                    }
                    
                    previewPanePlayback.appendChild(wordChip);
                });
                
                // 更新单词计数
                const wordCount = filteredWords.length;
                const totalCount = words.length;
                document.querySelector('.preview-section h3').textContent = `单词预览 (${wordCount}/${totalCount})`;
            }
            
            // 缓存单词数据到本地存储
            function cacheWordsData() {
                try {
                    localStorage.setItem('wordList', JSON.stringify(words));
                    addDebugLog(`已缓存 ${words.length} 个单词到本地存储`);
                } catch (error) {
                    addDebugLog(`缓存单词数据失败: ${error.message}`);
                }
            }
            
            // 从本地存储加载缓存的单词数据
            function loadCachedWords() {
                try {
                    const cachedWords = localStorage.getItem('wordList');
                    if (cachedWords) {
                        words = JSON.parse(cachedWords);
                        addDebugLog(`从本地存储加载了 ${words.length} 个单词`);
                    }
                } catch (error) {
                    addDebugLog(`加载缓存的单词数据失败: ${error.message}`);
                }
            }
            
            // 生成唯一ID
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            // 创建新分组
            function createNewGroup() {
                const groupName = newGroupName.value.trim();
                const groupColor = newGroupColor.value;
                
                if (!groupName) {
                    customAlert('请输入分组名称', 'warning');
                    return;
                }
                
                // 检查分组名称是否已存在
                if (groups.some(group => group.name === groupName)) {
                    customAlert('分组名称已存在', 'warning');
                    return;
                }
                
                const newGroup = {
                    id: generateId(),
                    name: groupName,
                    color: groupColor
                };
                
                groups.push(newGroup);
                cacheGroupsData();
                updateGroupUI();
                
                newGroupName.value = '';
                
                addDebugLog(`已创建新分组: ${groupName}`);
            }
            
            // 更新分组UI
            function updateGroupUI() {
                // 更新分组列表
                groupList.innerHTML = '';
                
                groups.forEach(group => {
                    const groupItem = document.createElement('div');
                    groupItem.className = 'group-item';
                    groupItem.style.backgroundColor = group.color;
                    groupItem.style.color = getContrastColor(hexToRgb(group.color));
                    groupItem.textContent = group.name;
                    
                    groupItem.addEventListener('click', () => {
                        filterByGroup(group.id);
                    });
                    
                    groupList.appendChild(groupItem);
                });
                
                // 更新分组选择下拉菜单
                updateGroupSelectOptions();
                
                // 更新预览分组筛选器
                updatePreviewGroupFilter();
                
                // 更新测验分组筛选器
                updateQuizGroupFilter();
            }
            
            // 更新分组选择下拉菜单
            function updateGroupSelectOptions() {
                // 更新单词分组选择
                wordGroupSelect.innerHTML = '<option value="">-- 未分组 --</option>';
                manualWordGroup.innerHTML = '<option value="">-- 选择分组（可选）--</option>';
                importGroupSelect.innerHTML = '<option value="">-- 选择分组（可选）--</option>';
                clearGroupSelect.innerHTML = '<option value="">-- 选择分组清除 --</option><option value="all">-- 清除所有单词 --</option>';
                
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    
                    wordGroupSelect.appendChild(option.cloneNode(true));
                    manualWordGroup.appendChild(option.cloneNode(true));
                    importGroupSelect.appendChild(option.cloneNode(true));
                    clearGroupSelect.appendChild(option.cloneNode(true));
                });
            }
            
            // 更新预览分组筛选器
            function updatePreviewGroupFilter() {
                previewGroupFilter.innerHTML = '<option value="">-- 所有分组 --</option>';
                
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    previewGroupFilter.appendChild(option);
                });
            }
            
            // 更新测验分组筛选器
            function updateQuizGroupFilter() {
                quizGroupFilter.innerHTML = '<option value="">-- 所有分组 --</option>';
                
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    quizGroupFilter.appendChild(option);
                });
            }
            
            // 根据分组过滤单词
            function filterByGroup(groupId) {
                currentGroupFilter = groupId;
                
                // 更新分组按钮状态
                const groupItems = document.querySelectorAll('.group-item');
                groupItems.forEach(item => {
                    item.classList.remove('active');
                });
                
                if (groupId) {
                    const activeGroupItem = Array.from(groupItems).find(item => 
                        item.textContent === getGroupNameById(groupId)
                    );
                    if (activeGroupItem) {
                        activeGroupItem.classList.add('active');
                    }
                    
                    allGroupsBtn.classList.remove('active');
                } else {
                    allGroupsBtn.classList.add('active');
                }
                
                filterWords();
                updatePreviewPane();
                currentIndex = 0;
                displayCurrentWord();
                
                addDebugLog(`已按分组过滤: ${groupId ? getGroupNameById(groupId) : '所有分组'}`);
            }
            
            // 获取分组名称
            function getGroupNameById(groupId) {
                const group = groups.find(g => g.id === groupId);
                return group ? group.name : '';
            }
            
            // 获取分组颜色
            function getGroupColorById(groupId) {
                const group = groups.find(g => g.id === groupId);
                return group ? group.color : '#cccccc';
            }
            
            // 打开分组编辑模态框
            function openGroupEditModal() {
                editGroupList.innerHTML = '';
                
                groups.forEach((group, index) => {
                    const groupItem = document.createElement('div');
                    groupItem.className = 'title-item';
                    
                    groupItem.innerHTML = `
                        <input type="color" value="${group.color}" data-index="${index}">
                        <input type="text" value="${group.name}" data-index="${index}">
                        <span class="delete-group" data-index="${index}"><i class="fas fa-trash"></i></span>
                    `;
                    
                    editGroupList.appendChild(groupItem);
                });
                
                groupModal.style.display = 'flex';
            }
            
            // 关闭分组编辑模态框
            function closeGroupEditModal() {
                groupModal.style.display = 'none';
            }
            
            // 保存分组编辑更改
            function saveGroupEditChanges() {
                // 更新分组信息
                const colorInputs = editGroupList.querySelectorAll('input[type="color"]');
                const nameInputs = editGroupList.querySelectorAll('input[type="text"]');
                
                colorInputs.forEach(input => {
                    const index = parseInt(input.getAttribute('data-index'));
                    groups[index].color = input.value;
                });
                
                nameInputs.forEach(input => {
                    const index = parseInt(input.getAttribute('data-index'));
                    groups[index].name = input.value;
                });
                
                cacheGroupsData();
                updateGroupUI();
                closeGroupEditModal();
                
                addDebugLog('已保存分组编辑更改');
            }
            
            // 删除分组
            function deleteGroup(index) {
                const groupName = groups[index].name;
                const groupId = groups[index].id;
                
                // 从分组列表中移除
                groups.splice(index, 1);
                
                // 更新所有属于该分组的单词
                words.forEach(word => {
                    if (word.groupId === groupId) {
                        word.groupId = null;
                    }
                });
                
                // 重新渲染编辑列表，确保索引正确
                openGroupEditModal();
                
                cacheGroupsData();
                cacheWordsData();
                updateGroupUI();
                
                addDebugLog(`已删除分组: ${groupName}`);
            }
            
            // 为分组编辑模态框添加删除事件
            editGroupList.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-group') || e.target.parentElement.classList.contains('delete-group')) {
                    const deleteBtn = e.target.classList.contains('delete-group') ? e.target : e.target.parentElement;
                    const index = parseInt(deleteBtn.getAttribute('data-index'));
                    const groupName = groups[index].name;
                    
                    // 添加确认提示
                    customConfirm(`确定要删除分组 "${groupName}" 吗？`, function() {
                        deleteGroup(index);
                    });
                }
            });
            
            // 缓存分组数据到本地存储
            function cacheGroupsData() {
                try {
                    localStorage.setItem('wordGroups', JSON.stringify(groups));
                    addDebugLog(`已缓存 ${groups.length} 个分组到本地存储`);
                } catch (error) {
                    addDebugLog(`缓存分组数据失败: ${error.message}`);
                }
            }
            
            // 从本地存储加载分组数据
            function loadCachedGroups() {
                try {
                    const cachedGroups = localStorage.getItem('wordGroups');
                    if (cachedGroups) {
                        groups = JSON.parse(cachedGroups);
                        addDebugLog(`从本地存储加载了 ${groups.length} 个分组`);
                    }
                } catch (error) {
                    addDebugLog(`加载分组数据失败: ${error.message}`);
                }
            }
            
            // 将单词分配到分组
            function assignWordToGroup() {
                if (filteredWords.length === 0) {
                    customAlert('没有单词可分配', 'info');
                    return;
                }
                
                const selectedGroupId = wordGroupSelect.value;
                const currentWordObj = filteredWords[currentIndex];
                const originalIndex = words.findIndex(w => w.word === currentWordObj.word);
                
                if (originalIndex !== -1) {
                    words[originalIndex].groupId = selectedGroupId || null;
                    currentWordObj.groupId = selectedGroupId || null;
                    
                    cacheWordsData();
                    updatePreviewPane();
                    
                    // 保存上次使用的分组
                    saveLastUsedGroup(selectedGroupId);
                    
                    addDebugLog(`已将单词 "${currentWordObj.word}" 分配到分组: ${selectedGroupId ? getGroupNameById(selectedGroupId) : '未分组'}`);
                }
            }
            
            // 更新预览筛选器
            function updatePreviewFilter() {
                previewGroupFilterValue = previewGroupFilter.value || null;
                
                // 临时按筛选器过滤预览
                const tempFilteredWords = words.filter(word => {
                    if (showOnlyFavorites && !word.favorite) {
                        return false;
                    }
                    
                    if (previewGroupFilterValue && word.groupId !== previewGroupFilterValue) {
                        return false;
                    }
                    
                    return true;
                });
                
                // 更新预览面板
                previewPane.innerHTML = '';
                
                tempFilteredWords.forEach((word, index) => {
                    const wordChip = document.createElement('div');
                    wordChip.className = 'word-chip';
                    wordChip.textContent = word.word;
                    
                    if (word.favorite) {
                        wordChip.classList.add('favorite');
                    }
                    
                    if (word.groupId) {
                        const groupIndicator = document.createElement('span');
                        groupIndicator.className = 'word-chip group-indicator';
                        groupIndicator.textContent = getGroupNameById(word.groupId);
                        groupIndicator.style.backgroundColor = getGroupColorById(word.groupId);
                        wordChip.appendChild(groupIndicator);
                    }
                    
                    // 添加删除按钮
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-word-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteWord(word.word);
                    });
                    wordChip.appendChild(deleteBtn);
                    
                    // 点击单词跳转到该单词
                    wordChip.addEventListener('click', () => {
                        // 找到单词在实际列表中的索引
                        const actualIndex = filteredWords.findIndex(w => w.word === word.word);
                        if (actualIndex !== -1) {
                            currentIndex = actualIndex;
                            displayCurrentWord();
                        }
                    });
                    
                    // 高亮当前单词
                    if (word.word === filteredWords[currentIndex]?.word) {
                        wordChip.classList.add('active');
                    }
                    
                    previewPane.appendChild(wordChip);
                });
                
                addDebugLog(`预览已按分组筛选: ${previewGroupFilterValue ? getGroupNameById(previewGroupFilterValue) : '所有分组'}`);
            }
            
            // 同步预览到播放列表
            function syncPreviewToPlayback() {
                // 获取当前预览筛选条件下的单词
                const tempFilteredWords = words.filter(word => {
                    if (showOnlyFavorites && !word.favorite) {
                        return false;
                    }
                    
                    if (previewGroupFilterValue && word.groupId !== previewGroupFilterValue) {
                        return false;
                    }
                    
                    return true;
                });
                
                // 更新实际播放列表
                filteredWords = tempFilteredWords;
                currentIndex = 0;
                displayCurrentWord();
                updatePreviewPane();
                
                addDebugLog(`已将预览列表同步到播放列表，共 ${filteredWords.length} 个单词`);
            }
            
            // 学生管理功能
            
            // 处理学生名单导入
            function handleStudentFileImport() {
                const file = studentFileInput.files[0];
                if (!file) {
                    customAlert('请先选择一个txt文件', 'warning');
                    addDebugLog('学生名单导入失败：未选择文件');
                    return;
                }
                
                addDebugLog('开始导入学生名单: ' + file.name);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    const newStudents = [];
                    
                    for (let line of lines) {
                        const studentName = line.trim();
                        if (studentName && !students.some(s => s.name === studentName)) {
                            newStudents.push({
                                name: studentName,
                                score: 0,
                                title: '新手'
                            });
                        }
                    }
                    
                    if (newStudents.length > 0) {
                        students.push(...newStudents);
                        cacheStudentData();
                        updateStudentList();
                        
                        customAlert(`成功导入 ${newStudents.length} 名学生`, 'success');
                        addDebugLog(`成功导入 ${newStudents.length} 名学生`);
                    } else {
                        customAlert('没有成功导入任何学生', 'info');
                        addDebugLog('没有成功导入任何学生');
                    }
                    
                    // 清空文件输入
                    studentFileInput.value = '';
                };
                
                reader.readAsText(file);
            }
            
            // 随机抽取学生
            function selectRandomStudent() {
                if (students.length === 0) {
                    customAlert('没有学生可抽取', 'info');
                    addDebugLog('随机抽取学生失败：学生名单为空');
                    return;
                }
                
                const randomIndex = Math.floor(Math.random() * students.length);
                currentStudent = students[randomIndex];
                
                updateCurrentStudentDisplay();
                showStudentDisplay();
                
                addDebugLog(`随机抽取学生: ${currentStudent.name}`);
            }
            
            // 清空所有学生
            function clearAllStudents() {
                if (students.length === 0) {
                    customAlert('当前没有学生', 'info');
                    return;
                }
                
                customConfirm('确定要清空所有学生吗？此操作不可恢复。', function() {
                    students = [];
                    currentStudent = null;
                    cacheStudentData();
                    updateStudentList();
                    updateCurrentStudentDisplay();
                    
                    addDebugLog('已清空所有学生');
                    customAlert('所有学生已清空', 'success');
                });
            }
            
            // 更新学生列表
            function updateStudentList() {
                studentList.innerHTML = '';
                
                students.forEach((student, index) => {
                    const studentItem = document.createElement('div');
                    studentItem.className = 'student-item';
                    studentItem.textContent = student.name;
                    
                    // 添加分数和称号徽章
                    const scoreBadge = document.createElement('span');
                    scoreBadge.className = 'student-score';
                    scoreBadge.textContent = student.score;
                    studentItem.appendChild(scoreBadge);
                    
                    const titleBadge = document.createElement('span');
                    titleBadge.className = 'student-title';
                    titleBadge.textContent = student.title;
                    studentItem.appendChild(titleBadge);
                    
                    // 点击学生选择该学生
                    studentItem.addEventListener('click', () => {
                        currentStudent = student;
                        updateCurrentStudentDisplay();
                        
                        addDebugLog(`已选择学生: ${student.name}`);
                    });
                    
                    // 高亮当前学生
                    if (currentStudent && student.name === currentStudent.name) {
                        studentItem.classList.add('selected');
                    }
                    
                    studentList.appendChild(studentItem);
                });
            }
            
            // 更新当前学生显示
            function updateCurrentStudentDisplay() {
                if (currentStudent) {
                    currentStudentDisplay.textContent = currentStudent.name;
                    studentScoreDisplay.textContent = `得分: ${currentStudent.score}`;
                    studentTitleDisplay.textContent = `称号: ${currentStudent.title}`;
                    
                    // 确保该学生有详细记录
                    if (!studentRecords[currentStudent.id]) {
                        studentRecords[currentStudent.id] = {
                            totalScore: currentStudent.score, // 使用学生总分作为初始值
                            totalCorrect: 0,
                            totalWrong: 0
                        };
                        // 缓存更新的数据
                        cacheScoreData();
                    }
                    
                    // 选择学生后立即更新成绩显示
                    updateScoreDisplay();
                } else {
                    currentStudentDisplay.textContent = '未选择';
                    studentScoreDisplay.textContent = '得分: 0';
                    studentTitleDisplay.textContent = '称号: 新手';
                    
                    // 没有选择学生时更新成绩显示（显示占位符）
                    updateScoreDisplay();
                }
            }
            
            // 播放学生抽取音效
            function playStudentSelectSound() {
                try {
                    // 从localStorage获取保存的音频数据
                    const audioData = localStorage.getItem('studentSelectSound');
                    
                    if (audioData) {
                        // 创建音频对象并播放
                        const audio = new Audio(audioData);
                        audio.play().catch(error => {
                            addDebugLog(`播放音效失败: ${error.message}`);
                        });
                    }
                } catch (error) {
                    addDebugLog(`播放音效异常: ${error.message}`);
                }
            }
            
            // 设置音频上传处理
            function setupAudioUpload() {
                const audioUpload = document.getElementById('studentSelectSound');
                const previewButton = document.getElementById('playSoundPreview');
                
                if (audioUpload && previewButton) {
                    // 处理音频文件上传
                    audioUpload.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file && file.type === 'audio/mpeg') {
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                // 保存音频数据到localStorage
                                localStorage.setItem('studentSelectSound', event.target.result);
                                customAlert('音效上传成功！', 'success');
                                addDebugLog('学生抽取音效已上传并保存');
                            };
                            reader.readAsDataURL(file);
                        } else if (file) {
                            customAlert('请上传MP3格式的音频文件', 'warning');
                        }
                    });
                    
                    // 预览音效按钮
                    previewButton.addEventListener('click', function() {
                        playStudentSelectSound();
                    });
                }
            }
            // 播放汽车人音效
            function playTransformerSound() {
                // 使用Web Speech API播放"Are you ready?"
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('Are you ready?');
                    // 设置声音参数，使其听起来更像汽车人
                    utterance.pitch = 0.8; // 降低音调
                    utterance.rate = 0.9;  // 稍微降低语速
                    utterance.volume = 1.0;
                    utterance.lang = 'en-US';
                    
                    // 选择一个更有力量感的声音（如果可用）
                    const voices = window.speechSynthesis.getVoices();
                    const maleVoice = voices.find(voice => 
                        voice.lang === 'en-US' && voice.name.includes('Fred')
                    );
                    if (maleVoice) {
                        utterance.voice = maleVoice;
                    }
                    
                    speechSynthesis.speak(utterance);
                }
            }
            
            // 显示学生信息大屏
            function showStudentDisplay() {
                if (!currentStudent) return;
                
                displayStudentName.textContent = currentStudent.name;
                displayStudentScore.textContent = `分数: ${currentStudent.score}`;
                displayStudentTitle.textContent = `称号: ${currentStudent.title}`;
                
                // 应用学生大屏背景颜色设置
                const settings = JSON.parse(localStorage.getItem('styleSettings') || '{}');
                if (settings.studentDisplayBackgroundColor) {
                    studentDisplay.style.background = settings.studentDisplayBackgroundColor;
                } else {
                    // 设置默认颜色
                    studentDisplay.style.background = '#4a90e2';
                }
                
                studentDisplay.classList.add('active');
                
                // 播放学生抽取音效
                playStudentSelectSound();
                
                // 显示学生信息
                setTimeout(() => {
                    studentDisplay.classList.remove('active');
                    // 学生大屏消失后，自动滚动到测验区域
                    setTimeout(() => {
                        const quizTabs = document.querySelector('.quiz-tabs');
                        if (quizTabs) {
                            // 调整滚动位置，使用更大的负偏移量确保完全不被遮挡
                            const yOffset = -150; // 大幅增加负偏移量
                            const y = quizTabs.getBoundingClientRect().top + window.pageYOffset + yOffset;
                            window.scrollTo({top: y, behavior: 'smooth'});
                        }
                    }, 500);
                }, 3000);
            }
            
            // 缓存学生数据到本地存储
            function cacheStudentData() {
                try {
                    localStorage.setItem('studentList', JSON.stringify(students));
                    addDebugLog(`已缓存 ${students.length} 名学生到本地存储`);
                } catch (error) {
                    addDebugLog(`缓存学生数据失败: ${error.message}`);
                }
            }
            
            // 从本地存储加载学生数据
            function loadStudentData() {
                try {
                    const cachedStudents = localStorage.getItem('studentList');
                    if (cachedStudents) {
                        students = JSON.parse(cachedStudents);
                        addDebugLog(`从本地存储加载了 ${students.length} 名学生`);
                    }
                } catch (error) {
                    addDebugLog(`加载学生数据失败: ${error.message}`);
                }
            }
            
            // 测验功能
            
            // 开始自然拼读测验
            function startPhonicsQuiz() {
                if (!currentStudent) {
                    customAlert('请先选择学生', 'warning');
                    return;
                }
                
                // 获取测验设置
                const selectedGroupId = quizGroupFilter.value;
                const wordCount = parseInt(quizWordCount.value);
                
                // 筛选单词
                let availableWords = words;
                
                if (selectedGroupId) {
                    availableWords = words.filter(word => word.groupId === selectedGroupId);
                }
                
                if (availableWords.length === 0) {
                    customAlert('没有符合条件的单词', 'info');
                    return;
                }
                
                // 随机选择单词
                quizWords = [];
                const shuffledWords = [...availableWords].sort(() => Math.random() - 0.5);
                
                for (let i = 0; i < Math.min(wordCount, shuffledWords.length); i++) {
                    quizWords.push(shuffledWords[i]);
                }
                
                // 重置测验状态
                currentQuizIndex = 0;
                isQuizActive = true;
                currentScore = 0;
                currentCorrect = 0;
                currentWrong = 0;
                
                // 更新显示
                updateScoreDisplay();
                
                // 开始第一个单词
                startNextPhonicsWord();
                
                addDebugLog(`开始自然拼读测验，共 ${quizWords.length} 个单词`);
            }
            
            // 开始下一个自然拼读单词
            function startNextPhonicsWord() {
                if (!isQuizActive || currentQuizIndex >= quizWords.length) {
                    endQuiz();
                    return;
                }
                
                const wordObj = quizWords[currentQuizIndex];
                phonicsCorrectWord = wordObj.word;
                
                // 显示单词信息
                phonicsPhonetic.textContent = wordObj.phonetic;
                // 根据用户设置决定是否显示音标
                if (showPhonicsPhoneticCheckbox) {
                    phonicsPhonetic.style.display = showPhonicsPhoneticCheckbox.checked ? 'block' : 'none';
                } else {
                    phonicsPhonetic.style.display = 'block'; // 默认显示
                }
                hintText.textContent = phonicsHints[Math.floor(Math.random() * phonicsHints.length)];
                
                // 显示图片
                if (wordObj.leftImageUrl && wordObj.leftImageUrl !== '未找到图片' && 
                    !wordObj.leftImageUrl.includes('失败') && 
                    wordObj.leftImageUrl !== '请先配置Pixabay API') {
                    phonicsImage1.src = wordObj.leftImageUrl;
                    phonicsImage1.style.display = 'block';
                } else {
                    phonicsImage1.style.display = 'none';
                }
                
                if (wordObj.rightImageUrl && wordObj.rightImageUrl !== '未找到图片' && 
                    !wordObj.rightImageUrl.includes('失败') && 
                    wordObj.rightImageUrl !== '请先配置Pixabay API') {
                    phonicsImage2.src = wordObj.rightImageUrl;
                    phonicsImage2.style.display = 'block';
                } else {
                    phonicsImage2.style.display = 'none';
                }
                
                // 创建拼写区域
                createPhonicsSpellingArea();
                
                // 创建字母选项
                createPhonicsLetterOptions();
                
                // 播放单词发音
                playPhonicsWord();
                
                addDebugLog(`自然拼读测验第 ${currentQuizIndex + 1} 题: ${wordObj.word}`);
            }
            
            // 创建自然拼读拼写区域
            function createPhonicsSpellingArea() {
                phonicsSpellingArea.innerHTML = '';
                phonicsSpellingSlots = [];
                
                // 根据单词长度创建空槽位
                for (let i = 0; i < phonicsCorrectWord.length; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'spelling-slot';
                    slot.dataset.index = i;
                    
                    // 点击槽位可移除字母
                    slot.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        if (phonicsSelectedLetters[index]) {
                            // 将字母放回选项区域
                            const letter = phonicsSelectedLetters[index];
                            const option = document.createElement('div');
                            option.className = 'letter-combination-option';
                            option.textContent = letter;
                            option.addEventListener('click', selectPhonicsLetter);
                            phonicsLetterOptions.appendChild(option);
                            
                            // 从已选字母中移除
                            phonicsSelectedLetters[index] = null;
                            slot.textContent = '';
                            slot.classList.remove('filled');
                        }
                    });
                    
                    phonicsSpellingArea.appendChild(slot);
                    phonicsSpellingSlots.push(slot);
                }
                
                phonicsSelectedLetters = new Array(phonicsCorrectWord.length).fill(null);
            }
            
            // 创建自然拼读字母选项
            function createPhonicsLetterOptions() {
                phonicsLetterOptions.innerHTML = '';
                phonicsLetterOptionsArray = [];
                
                // 分析单词中的字母组合
                const letterCombinations = analyzeWordForPhonics(phonicsCorrectWord);
                
                // 添加一些干扰项
                const distractors = generatePhonicsDistractors(letterCombinations);
                
                // 合并所有选项并随机排序
                const allOptions = [...letterCombinations, ...distractors].sort(() => Math.random() - 0.5);
                
                // 创建选项元素
                allOptions.forEach(combination => {
                    const option = document.createElement('div');
                    option.className = 'letter-combination-option';
                    option.textContent = combination;
                    option.addEventListener('click', selectPhonicsLetter);
                    phonicsLetterOptions.appendChild(option);
                    phonicsLetterOptionsArray.push(option);
                });
            }
            
            // 分析单词中的自然拼读组合
            function analyzeWordForPhonics(word) {
                const combinations = [];
                let i = 0;
                
                while (i < word.length) {
                    // 优先尝试匹配较长的组合
                    let found = false;
                    
                    // 检查三字母组合
                    if (i + 2 < word.length) {
                        const threeLetter = word.substring(i, i + 3);
                        if (phonicsPatterns.threeLetterBlends.includes(threeLetter) ||
                            phonicsPatterns.otherPatterns.includes(threeLetter)) {
                            combinations.push(threeLetter);
                            i += 3;
                            found = true;
                        }
                    }
                    
                    // 检查双字母组合
                    if (!found && i + 1 < word.length) {
                        const twoLetter = word.substring(i, i + 2);
                        if (phonicsPatterns.vowelTeams.includes(twoLetter) ||
                            phonicsPatterns.consonantBlends.includes(twoLetter) ||
                            phonicsPatterns.consonantDigraphs.includes(twoLetter) ||
                            phonicsPatterns.affixes.includes(twoLetter)) {
                            combinations.push(twoLetter);
                            i += 2;
                            found = true;
                        }
                    }
                    
                    // 单个字母
                    if (!found) {
                        combinations.push(word[i]);
                        i += 1;
                    }
                }
                
                return combinations;
            }
            
            // 生成自然拼读干扰项
            function generatePhonicsDistractors(correctCombinations) {
                const distractors = [];
                
                // 基于正确组合生成相似但不同的组合
                correctCombinations.forEach(combination => {
                    if (combination.length === 1) {
                        // 对于单个字母，添加相似的字母
                        const similarLetters = getSimilarLetters(combination);
                        distractors.push(...similarLetters);
                    } else if (combination.length === 2) {
                        // 对于双字母组合，添加相似的组合
                        const similarCombinations = getSimilarCombinations(combination);
                        distractors.push(...similarCombinations);
                    } else if (combination.length === 3) {
                        // 对于三字母组合，添加相似的组合
                        const similarCombinations = getSimilarCombinations(combination);
                        distractors.push(...similarCombinations);
                    }
                });
                
                // 添加一些随机组合
                const allPatterns = [
                    ...phonicsPatterns.vowelTeams,
                    ...phonicsPatterns.consonantBlends,
                    ...phonicsPatterns.consonantDigraphs,
                    ...phonicsPatterns.threeLetterBlends,
                    ...phonicsPatterns.otherPatterns,
                    ...phonicsPatterns.affixes
                ];
                
                for (let i = 0; i < 5; i++) {
                    const randomPattern = allPatterns[Math.floor(Math.random() * allPatterns.length)];
                    if (!correctCombinations.includes(randomPattern) && !distractors.includes(randomPattern)) {
                        distractors.push(randomPattern);
                    }
                }
                
                return [...new Set(distractors)]; // 去重
            }
            
            // 获取相似的字母
            function getSimilarLetters(letter) {
                const similarMap = {
                    'a': ['e', 'i', 'o'],
                    'e': ['a', 'i', 'o'],
                    'i': ['a', 'e', 'o'],
                    'o': ['a', 'e', 'i'],
                    'u': ['o', 'a'],
                    'b': ['d', 'p'],
                    'd': ['b', 'p'],
                    'p': ['b', 'd'],
                    'm': ['n'],
                    'n': ['m']
                };
                
                return similarMap[letter] || [];
            }
            
            // 获取相似的字母组合
            function getSimilarCombinations(combination) {
                const similarMap = {
                    'ai': ['ay', 'ei', 'ey'],
                    'ay': ['ai', 'ei', 'ey'],
                    'ee': ['ea', 'ie'],
                    'ea': ['ee', 'ie'],
                    'ie': ['ee', 'ea'],
                    'oa': ['oe', 'ow'],
                    'oe': ['oa', 'ow'],
                    'ue': ['ui', 'ew'],
                    'ui': ['ue', 'ew'],
                    'oo': ['ou', 'ow'],
                    'ou': ['oo', 'ow'],
                    'ow': ['ou', 'oo'],
                    'ch': ['sh', 'th'],
                    'sh': ['ch', 'th'],
                    'th': ['ch', 'sh'],
                    'bl': ['br', 'cl', 'fl'],
                    'br': ['bl', 'cr', 'fr'],
                    'cl': ['bl', 'cr', 'fl'],
                    'cr': ['br', 'cl', 'fr'],
                    'dr': ['tr', 'gr'],
                    'fl': ['bl', 'cl', 'fr'],
                    'fr': ['br', 'cr', 'fl'],
                    'gl': ['gr', 'cl'],
                    'gr': ['dr', 'gl', 'tr'],
                    'pl': ['pr', 'bl'],
                    'pr': ['pl', 'br'],
                    'sc': ['sk', 'sl'],
                    'sk': ['sc', 'sl'],
                    'sl': ['sc', 'sk'],
                    'sm': ['sn', 'sw'],
                    'sn': ['sm', 'sw'],
                    'sp': ['st', 'sk'],
                    'st': ['sp', 'sk'],
                    'sw': ['sm', 'sn'],
                    'tr': ['dr', 'gr'],
                    'tw': ['tr', 'sw']
                };
                
                return similarMap[combination] || [];
            }
            
            // 选择自然拼读字母
            function selectPhonicsLetter(e) {
                if (!isQuizActive) return;
                
                const selectedCombination = e.target.textContent;
                
                // 找到第一个空槽位
                const emptySlotIndex = phonicsSelectedLetters.findIndex(letter => letter === null);
                
                if (emptySlotIndex !== -1) {
                    // 将字母放入槽位
                    phonicsSelectedLetters[emptySlotIndex] = selectedCombination;
                    phonicsSpellingSlots[emptySlotIndex].textContent = selectedCombination;
                    phonicsSpellingSlots[emptySlotIndex].classList.add('filled');
                    
                    // 从选项区域移除该选项
                    e.target.remove();
                    
                    // 检查是否所有槽位都已填满
                    checkIfPhonicsComplete();
                }
            }
            
            // 检查自然拼读答案是否完成
            function checkIfPhonicsComplete() {
                const isComplete = phonicsSelectedLetters.every(letter => letter !== null);
                
                if (isComplete) {
                    // 自动检查答案
                    setTimeout(checkPhonicsAnswer, 500);
                }
            }
            
            // 播放自然拼读单词发音
            function playPhonicsWord() {
                if (!isQuizActive || currentQuizIndex >= quizWords.length) return;
                
                const wordObj = quizWords[currentQuizIndex];
                
                // 播放两遍
                speakWord(wordObj.word);
                setTimeout(() => {
                    speakWord(wordObj.word);
                }, 1000);
                
                addDebugLog(`播放自然拼读单词发音: ${wordObj.word}`);
            }
            
            // 清空自然拼读答案
            function clearPhonicsAnswer() {
                if (!isQuizActive) return;
                
                // 清空已选字母
                phonicsSelectedLetters.fill(null);
                
                // 清空拼写区域
                phonicsSpellingSlots.forEach(slot => {
                    slot.textContent = '';
                    slot.classList.remove('filled');
                });
                
                // 恢复所有选项
                phonicsLetterOptions.innerHTML = '';
                phonicsLetterOptionsArray.forEach(option => {
                    phonicsLetterOptions.appendChild(option);
                });
                
                addDebugLog('已清空自然拼读答案');
            }
            
            // 检查自然拼读答案
            function checkPhonicsAnswer() {
                if (!isQuizActive) return;
                
                const userAnswer = phonicsSelectedLetters.join('');
                const isCorrect = userAnswer === phonicsCorrectWord;
                
                // 显示结果
                showQuizResult(isCorrect, quizWords[currentQuizIndex]);
                
                // 更新分数
                if (isCorrect) {
                    currentScore += 10;
                    currentCorrect++;
                } else {
                    currentWrong++;
                }
                
                // 如果有当前学生，实时更新其累计成绩记录
                if (currentStudent) {
                    // 确保该学生有详细记录
                    if (!studentRecords[currentStudent.id]) {
                        studentRecords[currentStudent.id] = {
                            totalScore: 0,
                            totalCorrect: 0,
                            totalWrong: 0
                        };
                    }
                    
                    // 临时保存本次测验的累计变化
                    // 注意：最终实际累计值会在endQuiz中更新，这里只是为了实时显示
                    studentRecords[currentStudent.id].tempScore = currentScore;
                    studentRecords[currentStudent.id].tempCorrect = currentCorrect;
                    studentRecords[currentStudent.id].tempWrong = currentWrong;
                }
                
                // 更新显示
                updateScoreDisplay();
                
                // 移除自动跳转到下一题的逻辑，改为由继续按钮控制
                
                addDebugLog(`自然拼读答案检查: ${isCorrect ? '正确' : '错误'}, 用户答案: ${userAnswer}, 正确答案: ${phonicsCorrectWord}`);
            }
            
            // 开始听力测试
            function startListeningQuiz() {
                if (!currentStudent) {
                    customAlert('请先选择学生', 'warning');
                    return;
                }
                
                // 获取测验设置
                const selectedGroupId = quizGroupFilter.value;
                const wordCount = parseInt(quizWordCount.value);
                
                // 筛选单词
                let availableWords = words;
                
                if (selectedGroupId) {
                    availableWords = words.filter(word => word.groupId === selectedGroupId);
                }
                
                if (availableWords.length === 0) {
                    customAlert('没有符合条件的单词', 'info');
                    return;
                }
                
                // 随机选择单词
                quizWords = [];
                const shuffledWords = [...availableWords].sort(() => Math.random() - 0.5);
                
                for (let i = 0; i < Math.min(wordCount, shuffledWords.length); i++) {
                    quizWords.push(shuffledWords[i]);
                }
                
                // 重置测验状态
                currentQuizIndex = 0;
                isQuizActive = true;
                currentScore = 0;
                currentCorrect = 0;
                currentWrong = 0;
                
                // 更新显示
                updateScoreDisplay();
                
                // 开始第一个单词
                startNextListeningWord();
                
                addDebugLog(`开始听力测试，共 ${quizWords.length} 个单词`);
            }
            
            // 开始下一个听力测试单词
            function startNextListeningWord() {
                if (!isQuizActive || currentQuizIndex >= quizWords.length) {
                    endQuiz();
                    return;
                }
                
                const wordObj = quizWords[currentQuizIndex];
                
                // 显示音标
                listeningPhonetic.textContent = wordObj.phonetic;
                // 根据用户设置决定是否显示大屏音标
                if (showListeningPhoneticCheckbox) {
                    listeningPhonetic.style.display = showListeningPhoneticCheckbox.checked ? 'block' : 'none';
                } else {
                    listeningPhonetic.style.display = 'block'; // 默认显示
                }
                
                // 创建答案选项
                createListeningOptions(wordObj);
                
                // 播放单词发音
                playListeningWord();
                
                addDebugLog(`听力测试第 ${currentQuizIndex + 1} 题: ${wordObj.word}`);
            }
            
            // 创建听力测试选项
            function createListeningOptions(correctWordObj) {
                answerOptions.innerHTML = '';
                
                // 创建选项数组（包含正确答案和干扰项）
                const options = [correctWordObj];
                
                // 添加3个干扰项
                const otherWords = words.filter(word => 
                    word.word !== correctWordObj.word && 
                    (!quizGroupFilter.value || word.groupId === quizGroupFilter.value)
                );
                
                const shuffledOtherWords = [...otherWords].sort(() => Math.random() - 0.5);
                for (let i = 0; i < 3 && i < shuffledOtherWords.length; i++) {
                    options.push(shuffledOtherWords[i]);
                }
                
                // 随机排序选项
                const shuffledOptions = [...options].sort(() => Math.random() - 0.5);
                
                // 创建选项元素
                shuffledOptions.forEach(option => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'answer-option';
                    
                    // 根据显示选项设置内容
                    let optionContent = '';
                    if (showEnglishCheckbox.checked) {
                        optionContent += `<div class="option-word"><strong>${option.word}</strong></div>`;
                    }
                    if (showPhoneticCheckbox.checked) {
                        optionContent += `<div class="option-phonetic">${option.phonetic}</div>`;
                    }
                    if (showChineseCheckbox.checked) {
                        optionContent += `<div class="option-chinese">${option.chinese}</div>`;
                    }
                    
                    optionElement.innerHTML = optionContent;
                    
                    // 添加点击事件
                    optionElement.addEventListener('click', function() {
                        // 移除所有选项的选中状态
                        document.querySelectorAll('.answer-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        
                        // 选中当前选项
                        this.classList.add('selected');
                        
                        // 检查答案
                        const isCorrect = option.word === correctWordObj.word;
                        showQuizResult(isCorrect, correctWordObj);
                        
                        // 更新分数
                        if (isCorrect) {
                            currentScore += 10;
                            currentCorrect++;
                        } else {
                            currentWrong++;
                        }
                        
                        // 如果有当前学生，实时更新其累计成绩记录
                        if (currentStudent) {
                            // 确保该学生有详细记录
                            if (!studentRecords[currentStudent.id]) {
                                studentRecords[currentStudent.id] = {
                                    totalScore: 0,
                                    totalCorrect: 0,
                                    totalWrong: 0
                                };
                            }
                            
                            // 临时保存本次测验的累计变化
                            // 注意：最终实际累计值会在endQuiz中更新，这里只是为了实时显示
                            studentRecords[currentStudent.id].tempScore = currentScore;
                            studentRecords[currentStudent.id].tempCorrect = currentCorrect;
                            studentRecords[currentStudent.id].tempWrong = currentWrong;
                        }
                        
                        // 更新显示
                        updateScoreDisplay();
                        
                        // 移除自动跳转到下一题的逻辑，改为由继续按钮控制
                        
                        addDebugLog(`听力测试答案检查: ${isCorrect ? '正确' : '错误'}, 用户选择: ${option.word}, 正确答案: ${correctWordObj.word}`);
                    });
                    
                    answerOptions.appendChild(optionElement);
                });
            }
            
            // 播放听力测试单词发音
            function playListeningWord() {
                if (!isQuizActive || currentQuizIndex >= quizWords.length) return;
                
                const wordObj = quizWords[currentQuizIndex];
                
                // 播放两遍
                speakWord(wordObj.word);
                setTimeout(() => {
                    speakWord(wordObj.word);
                }, 1000);
                
                addDebugLog(`播放听力测试单词发音: ${wordObj.word}`);
            }
            
            // 显示测验结果
            function showQuizResult(isCorrect, wordObj) {
                // 创建结果弹窗
                const resultDiv = document.createElement('div');
                resultDiv.className = 'quiz-result';
                
                if (isCorrect) {
                    resultDiv.innerHTML = `
                        <div class="correct-feedback">✓ 正确！</div>
                        <div class="word-display">${wordObj.word}</div>
                        <div class="phonetic-display">${wordObj.phonetic}</div>
                        <div class="chinese-display">${wordObj.chinese}</div>
                        <button class="next-button">继续</button>
                    `;
                    
                    // 添加庆祝效果
                    createConfetti();
                    
                    // 添加全屏烟花特效和NICE语音
                    createFireworksEffect();
                } else {
                    resultDiv.innerHTML = `
                        <div class="error-feedback">✗ 错误</div>
                        <div class="word-display">正确答案: ${wordObj.word}</div>
                        <div class="phonetic-display">${wordObj.phonetic}</div>
                        <div class="chinese-display">${wordObj.chinese}</div>
                        <button class="next-button">继续</button>
                    `;
                    
                    // 添加全屏闪红特效和COME ON, BABY!语音
                    createRedFlashEffect();
                }
                
                // 添加到显示区域
                const displayArea = currentQuizType === 'phonics' ? phonicsDisplay : listeningDisplay;
                displayArea.appendChild(resultDiv);
                
                // 点击继续按钮移除结果并跳转到下一题
                resultDiv.querySelector('.next-button').addEventListener('click', function() {
                    resultDiv.remove();
                    
                    // 跳转到下一题
                    currentQuizIndex++;
                    
                    // 根据测验类型进入下一题
                    if (currentQuizType === 'phonics') {
                        startNextPhonicsWord();
                    } else if (currentQuizType === 'listening') {
                        startNextListeningWord();
                    }
                });
            }
            
            // 创建庆祝彩花效果
            function createConfetti() {
                const colors = ['#4a90e2', '#5cb85c', '#f0ad4e', '#d9534f', '#9b59b6'];
                
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    
                    document.body.appendChild(confetti);
                    
                    // 动画结束后移除元素
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }
            }
            
            // 播放音效
            function playSound(type) {
                // 使用Web Audio API创建音效
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) {
                    console.log('浏览器不支持Web Audio API');
                    return;
                }
                
                const audioContext = new AudioContext();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // 连接节点
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'success') {
                    // 愉快音效 - 上升的音调序列
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
                    oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.3); // A5
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);
                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.6);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.6);
                    
                    // 添加第二个音符增加愉快感
                    setTimeout(() => {
                        const oscillator2 = audioContext.createOscillator();
                        const gainNode2 = audioContext.createGain();
                        
                        oscillator2.connect(gainNode2);
                        gainNode2.connect(audioContext.destination);
                        
                        oscillator2.type = 'sine';
                        oscillator2.frequency.setValueAtTime(660, audioContext.currentTime); // E5
                        oscillator2.frequency.exponentialRampToValueAtTime(1320, audioContext.currentTime + 0.3); // E6
                        
                        gainNode2.gain.setValueAtTime(0, audioContext.currentTime);
                        gainNode2.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);
                        gainNode2.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.6);
                        
                        oscillator2.start(audioContext.currentTime);
                        oscillator2.stop(audioContext.currentTime + 0.6);
                    }, 300);
                } else if (type === 'error') {
                    // 失败音效 - 下降的音调
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(660, audioContext.currentTime); // E5
                    oscillator.frequency.exponentialRampToValueAtTime(110, audioContext.currentTime + 0.5); // A2
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);
                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.6);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.6);
                }
            }
            
            // 创建全屏烟花特效
            function createFireworksEffect() {
                const overlay = document.createElement('div');
                overlay.className = 'fullscreen-overlay fireworks-container';
                document.body.appendChild(overlay);
                
                // 延迟激活覆盖层
                setTimeout(() => {
                    overlay.classList.add('active');
                }, 10);
                
                // 创建星空背景
                createStarBackground(overlay);
                
                // 创建多个烟花
                // 使用更丰富的颜色
                const colors = [
                    '#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', 
                    '#448AFF', '#40C4FF', '#18FFFF', '#64FFDA', '#69F0AE', 
                    '#B2FF59', '#EEFF41', '#FFFF00', '#FFD740', '#FFAB40', 
                    '#FF6E40', '#8D6E63', '#90A4AE', '#FFFFFF'
                ];
                
                // 增加烟花数量，增强效果
                const fireworkCount = 30;
                
                // 创建更多烟花，使用不同的时间间隔
                for (let i = 0; i < fireworkCount; i++) {
                    setTimeout(() => {
                        createSingleFirework(overlay, colors);
                    }, i * 150);
                }
                
                // 播放愉快音效
                playSound('success');
                
                // 3秒后移除覆盖层
                setTimeout(() => {
                    overlay.classList.remove('active');
                    setTimeout(() => {
                        overlay.remove();
                    }, 300);
                }, 3000);
            }
            
            // 创建星空背景
            function createStarBackground(container) {
                // 创建50个星星
                for (let i = 0; i < 50; i++) {
                    const star = document.createElement('div');
                    star.className = 'firework-star';
                    
                    // 随机位置
                    star.style.left = Math.random() * 100 + 'vw';
                    star.style.top = Math.random() * 100 + 'vh';
                    
                    // 随机大小 2-5px
                    const size = Math.random() * 3 + 2;
                    star.style.width = size + 'px';
                    star.style.height = size + 'px';
                    
                    // 随机闪烁延迟
                    star.style.animationDelay = Math.random() * 2 + 's';
                    
                    container.appendChild(star);
                }
            }
            
            // 创建单个烟花爆炸 - 使用粒子系统模拟真实爆炸
            function createSingleFirework(container, colors) {
                // 随机位置
                const x = Math.random() * 100;
                const y = Math.random() * 70 + 10;
                
                // 选择主色调和次要色调
                const mainColor = colors[Math.floor(Math.random() * colors.length)];
                const secondaryColor = colors[Math.floor(Math.random() * colors.length)];
                
                // 确定爆炸类型 (普通圆形、星形、放射形、不规则形)
                const explosionTypes = ['circular', 'star', 'radiant', 'irregular'];
                const explosionType = explosionTypes[Math.floor(Math.random() * explosionTypes.length)];
                
                // 根据爆炸类型确定粒子数量
                let particleCount;
                switch (explosionType) {
                    case 'circular':
                        particleCount = 100;
                        break;
                    case 'star':
                        particleCount = 150;
                        break;
                    case 'radiant':
                        particleCount = 80;
                        break;
                    case 'irregular':
                    default:
                        particleCount = 120;
                }
                
                // 创建爆炸中心
                const center = {
                    x: x + 'vw',
                    y: y + 'vh'
                };
                
                // 生成粒子
                for (let i = 0; i < particleCount; i++) {
                    // 随机角度
                    let angle = (Math.PI * 2 * i) / particleCount;
                    
                    // 对于星形爆炸，模拟星形的突出角度
                    if (explosionType === 'star') {
                        const starPoints = 8;
                        const j = i % starPoints;
                        if (j > 0) {
                            // 对于非星点位置，使用较小的距离
                            const offset = Math.PI / starPoints;
                            angle += (Math.random() - 0.5) * offset * 0.8;
                        }
                    }
                    
                    // 对于不规则爆炸，添加随机角度偏移
                    if (explosionType === 'irregular') {
                        angle += (Math.random() - 0.5) * 0.5;
                    }
                    
                    // 根据爆炸类型确定粒子距离范围
                    let distance;
                    switch (explosionType) {
                        case 'circular':
                            distance = Math.random() * 80 + 50; // 50-130px
                            break;
                        case 'star':
                            distance = (i % 8 === 0) ? 
                                Math.random() * 100 + 80 : // 星点更远 80-180px
                                Math.random() * 40 + 20;   // 非星点更近 20-60px
                            break;
                        case 'radiant':
                            distance = Math.random() * 150 + 30; // 30-180px
                            break;
                        case 'irregular':
                        default:
                            distance = Math.random() * 100 + 40; // 40-140px
                    }
                    
                    // 计算终点位置
                    const endX = Math.cos(angle) * distance;
                    const endY = Math.sin(angle) * distance;
                    
                    // 创建粒子
                    const particle = document.createElement('div');
                    particle.className = 'firework-particle';
                    
                    // 设置粒子样式
                    particle.style.left = center.x;
                    particle.style.top = center.y;
                    particle.style.transform = 'translate(-50%, -50%)';
                    
                    // 随机粒子大小
                    const particleSize = Math.random() * 4 + 1; // 1-5px
                    particle.style.width = particleSize + 'px';
                    particle.style.height = particleSize + 'px';
                    
                    // 设置粒子颜色 - 使用主色或次要色，增加变化
                    const colorChoice = Math.random() > 0.3 ? mainColor : secondaryColor;
                    particle.style.backgroundColor = colorChoice;
                    
                    // 添加发光效果增强视觉冲击力
                    particle.style.boxShadow = `0 0 ${particleSize * 2}px ${particleSize}px ${colorChoice}`;
                    
                    // 设置CSS变量用于动画
                    particle.style.setProperty('--end-x', endX + 'px');
                    particle.style.setProperty('--end-y', endY + 'px');
                    
                    // 设置动画持续时间（随机）
                    const animationDuration = Math.random() * 1 + 1; // 1-2秒
                    particle.style.animation = `firework-explode ${animationDuration}s ease-out forwards`;
                    
                    // 随机动画延迟，使爆炸看起来更自然
                    particle.style.animationDelay = Math.random() * 0.3 + 's';
                    
                    // 添加粒子到容器
                    container.appendChild(particle);
                    
                    // 动画结束后移除粒子
                    setTimeout(() => {
                        particle.remove();
                    }, (animationDuration + 0.3) * 1000);
                    
                    // 对于放射形爆炸，添加尾随轨迹
                    if (explosionType === 'radiant' && Math.random() > 0.5) {
                        setTimeout(() => {
                            createParticleTrail(container, center.x, center.y, angle, colorChoice, distance * 0.6);
                        }, 200 + Math.random() * 300);
                    }
                }
            }
            
            // 创建粒子轨迹效果
            function createParticleTrail(container, x, y, angle, color, maxDistance) {
                const trailParticle = document.createElement('div');
                trailParticle.className = 'firework-particle';
                
                trailParticle.style.left = x;
                trailParticle.style.top = y;
                trailParticle.style.transform = 'translate(-50%, -50%)';
                trailParticle.style.width = '2px';
                trailParticle.style.height = '2px';
                trailParticle.style.backgroundColor = color;
                trailParticle.style.opacity = '0.7';
                
                // 计算终点位置
                const endX = Math.cos(angle) * maxDistance;
                const endY = Math.sin(angle) * maxDistance;
                
                trailParticle.style.setProperty('--end-x', endX + 'px');
                trailParticle.style.setProperty('--end-y', endY + 'px');
                
                // 轨迹速度稍快
                const duration = Math.random() * 0.5 + 0.5;
                trailParticle.style.animation = `firework-explode ${duration}s linear forwards`;
                
                container.appendChild(trailParticle);
                
                setTimeout(() => {
                    trailParticle.remove();
                }, duration * 1000);
            }
            
            // 创建全屏闪红特效
            function createRedFlashEffect() {
                const overlay = document.createElement('div');
                overlay.className = 'fullscreen-overlay red-flash-container';
                document.body.appendChild(overlay);
                
                // 延迟激活覆盖层和闪烁动画
                setTimeout(() => {
                    overlay.classList.add('active');
                }, 10);
                
                // 播放失败音效
                playSound('error');
                
                // 2秒后移除覆盖层
                setTimeout(() => {
                    overlay.classList.remove('active');
                    setTimeout(() => {
                        overlay.remove();
                    }, 300);
                }, 2000);
            }
            
            // 显示全屏称号晋升提示
            function showTitlePromotionAlert(titleName) {
                // 创建全屏覆盖层
                const overlay = document.createElement('div');
                overlay.className = 'title-promotion-overlay';
                overlay.innerHTML = `
                    <div class="title-promotion-content">
                        <div class="title-promotion-text">恭喜你晋升为</div>
                        <div class="title-name">${titleName}</div>
                        <div class="title-promotion-subtitle">继续努力！</div>
                    </div>
                `;
                
                // 添加样式
                const style = document.createElement('style');
                style.textContent = `
                    /* 确保覆盖层在最顶层 */
                    .title-promotion-overlay {
                        position: fixed;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100vw !important;
                        height: 100vh !important;
                        background: linear-gradient(135deg, rgba(74, 144, 226, 0.95), rgba(92, 184, 92, 0.95)) !important;
                        display: flex !important;
                        justify-content: center !important;
                        align-items: center !important;
                        z-index: 999999 !important;
                        overflow: hidden !important;
                        margin: 0 !important;
                        padding: 0 !important;
                        border: none !important;
                        box-shadow: none !important;
                    }
                    
                    .title-promotion-content {
                        text-align: center !important;
                        padding: 60px 40px !important;
                        border-radius: 20px !important;
                        background: rgba(255, 255, 255, 0.98) !important;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
                        animation: titlePromotionAppear 0.8s ease-out !important;
                        max-width: 90% !important;
                        min-width: 300px !important;
                    }
                    
                    .title-promotion-text {
                        font-size: 3rem !important;
                        font-weight: bold !important;
                        color: #2c3e50 !important;
                        margin-bottom: 30px !important;
                        line-height: 1.2 !important;
                    }
                    
                    .title-name {
                        color: #e74c3c !important;
                        font-size: 5rem !important;
                        font-weight: bold !important;
                        margin-bottom: 30px !important;
                        animation: titleNameGlow 1.5s ease-in-out infinite alternate !important;
                        text-shadow: 0 0 30px rgba(231, 76, 60, 0.6) !important;
                    }
                    
                    .title-promotion-subtitle {
                        font-size: 2.5rem !important;
                        color: #3498db !important;
                        font-weight: bold !important;
                    }
                    
                    @keyframes titlePromotionAppear {
                        from {
                            opacity: 0;
                            transform: scale(0.3);
                        }
                        70% {
                            transform: scale(1.1);
                        }
                        to {
                            opacity: 1;
                            transform: scale(1);
                        }
                    }
                    
                    @keyframes titleNameGlow {
                        from {
                            text-shadow: 0 0 20px #e74c3c, 0 0 40px #e74c3c, 0 0 60px #e74c3c;
                        }
                        to {
                            text-shadow: 0 0 30px #e74c3c, 0 0 60px #e74c3c, 0 0 90px #e74c3c, 0 0 120px #e74c3c;
                        }
                    }
                `;
                
                // 强制添加到body的末尾
                document.body.appendChild(style);
                document.body.appendChild(overlay);
                
                // 确保元素可见
                overlay.style.display = 'flex';
                
                // 播放成功音效
                try {
                    playSound('success');
                } catch (e) {
                    console.log('播放音效失败:', e);
                }
                
                // 5秒后开始淡化消失
                setTimeout(() => {
                    overlay.style.transition = 'opacity 0.8s ease';
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        try {
                            document.body.removeChild(overlay);
                            document.body.removeChild(style);
                        } catch (e) {
                            console.log('移除元素失败:', e);
                        }
                    }, 800);
                }, 5000);
                
                // 添加调试日志
                console.log('称号晋升提示已显示:', titleName);
            }
            
            // 结束测验
            function endQuiz() {
                isQuizActive = false;
                
                // 更新学生成绩
                if (currentStudent) {
                    const studentIndex = students.findIndex(s => s.name === currentStudent.name);
                    if (studentIndex !== -1) {
                        // 保存旧称号，确保有默认值
                        const oldTitle = students[studentIndex].title || '新手';
                        
                        // 更新学生总分
                        students[studentIndex].score += currentScore;
                        
                        // 更新称号
                        const newTitle = getTitleByScore(students[studentIndex].score);
                        students[studentIndex].title = newTitle;
                        
                        // 检查称号是否发生变化，如果是则显示晋升提示
                        if (oldTitle !== newTitle) {
                            console.log(`称号变化: ${oldTitle} -> ${newTitle}`);
                            showTitlePromotionAlert(newTitle);
                        }
                        
                        // 更新全局总成绩
                        totalScore += currentScore;
                        totalCorrect += currentCorrect;
                        totalWrong += currentWrong;
                        
                        // 更新学生的详细记录（包含累计得分、正确和错误次数）
                        if (!studentRecords[currentStudent.id]) {
                            studentRecords[currentStudent.id] = {
                                totalScore: 0,
                                totalCorrect: 0,
                                totalWrong: 0
                            };
                        }
                        
                        studentRecords[currentStudent.id].totalScore += currentScore;
                        studentRecords[currentStudent.id].totalCorrect += currentCorrect;
                        studentRecords[currentStudent.id].totalWrong += currentWrong;
                        
                        // 保存数据
                        cacheStudentData();
                        cacheScoreData();
                        
                        // 更新显示
                        updateStudentList();
                        updateCurrentStudentDisplay();
                        updateScoreDisplay();
                        
                        // 显示最终结果 - 使用CSS卡片样式
                        showFinalResultCard(currentScore, currentCorrect, currentWrong, students[studentIndex].score, newTitle);
                        
                        addDebugLog(`测验结束，学生 ${currentStudent.name} 得分: ${currentScore}, 正确: ${currentCorrect}, 错误: ${currentWrong}`);
                    }
                }
            }
            
            // 显示最终结果卡片
            function showFinalResultCard(currentScore, currentCorrect, currentWrong, totalScore, title) {
                // 创建背景遮罩层
                const overlay = document.createElement('div');
                overlay.className = 'result-overlay';
                overlay.innerHTML = `
                    <div class="result-card">
                        <div class="result-header">
                            <h2>测验结束！</h2>
                            <button class="close-button">×</button>
                        </div>
                        <div class="result-content">
                            <div class="result-item">
                                <span class="result-label">本次得分：</span>
                                <span class="result-value score-value">${currentScore}</span>
                            </div>
                            <div class="result-stats">
                                <div class="stat-item correct">
                                    <div class="stat-icon">✓</div>
                                    <div class="stat-value">${currentCorrect}</div>
                                    <div class="stat-label">正确</div>
                                </div>
                                <div class="stat-item wrong">
                                    <div class="stat-icon">✗</div>
                                    <div class="stat-value">${currentWrong}</div>
                                    <div class="stat-label">错误</div>
                                </div>
                                <div class="stat-item total">
                                    <div class="stat-icon">🏆</div>
                                    <div class="stat-value">${totalScore}</div>
                                    <div class="stat-label">总分</div>
                                </div>
                            </div>
                            <div class="title-container">
                                <div class="title-label">当前称号：</div>
                                <div class="title-badge">${title}</div>
                            </div>
                        </div>
                        <div class="result-footer">
                            <button class="primary-button">确定</button>
                        </div>
                    </div>
                `;
                
                // 添加样式
                const style = document.createElement('style');
                style.textContent = `
                    .result-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: rgba(0, 0, 0, 0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                        animation: fadeIn 0.3s ease-out;
                    }
                    
                    .result-card {
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                        width: 90%;
                        max-width: 400px;
                        overflow: hidden;
                        animation: slideUp 0.4s ease-out;
                    }
                    
                    .result-header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 20px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    
                    .result-header h2 {
                        margin: 0;
                        font-size: 20px;
                        font-weight: 600;
                    }
                    
                    .close-button {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 28px;
                        cursor: pointer;
                        padding: 0;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: background-color 0.2s;
                    }
                    
                    .close-button:hover {
                        background-color: rgba(255, 255, 255, 0.2);
                    }
                    
                    .result-content {
                        padding: 24px;
                    }
                    
                    .result-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    }
                    
                    .result-label {
                        font-size: 16px;
                        color: #333;
                    }
                    
                    .result-value {
                        font-size: 20px;
                        font-weight: 600;
                        color: #444;
                    }
                    
                    .score-value {
                        font-size: 32px;
                        color: #667eea;
                        font-weight: 700;
                    }
                    
                    .result-stats {
                        display: flex;
                        justify-content: space-between;
                        margin: 24px 0;
                    }
                    
                    .stat-item {
                        flex: 1;
                        text-align: center;
                        padding: 16px 8px;
                        border-radius: 12px;
                        background-color: #f8f9fa;
                        margin: 0 4px;
                    }
                    
                    .stat-item.correct {
                        border: 2px solid #28a745;
                        background-color: rgba(40, 167, 69, 0.1);
                    }
                    
                    .stat-item.wrong {
                        border: 2px solid #dc3545;
                        background-color: rgba(220, 53, 69, 0.1);
                    }
                    
                    .stat-item.total {
                        border: 2px solid #ffc107;
                        background-color: rgba(255, 193, 7, 0.1);
                    }
                    
                    .stat-icon {
                        font-size: 20px;
                        margin-bottom: 8px;
                    }
                    
                    .stat-value {
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 4px;
                    }
                    
                    .stat-label {
                        font-size: 14px;
                        color: #666;
                    }
                    
                    .title-container {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 24px 0;
                    }
                    
                    .title-label {
                        font-size: 16px;
                        color: #333;
                        margin-right: 12px;
                    }
                    
                    .title-badge {
                        background: linear-gradient(135deg, #ff6b6b, #ffa502);
                        color: white;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-size: 16px;
                        font-weight: 600;
                        box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
                    }
                    
                    .result-footer {
                        padding: 0 24px 24px;
                    }
                    
                    .primary-button {
                        width: 100%;
                        padding: 12px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: transform 0.2s, box-shadow 0.2s;
                    }
                    
                    .primary-button:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
                    }
                    
                    .primary-button:active {
                        transform: translateY(0);
                    }
                    
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes slideUp {
                        from {
                            opacity: 0;
                            transform: translateY(50px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                `;
                
                // 添加到页面
                document.head.appendChild(style);
                document.body.appendChild(overlay);
                
                // 添加关闭功能
                const closeButton = overlay.querySelector('.close-button');
                const confirmButton = overlay.querySelector('.primary-button');
                
                const closeCard = () => {
                    overlay.style.animation = 'fadeOut 0.3s ease-out forwards';
                    const card = overlay.querySelector('.result-card');
                    card.style.animation = 'slideDown 0.3s ease-out forwards';
                    
                    setTimeout(() => {
                        document.body.removeChild(overlay);
                        document.head.removeChild(style);
                    }, 300);
                };
                
                closeButton.addEventListener('click', closeCard);
                confirmButton.addEventListener('click', closeCard);
                
                // 点击遮罩层也可以关闭
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeCard();
                    }
                });
            }
            
            // 更新成绩显示
            function updateScoreDisplay() {
                currentScoreDisplay.textContent = currentScore;
                currentCorrectDisplay.textContent = currentCorrect;
                currentWrongDisplay.textContent = currentWrong;
                
                // 更新当前称号
                if (currentStudent) {
                    currentTitleDisplay.textContent = currentStudent.title;
                    
                    // 获取学生的基础记录
                    const studentRecord = studentRecords[currentStudent.id] || {
                        totalScore: 0,
                        totalCorrect: 0,
                        totalWrong: 0
                    };
                    
                    // 如果正在测验中，显示累计成绩+当前测验成绩的实时总和
                    // 这样可以在答题过程中就看到实时更新的累计数据
                    if (isQuizActive && studentRecord.tempScore !== undefined) {
                        // 计算实时累计分数（历史累计 + 当前测验）
                        const realtimeScore = studentRecord.totalScore + studentRecord.tempScore;
                        const realtimeCorrect = studentRecord.totalCorrect + studentRecord.tempCorrect;
                        const realtimeWrong = studentRecord.totalWrong + studentRecord.tempWrong;
                        
                        // 显示实时累计成绩
                        totalScoreDisplay.textContent = realtimeScore;
                        totalCorrectDisplay.textContent = realtimeCorrect;
                        totalWrongDisplay.textContent = realtimeWrong;
                    } else {
                        // 否则显示历史累计成绩
                        totalScoreDisplay.textContent = studentRecord.totalScore;
                        totalCorrectDisplay.textContent = studentRecord.totalCorrect;
                        totalWrongDisplay.textContent = studentRecord.totalWrong;
                    }
                    
                    // 计算并显示基于实时总得分的称号
                    if (isQuizActive && studentRecord.tempScore !== undefined) {
                        // 如果在测验中，使用实时累计分数计算称号
                        const realtimeScore = studentRecord.totalScore + studentRecord.tempScore;
                        const realtimeTitle = getTitleByScore(realtimeScore);
                        highestTitleDisplay.textContent = realtimeTitle;
                    } else {
                        // 否则使用历史累计分数计算称号
                        const currentTitle = getTitleByScore(studentRecord.totalScore);
                        highestTitleDisplay.textContent = currentTitle;
                    }
                } else {
                    // 如果没有选择学生，显示占位符
                    currentTitleDisplay.textContent = '-';
                    totalScoreDisplay.textContent = '-';
                    totalCorrectDisplay.textContent = '-';
                    totalWrongDisplay.textContent = '-';
                    highestTitleDisplay.textContent = '-';
                }
            }
            
            // 根据分数获取称号
            function getTitleByScore(score) {
                // 添加调试日志
                console.log('获取称号，当前分数:', score);
                console.log('可用称号列表:', customTitles);
                
                // 排序称号，确保高分称号优先匹配
                const sortedTitles = [...customTitles].sort((a, b) => b.score - a.score);
                
                // 查找第一个分数要求小于等于当前分数的称号
                const matchedTitle = sortedTitles.find((item) => score >= item.score);
                
                const result = matchedTitle ? matchedTitle.name : '初学者';
                console.log('匹配到的称号:', result);
                return result;
            }
            
            // 添加自定义称号
            function addCustomTitle() {
                const score = parseInt(newTitleScore.value);
                const name = newTitleName.value.trim();
                
                if (isNaN(score) || !name) {
                    customAlert('请填写分数和称号名称', 'warning');
                    return;
                }
                
                // 检查是否已存在相同分数的称号
                const existingIndex = customTitles.findIndex(t => t.score === score);
                if (existingIndex !== -1) {
                    customTitles[existingIndex].name = name;
                } else {
                    customTitles.push({ score, name });
                    // 按分数排序
                    customTitles.sort((a, b) => a.score - b.score);
                }
                
                cacheCustomTitles();
                updateTitleList();
                
                newTitleScore.value = '';
                newTitleName.value = '';
                
                addDebugLog(`已添加/更新自定义称号: ${name} (分数: ${score})`);
            }
            
            // 更新称号列表
            function updateTitleList() {
                titleList.innerHTML = '';
                
                customTitles.forEach((title, index) => {
                    const titleItem = document.createElement('div');
                    titleItem.className = 'title-item';
                    
                    titleItem.innerHTML = `
                        <span>${title.score}</span>
                        <input type="text" value="${title.name}" data-index="${index}">
                        <span class="delete-title" data-index="${index}"><i class="fas fa-trash"></i></span>
                    `;
                    
                    titleList.appendChild(titleItem);
                });
                
                // 添加事件监听器
                const titleInputs = titleList.querySelectorAll('input');
                titleInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        const index = parseInt(this.dataset.index);
                        customTitles[index].name = this.value;
                        cacheCustomTitles();
                    });
                });
                
                const deleteButtons = titleList.querySelectorAll('.delete-title');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        if (customTitles.length > 1) {
                            customTitles.splice(index, 1);
                            cacheCustomTitles();
                            updateTitleList();
                        } else {
                            customAlert('至少需要保留一个称号', 'warning');
                        }
                    });
                });
            }
            
            // 缓存自定义称号到本地存储
            function cacheCustomTitles() {
                try {
                    localStorage.setItem('customTitles', JSON.stringify(customTitles));
                    addDebugLog(`已缓存 ${customTitles.length} 个自定义称号到本地存储`);
                } catch (error) {
                    addDebugLog(`缓存自定义称号失败: ${error.message}`);
                }
            }
            
            // 从本地存储加载自定义称号
            function loadCustomTitles() {
                try {
                    const cachedTitles = localStorage.getItem('customTitles');
                    if (cachedTitles) {
                        customTitles = JSON.parse(cachedTitles);
                        addDebugLog(`从本地存储加载了 ${customTitles.length} 个自定义称号`);
                    }
                } catch (error) {
                    addDebugLog(`加载自定义称号失败: ${error.message}`);
                }
            }
            
            // 缓存成绩数据到本地存储
            function cacheScoreData() {
                try {
                    const scoreData = {
                        studentRecords,
                        totalScore,
                        totalCorrect,
                        totalWrong
                    };
                    
                    localStorage.setItem('scoreData', JSON.stringify(scoreData));
                    addDebugLog('已缓存成绩数据和学生记录到本地存储');
                } catch (error) {
                    addDebugLog(`缓存成绩数据失败: ${error.message}`);
                }
            }
            
            // 从本地存储加载成绩数据
            function loadScoreData() {
                try {
                    const cachedScoreData = localStorage.getItem('scoreData');
                    if (cachedScoreData) {
                        const scoreData = JSON.parse(cachedScoreData);
                        
                        // 加载学生记录数据
                        if (scoreData.studentRecords) {
                            studentRecords = scoreData.studentRecords;
                            addDebugLog(`从本地存储加载了 ${Object.keys(studentRecords).length} 条学生记录`);
                        }
                        
                        // 保持兼容性，仍然加载全局成绩数据
                        totalScore = scoreData.totalScore || 0;
                        totalCorrect = scoreData.totalCorrect || 0;
                        totalWrong = scoreData.totalWrong || 0;
                    }
                } catch (error) {
                    addDebugLog(`加载成绩数据失败: ${error.message}`);
                }
            }
            
            // 切换自然拼读规则显示
            function togglePhonicsRule() {
                if (phonicsRule.style.display === 'none') {
                    phonicsRule.style.display = 'block';
                    toggleRuleBtn.textContent = '隐藏提示';
                } else {
                    phonicsRule.style.display = 'none';
                    toggleRuleBtn.textContent = '显示提示';
                }
            }
            
            // 保存听力测试显示选项
            function saveListeningOptions() {
                const options = {
                    showListeningPhonetic: showListeningPhoneticCheckbox.checked,
                    showPhonetic: showPhoneticCheckbox.checked,
                    showEnglish: showEnglishCheckbox.checked,
                    showChinese: showChineseCheckbox.checked,
                    showPhonicsPhonetic: showPhonicsPhoneticCheckbox ? showPhonicsPhoneticCheckbox.checked : true
                };
                
                localStorage.setItem('listeningOptions', JSON.stringify(options));
                addDebugLog('已保存听力测试显示选项');
            }
            
            // 加载听力测试显示选项
            function loadListeningOptions() {
                try {
                    const cachedOptions = localStorage.getItem('listeningOptions');
                    if (cachedOptions) {
                        const options = JSON.parse(cachedOptions);
                        showListeningPhoneticCheckbox.checked = options.showListeningPhonetic !== false; // 默认true
                        showPhoneticCheckbox.checked = options.showPhonetic !== false; // 默认true
                        showEnglishCheckbox.checked = options.showEnglish !== false; // 默认true
                        showChineseCheckbox.checked = options.showChinese !== false; // 默认true
                        // 设置自然拼读测试的音标显示选项
                        if (showPhonicsPhoneticCheckbox) {
                            showPhonicsPhoneticCheckbox.checked = options.showPhonicsPhonetic !== false; // 默认true
                        }
                        addDebugLog('从本地存储加载了听力测试显示选项');
                    }
                } catch (error) {
                    addDebugLog(`加载听力测试显示选项失败: ${error.message}`);
                }
            }
            
            // 初始化音频上传功能
            setupAudioUpload();
            
            // 初始调试信息
            addDebugLog('应用初始化完成');
            addDebugLog(`已加载 ${words.length} 个单词`);
            addDebugLog(`已加载 ${groups.length} 个分组`);
            addDebugLog(`已加载 ${students.length} 名学生`);
            addDebugLog(`已加载 ${customTitles.length} 个自定义称号`);
        });
    </script>
<script>
        // 优化标签按钮悬浮效果，确保只有六个标签按钮悬浮
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelector('.tabs');
            const qqContact = document.querySelector('.qq-contact');
            const container = document.querySelector('.container');
            
            // 确保只有标签按钮区域悬浮
            tabs.style.position = 'sticky';
            tabs.style.top = '0';
            tabs.style.zIndex = '9999';
            tabs.style.background = 'rgba(255, 255, 255, 0.98)';
            tabs.style.backdropFilter = 'blur(5px)';
            
            // 检查QQ联系标签是否遮挡页面内容
            function checkQQContactOverlap() {
                if (!qqContact || !container) return;
                
                const qqRect = qqContact.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                // 检查是否与容器内容重叠
                const isOverlapping = !(qqRect.bottom < containerRect.top || 
                                      qqRect.top > containerRect.bottom || 
                                      qqRect.right < containerRect.left || 
                                      qqRect.left > containerRect.right);
                
                // 如果重叠，添加半透明样式
                if (isOverlapping) {
                    qqContact.classList.add('semi-transparent');
                } else {
                    qqContact.classList.remove('semi-transparent');
                }
            }
            
            // 滚动事件处理 - 增强视觉效果并检查重叠
            window.addEventListener('scroll', function() {
                // 根据滚动位置调整标签页阴影效果
                if (window.scrollY > 50) {
                    tabs.style.boxShadow = '0 3px 15px rgba(0, 0, 0, 0.15)';
                } else {
                    tabs.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.08)';
                }
                
                // 检查QQ联系标签是否遮挡内容
                checkQQContactOverlap();
            });
            
            // 窗口大小改变时也检查重叠
            window.addEventListener('resize', checkQQContactOverlap);
            
            // 初始检查
            checkQQContactOverlap();
        });
    </script>
    </body>
</html>